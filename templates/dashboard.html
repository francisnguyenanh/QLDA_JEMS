<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>プロジェクト管理</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-size: 16px;
        }

        .container {
            max-width: 90%;
            padding: 15px;
            margin-left: auto;
            margin-right: auto;
        }

        .table-responsive {
            overflow-x: auto;
        }

        .table table-bordered {
            font-size: 0.9rem;
            width: 100%;
            min-width: 2000px;
        }

        th, td {
            white-space: nowrap;
            padding: 8px;
        }

        /* Kích thước cột cho bảng dashboard */
        .table.table-bordered th:nth-child(1),
        .table.table-bordered td:nth-child(1) { width: 180px; } /* 操作 */
        .table.table-bordered th:nth-child(2),
        .table.table-bordered td:nth-child(2) { width: 150px; } /* ステータス */
        .table.table-bordered th:nth-child(3),
        .table.table-bordered td:nth-child(3) { width: 180px; } /* タスク */
        .table.table-bordered th:nth-child(4),
        .table.table-bordered td:nth-child(4) { width: 400px; } /* 案件名 */
        .table.table-bordered th:nth-child(18),
        .table.table-bordered td:nth-child(18) { width: 140px; }
        .table.table-bordered th:nth-child(20),
        .table.table-bordered td:nth-child(20) { width: 180px; }
        .table.table-bordered th:nth-child(6),
        .table.table-bordered td:nth-child(6) { width: 150px; }
        .table.table-bordered th:nth-child(7),
        .table.table-bordered td:nth-child(7) { width: 150px; }
        .table.table-bordered th:nth-child(22),
        .table.table-bordered td:nth-child(22) { width: 140px; } /* ページ数 */
        .table.table-bordered th:nth-child(23),
        .table.table-bordered td:nth-child(23) { width: 100px; } /* 注文設計 */
        .table.table-bordered th:nth-child(24),
        .table.table-bordered td:nth-child(24) { width: 100px; } /* 注文テスト */
        .table.table-bordered th:nth-child(25),
        .table.table-bordered td:nth-child(25) { width: 100px; } /* 注文FB */
        .table.table-bordered th:nth-child(26),
        .table.table-bordered td:nth-child(26) { width: 100px; } /* 注文BrSE */
        .table.table-bordered th:nth-child(27),
        .table.table-bordered td:nth-child(27) { width: 250px; } /* 備考 */
        .table.table-bordered th:nth-child(28),
        .table.table-bordered td:nth-child(28) { width: 100px; } /* 設計実績 */
        .table.table-bordered th:nth-child(29),
        .table.table-bordered td:nth-child(29) { width: 100px; } /* テスト実績 */
        .table.table-bordered th:nth-child(30),
        .table.table-bordered td:nth-child(30) { width: 100px; } /* FB実績 */
        .table.table-bordered th:nth-child(31),
        .table.table-bordered td:nth-child(31) { width: 100px; } /* BrSE実績 */

        .table.table-bordered th:nth-child(1),
        .table.table-bordered td:nth-child(1) {
            position: sticky;
            left: 0;
            background: #e6f3ff;
            z-index: 1;
        }

        .table.table-bordered th:nth-child(2),
        .table.table-bordered td:nth-child(2) {
            position: sticky;
            left: 115px;
            background: #e6f3ff;
            z-index: 1;
        }

        .table.table-bordered th:nth-child(3),
        .table.table-bordered td:nth-child(3) {
            position: sticky;
            left: 214px;
            background: #e6f3ff;
            z-index: 1;
        }

        .table.table-bordered thead th:nth-child(1),
        .table.table-bordered thead th:nth-child(2),
        .table.table-bordered thead th:nth-child(3) {
            z-index: 3;
        }

        /* Cố định header khi cuộn dọc cho bảng dashboard */
        .table.table-bordered thead {
            position: sticky;
            top: 0;
            z-index: 2;
            background: white;
        }

        .table.table-bordered .past-date { background-color: #f0f0f0 !important; }
        .table.table-bordered .highlight-date { background-color: yellow !important; color: red !important; }
        .table.table-bordered .fb-late { background-color: red !important; color: white !important; }

        .modal-body .row {
            margin-left: -5px;
            margin-right: -5px;
        }

        .modal-body .col-12 {
            padding: 5px;
        }

        .task-checkboxes, .order-checkboxes {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }

        .task-checkboxes .form-check, .order-checkboxes .form-check {
            display: flex;
            align-items: center;
            margin: 0;
            min-width: 100px;
        }

        .task-checkboxes .form-check-label, .order-checkboxes .form-check-label {
            margin-left: 8px;
            font-size: 0.85rem;
        }

        .form-label {
            font-size: 0.85rem;
        }

        .form-control, .form-check-input, .form-select {
            font-size: 0.85rem;
            padding: 6px;
        }

        textarea.form-control {
            resize: vertical;
            min-height: 50px;
        }

        .mail-modal-custom {
            max-width: 95%;
        }

        .mail-modal .modal-body {
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-height: 300px;
            padding: 10px;
        }

        .mail-buttons-container {
            flex: none;
            max-width: 100%;
            padding-right: 0;
        }

        .mail-buttons .btn {
            margin-bottom: 8px;
            font-size: 0.85rem;
            padding: 8px;
            text-align: left;
        }

        .mail-buttons .btn.copied {
            background-color: #28a745;
            color: white;
            border-color: #28a745;
            text-align: left;
        }

        .mail-content-container {
            flex: none;
            max-width: 100%;
        }

        #mailContent {
            width: 100%;
            height: 300px;
            max-height: 500px;
            font-size: 0.85rem;
            resize: vertical;
        }

        .btn-group-responsive {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .btn-group-responsive .btn {
            flex: 1;
            min-width: 130px;
            font-size: 0.85rem;
            padding: 8px;
            white-space: nowrap;
            text-align: center;
        }

        .show-unnecessary-label {
            color: #0056b3;
            font-weight: bold;
            margin-right: 30px;
            font-size: 0.9rem;
        }

        .sortable {
            cursor: pointer;
            position: relative;
            user-select: none;
        }

        .sortable:hover {
            background-color: #e9ecef;
        }

        .sort-indicator::after {
            content: '';
            display: inline-block;
            width: 0;
            height: 0;
            margin-left: 4px;
            vertical-align: middle;
            border-left: 3px solid transparent;
            border-right: 3px solid transparent;
        }

        .sort-asc .sort-indicator::after {
            border-bottom: 3px solid #000;
        }

        .sort-desc .sort-indicator::after {
            border-top: 3px solid #000;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .modal-header .d-flex {
            flex-shrink: 0;
        }

        .modal-header .btn {
            font-size: 0.85rem;
            padding: 6px 12px;
        }

        .modal-header .form-check {
            margin: 0 10px;
            display: flex;
            align-items: center;
        }

        .modal-header .form-check-label {
            font-size: 0.85rem;
            margin-left: 5px;
        }

        .modal-dialog-scrollable .modal-content {
            max-height: 90vh;
        }

        .modal-dialog-scrollable .modal-body {
            max-height: calc(90vh - 120px);
            overflow-y: auto;
            padding: 10px;
        }

        .daily-report-table-container {
            max-height: 60vh;
            overflow-y: auto;
            position: relative;
        }

        .daily-report-table {
            width: 100%;
            border-collapse: collapse;
        }

        .daily-report-table thead {
            position: sticky;
            top: 0;
            z-index: 2;
            background: white;
        }

        .daily-report-table th, .daily-report-table td {
            border: 1px solid #dee2e6;
            padding: 6px;
            text-align: center;
            font-size: 0.85rem;
        }

        .daily-report-table input {
            width: 60px;
            padding: 2px;
            font-size: 0.85rem;
            text-align: center;
        }

        .daily-report-table th.project-header {
            width: 200px;
            position: sticky;
            left: 0;
            background: #f1f3f5;
            z-index: 3;
        }

        .daily-report-table td.project-cell {
            position: sticky;
            left: 0;
            background: white;
            z-index: 1;
        }

        /* Tô màu xen kẽ các ngày trong header */
        .daily-report-table thead tr:first-child th:not(.project-header):nth-child(4n-2),
        .daily-report-table thead tr:first-child th:not(.project-header):nth-child(8n-6),
        .daily-report-table thead tr:first-child th:not(.project-header):nth-child(8n-4),
        .daily-report-table thead tr:first-child th:not(.project-header):nth-child(4n),
        .daily-report-table thead tr:first-child th:not(.project-header):nth-child(4n+1) {
            background-color: #e6f3ff;
        }

        .daily-report-table thead tr:first-child th:not(.project-header):nth-child(4n-1),
        .daily-report-table thead tr:first-child th:not(.project-header):nth-child(8n-5),
        .daily-report-table thead tr:first-child th:not(.project-header):nth-child(8n-3) {
            background-color: #ffe6e6;
        }

        /* Tô màu xen kẽ các cột ngày trong body */
        .daily-report-table tbody td:not(.project-cell):nth-child(4n-2),
        .daily-report-table tbody td:not(.project-cell):nth-child(8n-6),
        .daily-report-table tbody td:not(.project-cell):nth-child(8n-4),
        .daily-report-table tbody td:not(.project-cell):nth-child(4n),
        .daily-report-table tbody td:not(.project-cell):nth-child(4n+1) {
            background-color: #e6f3ff;
        }

        .daily-report-table tbody td:not(.project-cell):nth-child(4n-1),
        .daily-report-table tbody td:not(.project-cell):nth-child(8n-5),
        .daily-report-table tbody td:not(.project-cell):nth-child(8n-3) {
            background-color: #ffe6e6;
        }

        /* Tô màu xen kẽ các hàng dự án */
        .daily-report-table tbody tr:nth-child(even) td:not(.project-cell) {
            background-color: #f1f3f5;
        }

        .daily-report-table tbody tr:nth-child(odd) td:not(.project-cell) {
            background-color: white;
        }

        /* Đảm bảo cột project-cell không bị ảnh hưởng bởi màu xen kẽ của hàng */
        .daily-report-table tbody tr:nth-child(even) td.project-cell,
        .daily-report-table tbody tr:nth-child(odd) td.project-cell {
            background-color: white;
        }

        .week-nav-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 10px;
        }

        @media (max-width: 576px) {
            .modal-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .modal-header .d-flex {
                width: 100%;
                justify-content: flex-end;
            }

            .modal-header .btn {
                width: auto;
                margin-left: 5px;
            }

            .modal-body .row {
                margin-left: -5px;
                margin-right: -5px;
            }

            .modal-body .col-12 {
                padding: 5px;
            }

            .modal-dialog-scrollable .modal-body {
                max-height: calc(90vh - 150px);
            }

            .modal-dialog {
                margin: 10px;
            }

            .task-checkboxes, .order-checkboxes {
                gap: 10px;
            }

            .task-checkboxes .form-check, .order-checkboxes .form-check {
                min-width: 80px;
            }

            .daily-report-table input {
                width: 50px;
            }
        }

        @media (min-width: 768px) {
            .container {
                max-width: 90%;
            }

            .table.table-bordered {
                font-size: 0.9rem;
            }

            .table.table-bordered th,
            .table.table-bordered td {
                padding: 10px;
            }

            .modal-body .row {
                margin-left: -10px;
                margin-right: -10px;
            }

            .modal-body .col-md-3 {
                padding: 10px;
            }

            .mail-modal .modal-body {
                flex-direction: row;
                gap: 15px;
                padding: 15px;
            }

            .mail-buttons-container {
                flex: 1;
                max-width: 33.33%;
                padding-right: 15px;
            }

            .mail-content-container {
                flex: 2;
                max-width: 66.67%;
            }

            #mailContent {
                height: 600px;
                max-height: 800px;
            }

            .btn-group-responsive .btn {
                min-width: auto;
            }

            textarea[name="備考"] {
                max-height: 200px;
                overflow-y: auto;
                resize: vertical;
            }

            .modal-body {
                max-height: 60vh;
                overflow-y: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container mt-3">
        <div class="d-flex justify-content-between align-items-center mb-3 flex-column flex-md-row">
            <div class="mb-2 mb-md-0">
                <h2 class="h4">とも管理</h2>
                <form id="showUnnecessaryForm" method="POST">
                    <div class="form-check d-flex align-items-center">
                        <label class="show-unnecessary-label" for="showUnnecessary">不要も表示</label>
                        <input type="checkbox" class="form-check-input" id="showUnnecessary" name="show_unnecessary"
                               {% if show_unnecessary %}checked{% endif %}
                               onchange="document.getElementById('showUnnecessaryForm').submit()">
                    </div>
                </form>
            </div>
            <div class="btn-group-responsive">
                <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#uploadModal">Excel</button>
                <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#dailyReportModal" onclick="openDailyReportModal()">日報</button>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadMailTemplateModal">メール</button>
                <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteAllModal">全削除</button>
                <a href="{{ url_for('logout') }}" class="btn btn-danger">Logout</a>
            </div>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <div class="table-responsive">
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>操作</th>
                        {% for col in display_columns %}
                            <th class="sortable" data-column="{{ col }}">
                                {{ col }}
                                <span class="sort-indicator"></span>
                            </th>
                        {% endfor %}
                        <th class="sortable" data-column="設計実績">設計実績<span class="sort-indicator"></span></th>
                        <th class="sortable" data-column="テスト実績">テスト実績<span class="sort-indicator"></span></th>
                        <th class="sortable" data-column="FB実績">FB実績<span class="sort-indicator"></span></th>
                        <th class="sortable" data-column="BrSE実績">BrSE実績<span class="sort-indicator"></span></th>
                    </tr>
                </thead>
                <tbody id="projectTableBody">
                    {% for project in projects %}
                        <tr>
                            <td>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-primary btn-sm"
                                            data-bs-toggle="modal"
                                            data-bs-target="#editModal"
                                            onclick='fillEditModal({{ project.id }}, {{ project | tojson | safe }})'>
                                        編集
                                    </button>
                                    <button class="btn btn-info btn-sm"
                                            data-bs-toggle="modal"
                                            data-bs-target="#mailModal"
                                            onclick='openMailModal({{ project.id }})'>
                                        メール
                                    </button>
                                </div>
                            </td>
                            {% for col in display_columns %}
                                {% set classes = [] %}
                                {% if project.highlight_column == col %}
                                    {% set _ = classes.append('highlight-date') %}
                                {% endif %}
                                {% if project[col + '_past'] %}
                                    {% set _ = classes.append('past-date') %}
                                {% endif %}
                                {% if col == 'FB完了予定日' and project.fb_late %}
                                    {% set _ = classes.append('fb-late') %}
                                {% endif %}
                                <td class="{{ ' '.join(classes) }}" data-fb-late="{{ project.fb_late }}">
                                    {{ project[col] }}
                                </td>
                            {% endfor %}
                            <td>{{ project['設計実績'] }}</td>
                            <td>{{ project['テスト実績'] }}</td>
                            <td>{{ project['FB実績'] }}</td>
                            <td>{{ project['BrSE実績'] }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Upload Modal -->
    <div class="modal fade" id="uploadModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Excelファイルアップロード</h5>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
                        <button type="submit" form="uploadForm" class="btn btn-primary">アップロード</button>
                    </div>
                </div>
                <div class="modal-body">
                    <form id="uploadForm" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="excelFile" class="form-label">Excelファイルを選択 (.xlsx, .xls)</label>
                            <input type="file" class="form-control" id="excelFile" name="file" accept=".xlsx,.xls" required>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Mail Template Upload Modal -->
    <div class="modal fade" id="uploadMailTemplateModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">メールアップロード</h5>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
                        <button type="submit" form="uploadMailTemplateForm" class="btn btn-primary">アップロード</button>
                    </div>
                </div>
                <div class="modal-body">
                    <p>Thay các cụm sau vào trong template mail: {案件名}, {se名}, {pj}, {開発完了}, {SE納品}</p>
                    <form id="uploadMailTemplateForm" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="mailTemplateFile" class="form-label">テキストファイルを選択 (.txt)</label>
                            <input type="file" class="form-control" id="mailTemplateFile" name="file" accept=".txt" required>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-scrollable modal-xl">
            <div class="modal-content">
                <form method="POST" id="editForm">
                    <div class="modal-header">
                        <h5 class="modal-title">プロジェクト編集</h5>
                        <div class="d-flex gap-2 align-items-center">
                            <div class="form-check">
                                <input type="checkbox" name="不要" id="edit_不要" class="form-check-input">
                                <label class="form-check-label" for="edit_不要">不要</label>
                            </div>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
                            <button type="submit" class="btn btn-primary">保存</button>
                        </div>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" name="index" id="editIndex">
                        <div class="row">
                            <!-- Column 1 -->
                            <div class="col-12 col-md-3">
                                <div class="mb-3">
                                    <label class="form-label">タスク</label>
                                    <div class="task-checkboxes d-flex flex-wrap">
                                        <div class="form-check">
                                            <input type="checkbox" name="タスク" id="task_設計" value="設計" class="form-check-input">
                                            <label class="form-check-label" for="task_設計">設計</label>
                                        </div>
                                        <div class="form-check">
                                            <input type="checkbox" name="タスク" id="task_Brse" value="Brse" class="form-check-input">
                                            <label class="form-check-label" for="task_Brse">Brse</label>
                                        </div>
                                        <div class="form-check">
                                            <input type="checkbox" name="タスク" id="task_テスト" value="テスト" class="form-check-input">
                                            <label class="form-check-label" for="task_テスト">テスト</label>
                                        </div>
                                        <div class="form-check">
                                            <input type="checkbox" name="タスク" id="task_FB" value="FB" class="form-check-input">
                                            <label class="form-check-label" for="task_FB">FB</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">案件名</label>
                                    <input type="text" name="案件名" id="edit_案件名" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">案件番号</label>
                                    <input type="text" name="案件番号" id="edit_案件番号" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">PJNo.</label>
                                    <input type="text" name="PJNo." id="edit_PJNo." class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">PH</label>
                                    <input type="text" name="PH" id="edit_PH" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">SE</label>
                                    <input type="text" name="SE" id="edit_SE" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">BSE</label>
                                    <input type="text" name="BSE" id="edit_BSE" class="form-control">
                                </div>
                            </div>
                            <!-- Column 2 -->
                            <div class="col-12 col-md-3">
                                <label class="form-label">ステータス</label>
                                    <select name="ステータス" id="edit_ステータス" class="form-select">
                                        {% for status in valid_statuses %}
                                            <option value="{{ status }}">{{ status }}</option>
                                        {% endfor %}
                                    </select>
                                <div class="mb-3">
                                    <label class="form-label">開発工数（h）</label>
                                    <input type="number" name="開発工数（h）" id="edit_開発工数（h）" class="form-control" step="0.1" min="0">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">設計工数（h）</label>
                                    <input type="number" name="設計工数（h）" id="edit_設計工数（h）" class="form-control" step="0.1" min="0">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">ページ数</label>
                                    <input type="number" name="ページ数" id="edit_ページ数" class="form-control" min="1">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">注文項目</label>
                                    <div class="order-checkboxes d-flex flex-wrap">
                                        <div class="form-check">
                                            <input type="checkbox" name="注文設計" id="edit_注文設計" class="form-check-input">
                                            <label class="form-check-label" for="edit_注文設計">注文設計</label>
                                        </div>
                                        <div class="form-check">
                                            <input type="checkbox" name="注文テスト" id="edit_注文テスト" class="form-check-input">
                                            <label class="form-check-label" for="edit_注文テスト">注文テスト</label>
                                        </div>
                                        <div class="form-check">
                                            <input type="checkbox" name="注文FB" id="edit_注文FB" class="form-check-input">
                                            <label class="form-check-label" for="edit_注文FB">注文FB</label>
                                        </div>
                                        <div class="form-check">
                                            <input type="checkbox" name="注文BrSE" id="edit_注文BrSE" class="form-check-input">
                                            <label class="form-check-label" for="edit_注文BrSE">注文BrSE</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Column 3 -->
                            <div class="col-12 col-md-3">
                                <div class="mb-3">
                                    <label class="form-label">要件引継</label>
                                    <input type="date" name="要件引継" id="edit_要件引継" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">設計開始</label>
                                    <input type="date" name="設計開始" id="edit_設計開始" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">設計完了</label>
                                    <input type="date" name="設計完了" id="edit_設計完了" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">設計書送付</label>
                                    <input type="date" name="設計書送付" id="edit_設計書送付" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">開発開始</label>
                                    <input type="date" name="開発開始" id="edit_開発開始" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">開発完了</label>
                                    <input type="date" name="開発完了" id="edit_開発完了" class="form-control">
                                </div>
                            </div>
                            <!-- Column 4 -->
                            <div class="col-12 col-md-3">
                                <div class="mb-3">
                                    <label class="form-label">テスト開始日</label>
                                    <input type="date" name="テスト開始日" id="edit_テスト開始日" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">テスト完了日</label>
                                    <input type="date" name="テスト完了日" id="edit_テスト完了日" class="form-control" readonly>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">FB完了予定日</label>
                                    <input type="date" name="FB完了予定日" id="edit_FB完了予定日" class="form-control" readonly>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">SE納品</label>
                                    <input type="date" name="SE納品" id="edit_SE納品" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">備考</label>
                                    <textarea name="備考" id="edit_備考" class="form-control"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Mail Modal -->
    <div class="modal fade mail-modal" id="mailModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-scrollable mail-modal-custom">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">メールテンプレート</h5>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
                        <button type="button" class="btn btn-primary" onclick="copyMailContent()">コピー</button>
                    </div>
                </div>
                <div class="modal-body">
                    <div class="mail-buttons-container">
                        <div class="mail-buttons d-flex flex-column">
                            {% for full_name, display_name in mail_templates %}
                                <button class="btn btn-outline-primary mb-2"
                                        onclick="loadMailContent(currentProjectId, '{{ full_name }}', this)"
                                        data-filename="{{ full_name }}">
                                    {{ display_name }}
                                </button>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="mail-content-container">
                        <textarea id="mailContent" class="form-control" placeholder="テンプレートを選択してください"></textarea>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Daily Report Modal -->
    <div class="modal fade" id="dailyReportModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-scrollable modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">日報</h5>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
                        <button type="button" class="btn btn-primary" onclick="saveDailyReport()">登録</button>
                    </div>
                </div>
                <div class="modal-body">
                    <div class="week-nav-buttons">
                        <button class="btn btn-outline-primary" onclick="navigateWeek('prev')">前週</button>
                        <button class="btn btn-outline-primary" onclick="navigateWeek('current')">今週</button>
                        <button class="btn btn-outline-primary" onclick="navigateWeek('next')">次週</button>
                    </div>
                    <div class="daily-report-table-container">
                        <table class="daily-report-table">
                            <thead id="dailyReportTableHead"></thead>
                            <tbody id="dailyReportTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete All Data Modal -->
    <div class="modal fade" id="deleteAllModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">全てのデータを削除</h5>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                        <button type="button" class="btn btn-danger" onclick="deleteAllData()">削除</button>
                    </div>
                </div>
                <div class="modal-body">
                    <p>Chức năng xoá tất cả dự án trong DB, nếu đã suy nghĩ kỹ thì nhập password login để xoá。</p>
                    <form id="deleteAllForm">
                        <div class="mb-3">
                            <label for="confirmPassword" class="form-label">パスワード</label>
                            <input type="password" class="form-control" id="confirmPassword" name="password" required>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        console.log('JavaScript loaded');

        let currentProjectId = null;
        let sortColumn = null;
        let sortDirection = 'asc';
        let currentWeekStart = null;

        // Sorting functionality
        document.querySelectorAll('.sortable').forEach(header => {
            header.addEventListener('click', function() {
                const column = this.getAttribute('data-column');
                if (sortColumn === column) {
                    sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    sortDirection = 'asc';
                }
                sortColumn = column;
                document.querySelectorAll('.sortable').forEach(h => {
                    h.classList.remove('sort-asc', 'sort-desc');
                });
                this.classList.add(`sort-${sortDirection}`);
                fetchSortedData(column, sortDirection);
            });
        });

        function fetchSortedData(column, direction) {
            const showUnnecessary = document.getElementById('showUnnecessary').checked;
            fetch('/sort_projects', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    column: column,
                    direction: direction,
                    show_unnecessary: showUnnecessary
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    console.error('Error sorting data:', data.error);
                    alert('エラー: ソートに失敗しました - ' + data.error);
                    return;
                }
                updateTable(data.projects);
            })
            .catch(error => {
                console.error('Error fetching sorted data:', error);
                alert('エラー: ソートに失敗しました - ' + error.message);
            });
        }

        function updateTable(projects) {
            const tbody = document.getElementById('projectTableBody');
            tbody.innerHTML = '';

            projects.forEach(project => {
                const row = document.createElement('tr');
                const opCell = document.createElement('td');
                opCell.innerHTML = `
                    <div class="d-flex gap-2">
                        <button class="btn btn-primary btn-sm"
                                data-bs-toggle="modal"
                                data-bs-target="#editModal"
                                onclick='fillEditModal(${project.id}, ${JSON.stringify(project)})'>
                            編集
                        </button>
                        <button class="btn btn-info btn-sm"
                                data-bs-toggle="modal"
                                data-bs-target="#mailModal"
                                onclick='openMailModal(${project.id})'>
                            メール
                        </button>
                    </div>
                `;
                row.appendChild(opCell);

                const displayColumns = {{ display_columns | tojson | safe }};
                displayColumns.forEach(col => {
                    const cell = document.createElement('td');
                    let classes = [];
                    if (project.highlight_column === col) {
                        classes.push('highlight-date');
                    }
                    if (project[col + '_past']) {
                        classes.push('past-date');
                    }
                    if (col === 'FB完了予定日' && project.fb_late) {
                        classes.push('fb-late');
                    }
                    cell.className = classes.join(' ');
                    cell.setAttribute('data-fb-late', project.fb_late);
                    cell.textContent = project[col] || '';
                    row.appendChild(cell);
                });

                ['設計実績', 'テスト実績', 'FB実績', 'BrSE実績'].forEach(col => {
                    const cell = document.createElement('td');
                    cell.textContent = project[col] || '0';
                    row.appendChild(cell);
                });

                tbody.appendChild(row);
            });
        }

        function updateTestDates() {
            const pageCountInput = document.getElementById('edit_ページ数');
            const testStartInput = document.getElementById('edit_テスト開始日');
            const devCompleteInput = document.getElementById('edit_開発完了');
            const testCompletionInput = document.getElementById('edit_テスト完了日');
            const fbCompletionInput = document.getElementById('edit_FB完了予定日');

            const pageCount = parseInt(pageCountInput.value);
            let testStartDate = null;

            if (testStartInput.value) {
                testStartDate = new Date(testStartInput.value);
            } else if (devCompleteInput.value) {
                testStartDate = new Date(devCompleteInput.value);
                testStartDate.setDate(testStartDate.getDate() + 1);
            }

            if (pageCount > 0 && testStartDate && !isNaN(testStartDate)) {
                const testStartDateYMD = testStartDate.toISOString().split('T')[0];
                fetch('/calculate_test_dates', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ page_count: pageCount, test_start_date: testStartDateYMD })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.error) {
                        console.error('Error calculating dates:', data.error);
                        testCompletionInput.value = '';
                        fbCompletionInput.value = '';
                    } else {
                        testCompletionInput.value = data.test_completion_date || '';
                        fbCompletionInput.value = data.fb_completion_date || '';
                    }
                })
                .catch(error => {
                    console.error('Fetch error:', error);
                    testCompletionInput.value = '';
                    fbCompletionInput.value = '';
                });
            } else {
                testCompletionInput.value = '';
                fbCompletionInput.value = '';
            }
        }

        function parseDateToYMD(dateStr) {
            if (!dateStr || dateStr === '') {
                return '';
            }
            try {
                if (dateStr.includes('(')) {
                    const cleanedDate = dateStr.split('(')[0].replace(/\//g, '-');
                    return cleanedDate;
                }
                if (dateStr.match(/^\d{4}-\d{2}-\d{2}$/)) {
                    return dateStr;
                }
                if (dateStr.match(/^\d{4}\/\d{2}\/\d{2}$/)) {
                    return dateStr.replace(/\//g, '-');
                }
                return '';
            } catch (e) {
                console.error('Error parsing date:', dateStr, e);
                return '';
            }
        }

        function fillEditModal(projectId, project) {
            document.getElementById('editIndex').value = projectId;

            const fields = [
                '案件名', '案件番号', 'PJNo.', 'PH', 'SE', 'BSE', '開発工数（h）', '設計工数（h）', 'ページ数',
                '備考'
            ];
            const dateFields = [
                '要件引継', '設計開始', '設計完了', '設計書送付', '開発開始', '開発完了',
                'テスト開始日', 'テスト完了日', 'FB完了予定日', 'SE納品'
            ];

            fields.forEach(field => {
                const element = document.getElementById(`edit_${field}`);
                if (element) {
                    element.value = project[field] || '';
                }
            });

            dateFields.forEach(field => {
                const element = document.getElementById(`edit_${field}`);
                if (element) {
                    const dateValue = parseDateToYMD(project[field]);
                    element.value = dateValue;
                }
            });

            const taskCheckboxes = ['設計', 'Brse', 'テスト', 'FB'];
            taskCheckboxes.forEach(task => {
                const checkbox = document.getElementById(`task_${task}`);
                if (checkbox) {
                    checkbox.checked = project['タスク'] ? project['タスク'].split(',').includes(task) : false;
                }
            });

            const unnecessaryCheckbox = document.getElementById('edit_不要');
            if (unnecessaryCheckbox) {
                unnecessaryCheckbox.checked = project['不要'] === 1 || project['不要'] === '1';
            }

            const orderCheckboxes = ['注文設計', '注文テスト', '注文FB', '注文BrSE'];
            orderCheckboxes.forEach(order => {
                const checkbox = document.getElementById(`edit_${order}`);
                if (checkbox) {
                    checkbox.checked = project[order] === 1 || project[order] === '1' || project[order] === '○';
                }
            });

            const statusSelect = document.getElementById('edit_ステータス');
            if (statusSelect) {
                statusSelect.value = project['ステータス'] || '要件引継待ち';
            }

            updateTestDates();
        }

        function openMailModal(projectId) {
            currentProjectId = projectId;
            document.getElementById('mailContent').value = '';
            fetch(`/get_copied_templates/${projectId}`)
                .then(response => response.json())
                .then(data => {
                    document.querySelectorAll('.mail-buttons .btn').forEach(btn => {
                        const filename = btn.getAttribute('data-filename');
                        if (data.templates.includes(filename)) {
                            btn.classList.add('copied');
                        } else {
                            btn.classList.remove('copied');
                        }
                    });
                })
                .catch(error => console.error('Error fetching copied templates:', error));
        }

        function loadMailContent(projectId, filename, button) {
            document.querySelectorAll('.mail-buttons .btn').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');

            fetch(`/get_mail_content/${projectId}/${filename}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert('エラー: ' + data.error);
                    } else {
                        document.getElementById('mailContent').value = data.content;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('エラー: メールコンテンツの取得に失敗しました');
                });
        }

        function copyMailContent() {
            const mailContent = document.getElementById('mailContent').value;
            if (mailContent) {
                navigator.clipboard.writeText(mailContent)
                    .then(() => {
                        const activeButton = document.querySelector('.mail-buttons .btn.active');
                        if (activeButton) {
                            const filename = activeButton.getAttribute('data-filename');
                            fetch('/save_copied_template', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ project_id: currentProjectId, filename: filename })
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    activeButton.classList.add('copied');
                                    console.log('Copied template saved:', filename);
                                } else {
                                    console.error('Failed to save copied template:', data.error);
                                }
                            })
                            .catch(error => {
                                console.error('Error saving copied template:', error);
                            });
                        }
                    })
                    .catch(err => {
                        console.error('Failed to copy:', err);
                        alert('コピーに失敗しました');
                    });
            } else {
                alert('コピーするコンテンツがありません');
            }
        }

        function deleteAllData() {
            const password = document.getElementById('confirmPassword').value;
            if (!password) {
                alert('パスワードを入力してください');
                return;
            }

            fetch('/delete_all_data', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password: password })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('すべてのデータが正常に削除されました');
                    window.location.reload();
                } else {
                    alert('エラー: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('エラー: データの削除に失敗しました');
            });
        }

        // Daily Report Functions
        function openDailyReportModal() {
            currentWeekStart = getMonday(new Date());
            loadDailyReportData();
        }

        function getMonday(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }

        function formatDateYMD(date) {
            return date.toISOString().split('T')[0];
        }

        function navigateWeek(direction) {
            const d = new Date(currentWeekStart);
            if (direction === 'prev') {
                d.setDate(d.getDate() - 7);
            } else if (direction === 'next') {
                d.setDate(d.getDate() + 7);
            } else {
                d.setTime(new Date().getTime());
            }
            currentWeekStart = getMonday(d);
            loadDailyReportData();
        }

        function loadDailyReportData() {
            const weekStartStr = formatDateYMD(currentWeekStart);
            fetch(`/get_daily_report_data?week_start=${weekStartStr}`, {
                method: 'GET',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Error loading daily report data:', data.error);
                    alert('エラー: 日報データの取得に失敗しました - ' + data.error);
                    return;
                }
                renderDailyReportTable(data.projects, data.week_dates, data.hours);
            })
            .catch(error => {
                console.error('Error fetching daily report data:', error);
                alert('エラー: 日報データの取得に失敗しました - ' + error.message);
            });
        }

        function renderDailyReportTable(projects, weekDates, hours) {
            const thead = document.getElementById('dailyReportTableHead');
            const tbody = document.getElementById('dailyReportTableBody');
            thead.innerHTML = '';
            tbody.innerHTML = '';

            // Header row
            const headerRow = document.createElement('tr');
            const projectHeader = document.createElement('th');
            projectHeader.className = 'project-header';
            projectHeader.textContent = '案件名';
            headerRow.appendChild(projectHeader);

            const taskTypes = ['設計', 'テスト', 'FB', 'BrSE'];
            weekDates.forEach(date => {
                const dateTh = document.createElement('th');
                dateTh.colSpan = taskTypes.length;
                dateTh.textContent = date.display;
                headerRow.appendChild(dateTh);
            });
            thead.appendChild(headerRow);

            // Sub-header row
            const subHeaderRow = document.createElement('tr');
            subHeaderRow.appendChild(document.createElement('th')); // Empty cell for project column
            weekDates.forEach(() => {
                taskTypes.forEach(task => {
                    const th = document.createElement('th');
                    th.textContent = task;
                    subHeaderRow.appendChild(th);
                });
            });
            thead.appendChild(subHeaderRow);

            // Data rows
            projects.forEach(project => {
                const row = document.createElement('tr');
                const projectCell = document.createElement('td');
                projectCell.className = 'project-cell';
                projectCell.textContent = project['案件名'];
                row.appendChild(projectCell);

                weekDates.forEach(date => {
                    taskTypes.forEach(task => {
                        const td = document.createElement('td');
                        const input = document.createElement('input');
                        input.type = 'number';
                        input.step = '0.1';
                        input.min = '0';
                        input.className = 'form-control';
                        input.dataset.projectId = project.id;
                        input.dataset.date = date.date;
                        input.dataset.task = task;
                        const hourData = hours.find(h =>
                            h.project_id === project.id &&
                            h.date === date.date &&
                            h.task_type === task
                        );
                        input.value = hourData ? hourData.hours : '';
                        td.appendChild(input);
                        row.appendChild(td);
                    });
                });

                tbody.appendChild(row);
            });
        }

        function saveDailyReport() {
            const inputs = document.querySelectorAll('.daily-report-table input');
            const hoursData = [];
            inputs.forEach(input => {
                const hours = parseFloat(input.value);
                if (!isNaN(hours) && hours > 0) {
                    hoursData.push({
                        project_id: parseInt(input.dataset.projectId),
                        date: input.dataset.date,
                        task_type: input.dataset.task,
                        hours: hours
                    });
                }
            });

            fetch('/save_daily_hours', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ hours: hoursData })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('日報が正常に登録されました');
                    document.getElementById('dailyReportModal').querySelector('.btn-secondary').click();
                    window.location.reload(); // Refresh to update dashboard
                } else {
                    alert('エラー: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error saving daily hours:', error);
                alert('エラー: 日報の登録に失敗しました');
            });
        }

        document.getElementById('uploadForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.ok) {
                    window.location.reload();
                } else {
                    return response.json().then(data => {
                        throw new Error(data.error || 'アップロードに失敗しました');
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('エラー: ' + error.message);
            });
        });

        document.getElementById('uploadMailTemplateForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            fetch('/upload_mail_template', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('エラー: ' + data.error);
                } else {
                    alert('メールテンプレートが正常にアップロードされました');
                    window.location.reload();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('エラー: アップロードに失敗しました');
            });
        });

        const pageCountInput = document.getElementById('edit_ページ数');
        pageCountInput.addEventListener('input', () => {
            console.log('Page count input event');
            updateTestDates();
        });
        pageCountInput.addEventListener('change', () => {
            console.log('Page count change event');
            updateTestDates();
        });
        pageCountInput.addEventListener('blur', () => {
            console.log('Page count blur event');
            updateTestDates();
        });

        document.getElementById('edit_開発完了').addEventListener('change', () => {
            console.log('Dev complete change event');
            updateTestDates();
        });
        document.getElementById('edit_テスト開始日').addEventListener('change', () => {
            console.log('Test start change event');
            updateTestDates();
        });
    </script>
</body>
</html>