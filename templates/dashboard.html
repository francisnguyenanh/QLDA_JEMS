{% extends "layout.html" %}

{% block title %}プロジェクト管理 - Dashboard{% endblock %}

{% block extra_styles %}
/* Dashboard-specific styles - OPTIMIZED TABLE HEIGHT */
html, body {
    height: 100vh;
    overflow: hidden !important; /* Ẩn scroll của page */
    margin: 0;
    padding: 0;
}

body {
    font-size: 16px;
    display: flex;
    flex-direction: column;
}

/* Container optimization */
.container {
    max-width: 95%;
    padding: 5px 10px; /* Giảm padding */
    margin-left: auto;
    margin-right: auto;
    flex: 0 0 auto;
}

/* Header controls - very compact */
.container-fluid.mb-3 {
    background-color: #f8f9fa;
    padding: 5px 10px; /* Giảm padding mạnh */
    border-bottom: 1px solid #dee2e6;
    flex: 0 0 auto;
    margin-bottom: 0 !important;
    min-height: 50px; /* Set minimum height */
}

/* Navbar very compact */
.navbar {
    padding: 0.2rem 0.8rem !important; /* Giảm padding mạnh */
    min-height: 45px; /* Giảm height */
    flex: 0 0 auto;
}

/* Professional Navbar Buttons - very compact */
.btn-group-professional {
    display: flex;
    flex-wrap: nowrap;
    gap: 4px; /* Giảm gap */
    align-items: center;
    justify-content: flex-start;
    overflow: visible;
    margin-left: auto;
    position: static;
}

.btn-professional {
    display: flex;
    align-items: center;
    gap: 3px; /* Giảm gap */
    padding: 4px 8px; /* Giảm padding mạnh */
    border: 1px solid #dee2e6;
    border-radius: 4px; /* Giảm border radius */
    font-size: 0.7rem; /* Giảm font size */
    font-weight: 500;
    text-decoration: none;
    transition: all 0.3s ease;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    min-width: 70px; /* Giảm min-width */
    white-space: nowrap;
    justify-content: center;
    position: relative;
    overflow: hidden;
    flex-shrink: 0;
    height: 32px; /* Set fixed height */
}

.btn-professional i {
    font-size: 0.8rem; /* Giảm icon size */
}

/* Search controls - very compact */
.header-controls {
    display: flex;
    align-items: center;
    gap: 15px; /* Giảm gap */
    flex-wrap: nowrap;
    margin-bottom: 5px; /* Giảm margin */
}

.search-project-name {
    max-width: 220px; /* Giảm width */
    min-width: 160px;
    flex: 0 0 auto;
}

.input-group {
    font-size: 0.8rem; /* Giảm font size */
    height: 35px; /* Set fixed height */
}

.input-group-text {
    padding: 0.25rem 0.5rem; /* Giảm padding */
    font-size: 0.8rem;
}

.form-control {
    padding: 0.25rem 0.5rem; /* Giảm padding */
    font-size: 0.8rem;
}

.form-check-label {
    font-size: 0.8rem;
}

/* Main content container - CALCULATED HEIGHT */
.main-content-wrapper {
    flex: 1 1 auto;
    display: flex;
    flex-direction: column;
    min-height: 0;
    padding: 0 10px 5px 10px; /* Compact padding */
    overflow: hidden; /* Prevent overflow */
}

/* DASHBOARD TABLE SPECIFIC STYLES */
/* Table container - FIXED HEIGHT CALCULATION */
.dashboard-table-container {
    flex: 1 1 auto;
    width: 100%;
    height: calc(100vh - 140px); /* Tính toán chính xác: 100vh trừ navbar + header */
    max-height: calc(100vh - 140px);
    overflow-y: auto;
    overflow-x: auto;
    background: linear-gradient(135deg, #f8f9fa 0%, #f8f9fa 100%);;
    border-radius: 8px; /* Giảm border radius */
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    border: 1px solid #f0f0f0;
    position: relative;
}

/* Dashboard Table styling - very compact */
#dashboardTable.table-dashboard {
    font-size: 0.9rem; /* Tăng từ 0.75rem lên 0.9rem (+20%) */
    width: 100%;
    min-width: 2000px;
    border-collapse: separate;
    border-spacing: 0;
    margin: 0;
    background: #f7fafc;
}

/* Dashboard Table Header styling - very compact */
#dashboardTable.table-dashboard thead {
    position: sticky;
    top: 0;
    z-index: 10;
    background: linear-gradient(135deg, #edf2f7 0%, #cbd5e0 100%);
    box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05);
}

#dashboardTable.table-dashboard thead th {
    background: transparent;
    color: #4a5568;
    font-weight: 600;
    font-size: 0.9rem; /* Tăng từ 0.75rem lên 0.9rem (+20%) */
    text-align: center;
    padding: 10px 8px; /* Tăng padding một chút để cân bằng */
    border: 1px solid #cbd5e0;
    border-bottom: 2px solid #a0aec0;
    text-shadow: none;
    letter-spacing: 0.2px;
    white-space: nowrap;
    position: relative;
    height: 50px; /* Tăng height để chứa font lớn hơn */
}

/* Dashboard Table Body cells - very compact */
#dashboardTable.table-dashboard tbody td {
    padding: 8px 6px; /* Tăng padding một chút */
    border: 1px solid #edf2f7;
    background: #fafafa;
    font-size: 0.9rem; /* Tăng từ 0.75rem lên 0.9rem (+20%) */
    vertical-align: middle;
    white-space: nowrap;
    transition: all 0.2s ease;
    height: 45px; /* Tăng height để chứa font lớn hơn */
}

/* Dashboard Action buttons - very compact */
#dashboardTable .action-buttons {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 3px; /* Giảm gap */
    padding: 1px 0; /* Giảm padding */
}

#dashboardTable .action-buttons .btn {
    padding: 4px 6px; /* Tăng padding một chút */
    font-size: 13px; /* Tăng từ 11px lên 13px (+18%) */
    border: none;
    border-radius: 4px;
    min-width: 28px; /* Tăng width */
    height: 28px; /* Tăng height */
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.08);
    position: relative;
    overflow: hidden;
}

/* DASHBOARD STICKY COLUMNS - VERY COMPACT */

/* First column (No) - SOFT PURPLE */
#dashboardTable.table-dashboard th:nth-child(1),
#dashboardTable.table-dashboard td:nth-child(1) {
    position: sticky;
    left: 0;
    background: linear-gradient(135deg, #edf2f7 0%, #e2e8f0 100%);
    color: #4a5568;
    font-weight: 600;
    text-align: center;
    z-index: 5;
    border-right: 2px solid rgba(160, 174, 192, 0.2);
    width: 40px; /* Giảm width mạnh */
    min-width: 40px;
    max-width: 40px;
    box-shadow: 1px 0 2px rgba(0, 0, 0, 0.03);
}

#dashboardTable.table-dashboard tbody td:nth-child(1) {
    background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e0 100%);
    color: #2d3748;
    font-weight: 600;
    text-shadow: none;
}

/* Second column (操作) - SOFT GREEN */
#dashboardTable.table-dashboard th:nth-child(2),
#dashboardTable.table-dashboard td:nth-child(2) {
    position: sticky;
    left: 40px; /* Điều chỉnh left */
    background: linear-gradient(135deg, #f8f9fa 0%, #f8f9fa 100%);
    color: #4a5568;
    z-index: 5;
    width: 85px; /* Giảm width */
    min-width: 85px;
    text-align: center;
    box-shadow: 1px 0 2px rgba(0, 0, 0, 0.03);
}

#dashboardTable.table-dashboard tbody td:nth-child(2) {
    background: linear-gradient(135deg, #f8f9fa 0%, #f8f9fa 100%);
    padding: 4px; /* Giảm padding */
}

/* Third column - SOFT BLUE */
#dashboardTable.table-dashboard th:nth-child(3),
#dashboardTable.table-dashboard td:nth-child(3) {
    position: sticky;
    left: 125px; /* Điều chỉnh left */
    background: linear-gradient(135deg, #f8f9fa 0%, #f8f9fa 100%);
    color: #4a5568;
    z-index: 5;
    width: 110px; /* Giảm width */
    min-width: 110px;
    max-width: 110px;
    box-shadow: 1px 0 2px rgba(0, 0, 0, 0.05);
}

#dashboardTable.table-dashboard tbody td:nth-child(3) {
    background: linear-gradient(135deg, #f8f9fa 0%, #f8f9fa 100%);
    color: #4a5568;
    font-weight: 500;
}

/* Fourth column - SOFT ORANGE */
#dashboardTable.table-dashboard th:nth-child(4),
#dashboardTable.table-dashboard td:nth-child(4) {
    position: sticky;
    left: 235px; /* Điều chỉnh left */
    background: linear-gradient(135deg, #f8f9fa 0%, #f8f9fa 100%);
    color: #4a5568;
    z-index: 5;
    width: 250px; /* Giảm width */
    min-width: 250px;
    max-width: 250px;
    box-shadow: 1px 0 3px rgba(0, 0, 0, 0.06);
}

#dashboardTable.table-dashboard tbody td:nth-child(4) {
    color: #4a5568;
    font-weight: 500;
}

/* Ensure dashboard sticky headers have higher z-index */
#dashboardTable.table-dashboard thead th:nth-child(-n+4) {
    z-index: 10;
}

/* Dashboard Column widths - very compact */
#dashboardTable.table-dashboard th:nth-child(5),
#dashboardTable.table-dashboard td:nth-child(5) { width: 100px; min-width: 100px; }

#dashboardTable.table-dashboard th:nth-child(6),
#dashboardTable.table-dashboard td:nth-child(6) { width: 120px; min-width: 120px; }

#dashboardTable.table-dashboard th:nth-child(7),
#dashboardTable.table-dashboard td:nth-child(7) { width: 120px; min-width: 120px; }

#dashboardTable.table-dashboard th:nth-child(8),
#dashboardTable.table-dashboard td:nth-child(8) { width: 80px; min-width: 80px; }

#dashboardTable.table-dashboard th:nth-child(9),
#dashboardTable.table-dashboard td:nth-child(9) { width: 80px; min-width: 80px; }

#dashboardTable.table-dashboard th:nth-child(10),
#dashboardTable.table-dashboard td:nth-child(10) { width: 100px; min-width: 100px; }

#dashboardTable.table-dashboard th:nth-child(18),
#dashboardTable.table-dashboard td:nth-child(18) { width: 110px; min-width: 110px; }

#dashboardTable.table-dashboard th:nth-child(20),
#dashboardTable.table-dashboard td:nth-child(20) { width: 140px; min-width: 140px; }

#dashboardTable.table-dashboard th:nth-child(22),
#dashboardTable.table-dashboard td:nth-child(22) { width: 110px; min-width: 110px; }

#dashboardTable.table-dashboard th:nth-child(23),
#dashboardTable.table-dashboard td:nth-child(23) { width: 75px; min-width: 75px; }

#dashboardTable.table-dashboard th:nth-child(24),
#dashboardTable.table-dashboard td:nth-child(24) { width: 75px; min-width: 75px; }

#dashboardTable.table-dashboard th:nth-child(25),
#dashboardTable.table-dashboard td:nth-child(25) { width: 75px; min-width: 75px; }

#dashboardTable.table-dashboard th:nth-child(26),
#dashboardTable.table-dashboard td:nth-child(26) { width: 75px; min-width: 75px; }

#dashboardTable.table-dashboard th:nth-child(27),
#dashboardTable.table-dashboard td:nth-child(27) { width: 200px; min-width: 200px; }

#dashboardTable.table-dashboard th:nth-child(28),
#dashboardTable.table-dashboard td:nth-child(28) { width: 75px; min-width: 75px; }

#dashboardTable.table-dashboard th:nth-child(29),
#dashboardTable.table-dashboard td:nth-child(29) { width: 75px; min-width: 75px; }

#dashboardTable.table-dashboard th:nth-child(30),
#dashboardTable.table-dashboard td:nth-child(30) { width: 75px; min-width: 75px; }

#dashboardTable.table-dashboard th:nth-child(31),
#dashboardTable.table-dashboard td:nth-child(31) { width: 75px; min-width: 75px; }

#dashboardTable.table-dashboard th:nth-child(32),
#dashboardTable.table-dashboard td:nth-child(32) { width: 75px; min-width: 75px; }

/* Dashboard Soft highlighting - giữ nguyên nhưng compact */
#dashboardTable.table-dashboard .past-date { 
    background: linear-gradient(135deg, #e9e5d1 0%, #fbfbfb 100%) !important;
    color: #4a5568 !important;
    font-weight: 500;
    position: relative;
}

#dashboardTable.table-dashboard .past-date::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 2px; /* Giảm width */
    background: linear-gradient(180deg, #f59e0b 0%, #d97706 100%);
    opacity: 0.7;
}

#dashboardTable.table-dashboard .highlight-date { 
    background: linear-gradient(135deg, #fbfbfb 0%, #fae697 100%) !important;
    color: #4a5568 !important;
    font-weight: 600;
    position: relative;
    animation: softPulse 3s infinite;
}

#dashboardTable.table-dashboard .highlight-date::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 2px; /* Giảm width */
    background: linear-gradient(180deg, #eab308 0%, #ca8a04 100%);
    opacity: 0.8;
}

#dashboardTable.table-dashboard .fb-late { 
    background: linear-gradient(135deg, #f6e9e9 0%, #fdf2f2 100%) !important;
    color: #475569 !important;
    font-weight: 600;
    position: relative;
    animation: softPulse 3s infinite;
}

#dashboardTable.table-dashboard .fb-late::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 2px; /* Giảm width */
    background: linear-gradient(180deg, #ef4444 0%, #dc2626 100%);
    opacity: 0.7;
}

/* SOFT ANIMATIONS */
@keyframes softPulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.85; }
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(2px); }
    to { opacity: 1; transform: translateY(0); }
}

#dashboardTable.table-dashboard tbody tr {
    animation: fadeIn 0.3s ease-out;
}

/* Dashboard Row hover effects - softer và compact */
#dashboardTable.table-dashboard tbody tr {
    transition: all 0.2s ease;
}

#dashboardTable.table-dashboard tbody tr:hover {
    background: linear-gradient(90deg, #f8fafc 0%, #f1f5f9 100%);
    transform: translateY(-1px);
    box-shadow: 0 1px 4px rgba(0, 0, 0, 0.04);
}

#dashboardTable.table-dashboard tbody tr:hover td {
    border-color: #e2e8f0;
}

/* Dashboard Alternating row colors - softer */
#dashboardTable.table-dashboard tbody tr:nth-child(even) {
    background: linear-gradient(90deg, #fafbfc 0%, #f8fafc 100%);
}

#dashboardTable.table-dashboard tbody tr:nth-child(odd) {
    background: linear-gradient(135deg, #f8f9fa 0%, #f8f9fa 100%);;
}

/* Dashboard Sort indicators - compact */
#dashboardTable .sort-indicator::after {
    content: '';
    display: inline-block;
    width: 0;
    height: 0;
    margin-left: 5px; /* Tăng margin */
    vertical-align: middle;
    border-left: 4px solid transparent; /* Tăng size */
    border-right: 4px solid transparent;
    opacity: 0.5;
}

#dashboardTable .sort-asc .sort-indicator::after {
    border-bottom: 4px solid #4a5568; /* Tăng size */
    opacity: 0.8;
}

#dashboardTable .sort-desc .sort-indicator::after {
    border-top: 4px solid #4a5568; /* Tăng size */
    opacity: 0.8;
}

/* Dashboard Sortable styling */
#dashboardTable .sortable {
    cursor: pointer;
    position: relative;
    user-select: none;
}

#dashboardTable .sortable:hover {
    background: rgba(148, 163, 184, 0.1);
    transition: background 0.3s ease;
}

/* VERY COMPACT SCROLLBAR STYLING - Dashboard specific */
.dashboard-table-container::-webkit-scrollbar {
    width: 6px; /* Giảm width */
    height: 6px; /* Giảm height */
}

.dashboard-table-container::-webkit-scrollbar-track {
    background: #f8fafc;
    border-radius: 3px;
}

.dashboard-table-container::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, #cbd5e1 0%, #94a3b8 100%);
    border-radius: 3px;
    border: 1px solid #f8fafc;
}

.dashboard-table-container::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(135deg, #94a3b8 0%, #4a5568 100%);
}

.dashboard-table-container::-webkit-scrollbar-corner {
    background: #f8fafc;
}

/* Dashboard Action button colors - very compact */
#dashboardTable .btn-edit { 
    background: linear-gradient(135deg, #f8f9fa 0%, #f8f9fa 100%);
    color: #4a5568;
}

#dashboardTable .btn-mail { 
    background: linear-gradient(135deg, #f8f9fa 0%, #f8f9fa 100%);
    color: #4a5568;
}

#dashboardTable .btn-copy { 
    background: linear-gradient(135deg, #f8f9fa 0%, #f8f9fa 100%);
    color: #4a5568;
}

#dashboardTable .btn-edit:hover { 
    background: linear-gradient(135deg, #f8f9fa 0%, #f8f9fa 100%);
    color: #4a5568;
}

#dashboardTable .btn-mail:hover { 
    background: linear-gradient(135deg, #f8f9fa 0%, #f8f9fa 100%);
    color: #4a5568;
}

#dashboardTable .btn-copy:hover { 
    background: linear-gradient(135deg, #f8f9fa 0%, #f8f9fa 100%);
    color: #4a5568;
}

#dashboardTable .action-buttons .btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: left 0.5s;
}

#dashboardTable .action-buttons .btn:hover::before {
    left: 100%;
}

#dashboardTable .action-buttons .btn:hover {
    transform: translateY(-1px) scale(1.02);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.12);
}

/* DASHBOARD LOADING STATES - SOFT */
#dashboardTable.table-loading {
    position: relative;
    opacity: 0.7;
    pointer-events: none;
}

#dashboardTable.table-loading::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 32px; /* Tăng size */
    height: 32px;
    margin: -16px 0 0 -16px;
    border: 3px solid #f1f5f9;
    border-top: 3px solid #94a3b8;
    border-radius: 50%;
    animation: softSpin 1.5s linear infinite;
}

@keyframes softSpin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* SOFT PROFESSIONAL SHADOWS AND DEPTH - Dashboard specific */
#dashboardTable.table-dashboard thead {
    box-shadow: 
        0 1px 3px rgba(0, 0, 0, 0.06),
        0 1px 6px rgba(0, 0, 0, 0.03);
}

#dashboardTable.table-dashboard tbody tr:hover {
    box-shadow: 
        0 1px 3px rgba(0, 0, 0, 0.04),
        0 1px 6px rgba(0, 0, 0, 0.02);
}

/* Button styling - very compact */
.btn-schedule {
    background: linear-gradient(135deg, #edf2f7 0%, #e2e8f0 100%);
    color: #4a5568;
    border-color: #cbd5e0;
}

.btn-schedule:hover {
    background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e0 100%);
    color: #2d3748;
}

.btn-report {
    background: linear-gradient(135deg, #edf2f7 0%, #e2e8f0 100%);
    color: #4a5568;
    border-color: #cbd5e0;
}

.btn-report:hover {
    background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e0 100%);
    color: #2d3748;
}

.btn-excel {
    background: linear-gradient(135deg, #edf2f7 0%, #e2e8f0 100%);
    color: #4a5568;
    border-color: #cbd5e0;
}

.btn-excel:hover {
    background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e0 100%);
    color: #2d3748;
}

.btn-mail-edit {
    background: linear-gradient(135deg, #e2e8f0 0%, #edf2f7 100%);
    color: #4a5568;
    border-color: #cbd5e0;
}

.btn-mail-edit:hover {
    background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e0 100%);
    color: #2d3748;
}

.btn-task-create {
    background: linear-gradient(135deg, #edf2f7 0%, #e2e8f0 100%);
    color: #4a5568;
    border-color: #cbd5e0;
}

.btn-task-create:hover {
    background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e0 100%);
    color: #2d3748;
}

.btn-delete {
    background: linear-gradient(135deg, #edf2f7 0%, #e2e8f0 100%);
    color: #4a5568;
    border-color: #cbd5e0;
}

.btn-delete:hover {
    background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e0 100%);
    color: #2d3748;
}

.btn-logout {
    background: linear-gradient(135deg, #edf2f7 0%, #e2e8f0 100%);
    color: #4a5568;
    border-color: #cbd5e0;
}

.btn-logout:hover {
    background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e0 100%);
    color: #2d3748;
}

.btn-professional::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    transition: left 0.5s;
}

.btn-professional:hover::before {
    left: 100%;
}

.btn-professional:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.12);
}

/* Dropdown Styles - compact */
.dropdown {
    position: relative;
}

.dropdown-menu {
    font-size: 0.84rem; /* Tăng từ 0.7rem lên 0.84rem (+20%) */
    border-radius: 4px;
    box-shadow: 0 3px 12px rgba(0, 0, 0, 0.15);
    min-width: 150px; /* Tăng width */
    z-index: 1050;
    border: 1px solid #dee2e6;
    background-color: white;
    position: absolute !important;
    top: 100% !important;
    left: 0 !important;
    margin-top: 1px;
}

.dropdown.show .dropdown-menu {
    display: block !important;
    position: absolute !important;
    top: 100% !important;
    left: 0 !important;
    z-index: 1060 !important;
}

.dropdown-item {
    padding: 8px 12px; /* Tăng padding */
    color: #495057;
    display: flex;
    align-items: center;
    gap: 8px; /* Tăng gap */
    transition: background-color 0.2s;
    font-size: 0.84rem; /* Tăng từ 0.7rem lên 0.84rem (+20%) */
}

.dropdown-item:hover {
    background-color: #f8f9fa;
    color: #212529;
}

.dropdown-item i {
    width: 16px; /* Tăng size */
    text-align: center;
    font-size: 0.96rem; /* Tăng từ 0.8rem lên 0.96rem (+20%) */
}

.dropdown-toggle::after {
    margin-left: 0.2em;
    vertical-align: 0.2em;
    border-top: 0.25em solid;
    border-right: 0.25em solid transparent;
    border-bottom: 0;
    border-left: 0.25em solid transparent;
}

.dropdown-toggle:empty::after {
    margin-left: 0;
}

/* Navbar Overrides */
.navbar,
.navbar .d-flex,
.navbar .navbar-nav {
    overflow: visible !important;
}

/* Responsive Design - VERY COMPACT */
@media (min-width: 1200px) {
    .btn-professional {
        min-width: 90px; /* Tăng width */
        padding: 5px 12px;
        font-size: 0.9rem; /* Tăng từ 0.75rem lên 0.9rem (+20%) */
    }
    
    .btn-professional i {
        font-size: 1.02rem; /* Tăng từ 0.85rem lên 1.02rem (+20%) */
    }
    
    #dashboardTable.table-dashboard {
        font-size: 1.02rem; /* Tăng từ 0.85rem lên 1.02rem (+20%) */
    }
    
    #dashboardTable.table-dashboard th,
    #dashboardTable.table-dashboard td {
        padding: 12px 8px; /* Tăng padding */
    }
    
    .dashboard-table-container {
        height: calc(100vh - 140px); /* Điều chỉnh cho desktop */
    }
}

@media (max-width: 1199px) {
    .btn-group-professional {
        flex-wrap: wrap;
        gap: 4px; /* Tăng gap */
    }
    
    .btn-professional {
        min-width: 72px; /* Tăng width */
        padding: 4px 8px; /* Tăng padding */
        font-size: 0.78rem; /* Tăng từ 0.65rem lên 0.78rem (+20%) */
    }
    
    .btn-professional i {
        font-size: 0.9rem; /* Tăng từ 0.75rem lên 0.9rem (+20%) */
    }
    
    .dashboard-table-container {
        height: calc(100vh - 145px); /* Điều chỉnh cho tablet */
    }
}

@media (max-width: 768px) {
    .container-fluid.mb-3 {
        padding: 6px 10px; /* Tăng padding */
    }
    
    .header-controls {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px; /* Tăng gap */
        margin-bottom: 5px;
    }
    
    .search-project-name {
        width: 100%;
        max-width: none;
    }
    
    .btn-group-professional {
        gap: 3px; /* Tăng gap */
        flex-wrap: wrap;
    }
    
    .btn-professional {
        padding: 4px 6px;
        font-size: 0.72rem; /* Tăng từ 0.6rem lên 0.72rem (+20%) */
        min-width: 60px; /* Tăng width */
        height: 32px; /* Tăng height */
    }
    
    .btn-professional i {
        font-size: 0.84rem; /* Tăng từ 0.7rem lên 0.84rem (+20%) */
    }
    
    .btn-professional span {
        display: none;
    }
    
    #dashboardTable.table-dashboard {
        font-size: 0.78rem; /* Tăng từ 0.65rem lên 0.78rem (+20%) */
    }
    
    #dashboardTable.table-dashboard th,
    #dashboardTable.table-dashboard td {
        padding: 6px 4px; /* Tăng padding */
        height: 40px; /* Tăng height */
    }
    
    #dashboardTable.table-dashboard thead th {
        padding: 8px 6px; /* Tăng padding */
        font-size: 0.84rem; /* Tăng từ 0.7rem lên 0.84rem (+20%) */
        height: 45px; /* Tăng height */
    }
    
    #dashboardTable .action-buttons .btn {
        min-width: 24px; /* Tăng width */
        height: 24px;
        font-size: 12px; /* Tăng từ 10px lên 12px (+20%) */
    }
    
    .dashboard-table-container {
        height: calc(100vh - 160px); /* Điều chỉnh cho mobile */
        border-radius: 6px;
    }
}

@media (max-width: 576px) {
    .btn-group-professional {
        justify-content: center;
        flex-wrap: wrap;
    }
    
    .btn-professional {
        min-width: 48px; /* Tăng width */
        padding: 4px;
        height: 30px; /* Tăng height */
    }
    
    .dashboard-table-container {
        height: calc(100vh - 170px); /* Điều chỉnh cho mobile nhỏ */
    }
}

/* Modal Styles - compact */
.modal-body {
    overflow-y: auto;
}

.modal-header {
    padding: 0.8rem 1rem; /* Tăng padding */
}

.modal-footer {
    padding: 0.6rem 1rem; /* Tăng padding */
}

.modal-title {
    font-size: 1.2rem; /* Tăng font size cho title */
}

/* Button trong modal - increased font size */
.modal .btn {
    font-size: 0.9rem; /* Tăng font size */
    padding: 0.5rem 1rem; /* Tăng padding */
}

/* Form styles - very compact */
.form-label {
    font-size: 0.9rem; /* Tăng từ 0.75rem lên 0.9rem (+20%) */
    margin-bottom: 0.3rem;
}

.modal .form-control, 
.modal .form-check-input, 
.modal .form-select {
    font-size: 0.9rem; /* Tăng từ 0.75rem lên 0.9rem (+20%) */
    padding: 0.35rem 0.5rem; /* Tăng padding */
}

/* Badge and enhancements */
.btn-professional .badge {
    position: absolute;
    top: -2px;
    right: -2px;
    background: #dc3545;
    color: white;
    font-size: 0.66rem; /* Tăng từ 0.55rem lên 0.66rem (+20%) */
    padding: 2px 4px; /* Tăng padding */
    border-radius: 6px;
    min-width: 14px; /* Tăng width */
    height: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Copy Mail Checkbox */
#copyMailCheckbox:checked + .form-check-label {
    color: #28a745;
}

/* SCHEDULE MODAL SPECIFIC STYLES */
/* Schedule table container */
.schedule-table-container {
    width: 100%;
    max-height: 60vh;
    overflow-y: auto;
    overflow-x: auto;
    background: linear-gradient(135deg, #f8f9fa 0%, #f8f9fa 100%);;
    border-radius: 6px;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
    border: 1px solid #f0f0f0;
    position: relative;
}

/* Schedule Table styling */
.schedule-table {
    font-size: 0.9rem;
    width: 100%;
    min-width: 800px;
    border-collapse: separate;
    border-spacing: 0;
    margin: 0;
    background: linear-gradient(135deg, #f8f9fa 0%, #f8f9fa 100%);;
}

/* Schedule Table Header styling */
.schedule-table thead {
    position: sticky;
    top: 0;
    z-index: 10;
    background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
}

.schedule-table thead th {
    background: transparent;
    color: #475569;
    font-weight: 600;
    font-size: 0.9rem;
    text-align: center;
    padding: 12px 10px;
    border: 1px solid #e2e8f0;
    border-bottom: 2px solid #cbd5e1;
    text-shadow: none;
    letter-spacing: 0.2px;
    white-space: nowrap;
    position: relative;
    height: 50px;
}

/* Schedule Table Body cells */
.schedule-table tbody td {
    padding: 10px 8px;
    border: 1px solid #f1f5f9;
    background: linear-gradient(135deg, #f8f9fa 0%, #f8f9fa 100%);;
    font-size: 0.9rem;
    vertical-align: middle;
    white-space: nowrap;
    transition: all 0.2s ease;
    height: 45px;
}

/* Schedule First column (完了済) - SOFT PURPLE */
.schedule-table th:nth-child(1),
.schedule-table td:nth-child(1) {
    position: sticky;
    left: 0;
    background: linear-gradient(135deg, #f8f9fa 0%, #f8f9fa 100%);
    color: #4a5568;
    font-weight: 600;
    text-align: center;
    z-index: 5;
    width: 80px;
    min-width: 80px;
    max-width: 80px;
    box-shadow: 1px 0 2px rgba(0, 0, 0, 0.05);
}

.schedule-table tbody td:nth-child(1) {
    background: linear-gradient(135deg, #f8f9fa 0%, #f8f9fa 100%);
    color: #5b21b6;
    font-weight: 600;
}

/* Schedule Second column (日付) - SOFT GREEN */
.schedule-table th:nth-child(2),
.schedule-table td:nth-child(2) {
    position: sticky;
    left: 80px;
    background: linear-gradient(135deg, #f8f9fa 0%, #f8f9fa 100%);
    color: #4a5568;
    z-index: 5;
    width: 140px;
    min-width: 140px;
    max-width: 140px;
    text-align: center;
    box-shadow: 1px 0 2px rgba(0, 0, 0, 0.05);
}

.schedule-table tbody td:nth-child(2) {
    background: linear-gradient(135deg, #f8f9fa 0%, #f8f9fa 100%);
    color: #4a5568;
    font-weight: 500;
}

/* Schedule Third column (タスク) - SOFT BLUE */
.schedule-table th:nth-child(3),
.schedule-table td:nth-child(3) {
    position: sticky;
    left: 220px;
    background: linear-gradient(135deg, #f8f9fa 0%, #f8f9fa 100%);
    color: #4a5568;
    z-index: 5;
    width: 100px;
    min-width: 100px;
    max-width: 100px;
    box-shadow: 1px 0 2px rgba(0, 0, 0, 0.05);
}

.schedule-table tbody td:nth-child(3) {
    background: linear-gradient(135deg, #f8f9fa 0%, #f8f9fa 100%);
    color: #4a5568;
    font-weight: 500;
}

/* Schedule Column widths for remaining columns */
.schedule-table th:nth-child(4),
.schedule-table td:nth-child(4) { width: 200px; min-width: 200px; } /* 案件名 */

.schedule-table th:nth-child(5),
.schedule-table td:nth-child(5) { width: 100px; min-width: 100px; } /* SE */

.schedule-table th:nth-child(6),
.schedule-table td:nth-child(6) { width: 80px; min-width: 80px; } /* PH */

.schedule-table th:nth-child(7),
.schedule-table td:nth-child(7) { width: 120px; min-width: 120px; } /* 開発工数（h） */

/* Ensure schedule sticky headers have higher z-index */
.schedule-table thead th:nth-child(-n+3) {
    z-index: 10;
}

/* Schedule Row hover effects */
.schedule-table tbody tr {
    transition: all 0.2s ease;
    animation: fadeIn 0.3s ease-out;
}

.schedule-table tbody tr:hover {
    background: linear-gradient(90deg, #f8fafc 0%, #f1f5f9 100%);
    transform: translateY(-1px);
    box-shadow: 0 1px 4px rgba(0, 0, 0, 0.04);
}

.schedule-table tbody tr:hover td {
    border-color: #e2e8f0;
}

/* Schedule Alternating row colors */
.schedule-table tbody tr:nth-child(even) {
    background: linear-gradient(90deg, #fafbfc 0%, #f8fafc 100%);
}

.schedule-table tbody tr:nth-child(odd) {
    background: linear-gradient(135deg, #f8f9fa 0%, #f8f9fa 100%);;
}

/* Schedule Checkbox styling */
.schedule-table input[type="checkbox"] {
    width: 18px;
    height: 18px;
    accent-color: #4a5568;
    cursor: pointer;
    transform: scale(1.1);
}

.schedule-table input[type="checkbox"]:checked {
    background: linear-gradient(135deg, #4a5568 0%, #5b21b6 100%);
}

/* Schedule Week navigation buttons */
.week-nav-buttons {
    display: flex;
    gap: 10px;
    justify-content: center;
    margin-bottom: 15px;
}

.week-nav-buttons .btn {
    font-size: 0.9rem;
    padding: 8px 16px;
    border-radius: 6px;
    transition: all 0.3s ease;
}

.week-nav-buttons .btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
}

/* Week date range display */
.week-date-range {
    text-align: center;
    font-size: 1rem;
    font-weight: 600;
    color: #475569;
    margin-bottom: 20px;
    padding: 8px 16px;
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    border-radius: 6px;
    border: 1px solid #e2e8f0;
}

/* Schedule Modal scrollbar styling */
.schedule-table-container::-webkit-scrollbar {
    width: 6px;
    height: 6px;
}

.schedule-table-container::-webkit-scrollbar-track {
    background: #f8fafc;
    border-radius: 3px;
}

.schedule-table-container::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, #cbd5e1 0%, #94a3b8 100%);
    border-radius: 3px;
    border: 1px solid #f8fafc;
}

.schedule-table-container::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(135deg, #94a3b8 0%, #4a5568 100%);
}

.schedule-table-container::-webkit-scrollbar-corner {
    background: #f8fafc;
}

/* Schedule Modal header styling */
#scheduleModal .modal-header {
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    border-bottom: 2px solid #e2e8f0;
}

#scheduleModal .modal-title {
    color: #475569;
    font-weight: 600;
}

/* Schedule Modal responsive design */
@media (max-width: 768px) {
    .schedule-table {
        font-size: 0.8rem;
        min-width: 600px;
    }
    
    .schedule-table thead th {
        padding: 8px 6px;
        font-size: 0.8rem;
        height: 40px;
    }
    
    .schedule-table tbody td {
        padding: 6px 4px;
        height: 35px;
    }
    
    .schedule-table-container {
        max-height: 50vh;
    }
    
    .week-nav-buttons .btn {
        font-size: 0.8rem;
        padding: 6px 12px;
    }
    
    .week-date-range {
        font-size: 0.9rem;
    }
    
    /* Adjust sticky column widths for mobile */
    .schedule-table th:nth-child(1),
    .schedule-table td:nth-child(1) {
        width: 60px;
        min-width: 60px;
        max-width: 60px;
    }
    
    .schedule-table th:nth-child(2),
    .schedule-table td:nth-child(2) {
        left: 60px;
        width: 120px;
        min-width: 120px;
        max-width: 120px;
    }
    
    .schedule-table th:nth-child(3),
    .schedule-table td:nth-child(3) {
        left: 180px;
        width: 80px;
        min-width: 80px;
        max-width: 80px;
    }
}

@media (max-width: 576px) {
    .schedule-table {
        font-size: 0.75rem;
    }
    
    .schedule-table-container {
        max-height: 45vh;
    }
    
    .week-nav-buttons {
        flex-direction: column;
        align-items: center;
    }
    
    .week-nav-buttons .btn {
        width: 120px;
    }
}
/* EDIT AND COPY MODAL SPECIFIC STYLES */
/* Edit Modal styling */
#editModal .modal-content,
#copyModal .modal-content {
    border: none;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
    border-radius: 8px;
}

#editModal .modal-header,
#copyModal .modal-header {
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    border-bottom: 2px solid #e2e8f0;
    border-radius: 8px 8px 0 0;
    padding: 1rem 1.25rem;
}

#editModal .modal-title,
#copyModal .modal-title {
    color: #475569;
    font-weight: 600;
    font-size: 1.1rem;
}

#editModal .modal-body,
#copyModal .modal-body {
    padding: 1.5rem 1.25rem;
    background: linear-gradient(135deg, #f8f9fa 0%, #f8f9fa 100%);;
    max-height: 70vh;
    overflow-y: auto;
}

/* Form styling for edit and copy modals */
#editModal .form-label,
#copyModal .form-label {
    color: #374151;
    font-weight: 500;
    font-size: 0.9rem;
    margin-bottom: 0.4rem;
}

#editModal .form-control,
#copyModal .form-control,
#editModal .form-select,
#copyModal .form-select {
    border: 1px solid #d1d5db;
    border-radius: 6px;
    padding: 0.5rem 0.75rem;
    font-size: 0.9rem;
    transition: all 0.2s ease;
    background: linear-gradient(135deg, #f8f9fa 0%, #f8f9fa 100%);;
}

#editModal .form-control:focus,
#copyModal .form-control:focus,
#editModal .form-select:focus,
#copyModal .form-select:focus {
    border-color: #3b82f6;
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
    outline: none;
}

/* Column layout styling */
#editModal .col-12.col-md-3,
#copyModal .col-12.col-md-3 {
    padding: 0 0.75rem;
}

/* Task checkboxes styling */
#editModal .task-checkboxes,
#copyModal .task-checkboxes {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    padding: 0.5rem;
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    border: 1px solid #e2e8f0;
    border-radius: 6px;
}

#editModal .task-checkboxes .form-check,
#copyModal .task-checkboxes .form-check {
    margin-bottom: 0;
    display: flex;
    align-items: center;
    gap: 0.4rem;
}

#editModal .task-checkboxes .form-check-input,
#copyModal .task-checkboxes .form-check-input {
    width: 18px;
    height: 18px;
    margin-top: 0;
    accent-color: #3b82f6;
    cursor: pointer;
}

#editModal .task-checkboxes .form-check-label,
#copyModal .task-checkboxes .form-check-label {
    font-size: 0.85rem;
    color: #374151;
    cursor: pointer;
    margin-bottom: 0;
}

/* Order checkboxes styling */
#editModal .order-checkboxes,
#copyModal .order-checkboxes {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    padding: 0.5rem;
    background: linear-gradient(135deg, #f8f9fa 0%, #f8f9fa 100%);;
    border: 1px solid #94a3b8;
    border-radius: 6px;
}

#editModal .order-checkboxes .form-check,
#copyModal .order-checkboxes .form-check {
    margin-bottom: 0;
    display: flex;
    align-items: center;
    gap: 0.4rem;
}

#editModal .order-checkboxes .form-check-input,
#copyModal .order-checkboxes .form-check-input {
    width: 18px;
    height: 18px;
    margin-top: 0;
    accent-color: #f59e0b;
    cursor: pointer;
}

#editModal .order-checkboxes .form-check-label,
#copyModal .order-checkboxes .form-check-label {
    font-size: 0.85rem;
    color: #4a5568;
    cursor: pointer;
    margin-bottom: 0;
    font-weight: 500;
}

/* Status select styling */
#editModal #edit_ステータス,
#copyModal #copy_ステータス {
    background: linear-gradient(135deg, #f8f9fa 0%, #f8f9fa 100%);;
    border: 1px solid #66bb6a;
    color: #4a5568;
    font-weight: 500;
}

/* Date input styling */
#editModal input[type="date"],
#copyModal input[type="date"] {
    background: linear-gradient(135deg, #f8f9fa 0%, #f8f9fa 100%);;
    border: 1px solid #ba68c8;
    color: #4a5568;
}

#editModal input[type="date"]:focus,
#copyModal input[type="date"]:focus {
    border-color: #94a3b8;;
    box-shadow: 0 0 0 2px rgba(156, 39, 176, 0.1);
}

/* Number input styling */
#editModal input[type="number"],
#copyModal input[type="number"] {
    background: linear-gradient(135deg, #f8f9fa 0%, #f8f9fa 100%);;
    border: 1px solid #66bb6a;
    color: #4a5568;
}

#editModal input[type="number"]:focus,
#copyModal input[type="number"]:focus {
    border-color: #94a3b8;
    box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.1);
}

/* Textarea styling */
#editModal textarea,
#copyModal textarea {
    background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
    border: 1px solid #ffb74d;
    color: #e65100;
    resize: vertical;
    min-height: 80px;
}

#editModal textarea:focus,
#copyModal textarea:focus {
    border-color: #94a3b8;
    box-shadow: 0 0 0 2px rgba(255, 152, 0, 0.1);
}

/* Modal header buttons styling */
#editModal .modal-header .btn,
#copyModal .modal-header .btn {
    font-size: 0.9rem;
    padding: 0.4rem 0.8rem;
    border-radius: 5px;
    transition: all 0.3s ease;
}

#editModal .modal-header .btn-primary,
#copyModal .modal-header .btn-primary {
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
    border: none;
    color: white;
}

#editModal .modal-header .btn-primary:hover,
#copyModal .modal-header .btn-primary:hover {
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
}

#editModal .modal-header .btn-secondary,
#copyModal .modal-header .btn-secondary {
    background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
    border: none;
    color: white;
}

#editModal .modal-header .btn-secondary:hover,
#copyModal .modal-header .btn-secondary:hover {
    background: linear-gradient(135deg, #4b5563 0%, #374151 100%);
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(107, 114, 128, 0.3);
}

/* Checkbox styling for 不要 */
#editModal .form-check,
#copyModal .form-check {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

#editModal .form-check-input,
#copyModal .form-check-input {
    width: 18px;
    height: 18px;
    margin-top: 0;
    accent-color: #dc2626;
    cursor: pointer;
}

#editModal .form-check-label,
#copyModal .form-check-label {
    color: #dc2626;
    font-weight: 500;
    cursor: pointer;
    margin-bottom: 0;
}

/* Special styling for project name field in copy modal */
#copyModal #copy_project_name {
    background: linear-gradient(135deg, #fff 0%, #fff 100%);
    border: 2px solid #3b82f6;
    color: #4a5568;
    font-weight: 600;
}

#copyModal #copy_project_name:focus {
    border-color: #94a3b8;
    box-shadow: 0 0 0 3px linear-gradient(135deg, #94a3b8 0%, #676767 100%);
}

/* Input validation styling */
#editModal .form-control:invalid,
#copyModal .form-control:invalid {
    border-color: #94a3b8;
    box-shadow: 0 0 0 2px rgba(220, 38, 38, 0.1);
}

#editModal .form-control:valid,
#copyModal .form-control:valid {
    border-color: #94a3b8;
}

/* Responsive design for edit and copy modals */
@media (max-width: 768px) {
    #editModal .modal-body,
    #copyModal .modal-body {
        padding: 1rem;
        max-height: 60vh;
    }
    
    #editModal .col-12.col-md-3,
    #copyModal .col-12.col-md-3 {
        padding: 0 0.5rem;
        margin-bottom: 1rem;
    }
    
    #editModal .task-checkboxes,
    #copyModal .task-checkboxes,
    #editModal .order-checkboxes,
    #copyModal .order-checkboxes {
        flex-direction: column;
        gap: 0.5rem;
    }
    
    #editModal .modal-header,
    #copyModal .modal-header {
        padding: 0.75rem 1rem;
        flex-wrap: wrap;
        gap: 0.5rem;
    }
    
    #editModal .modal-header .d-flex,
    #copyModal .modal-header .d-flex {
        width: 100%;
        justify-content: space-between;
        margin-top: 0.5rem;
    }
}

@media (max-width: 576px) {
    #editModal .modal-dialog,
    #copyModal .modal-dialog {
        margin: 0.5rem;
    }
    
    #editModal .form-label,
    #copyModal .form-label {
        font-size: 0.85rem;
    }
    
    #editModal .form-control,
    #copyModal .form-control,
    #editModal .form-select,
    #copyModal .form-select {
        font-size: 0.85rem;
        padding: 0.4rem 0.6rem;
    }
    
    #editModal .task-checkboxes .form-check-label,
    #copyModal .task-checkboxes .form-check-label,
    #editModal .order-checkboxes .form-check-label,
    #copyModal .order-checkboxes .form-check-label {
        font-size: 0.8rem;
    }
}

/* Scrollbar styling for modal body */
#editModal .modal-body::-webkit-scrollbar,
#copyModal .modal-body::-webkit-scrollbar {
    width: 6px;
}

#editModal .modal-body::-webkit-scrollbar-track,
#copyModal .modal-body::-webkit-scrollbar-track {
    background: #f8fafc;
    border-radius: 3px;
}

#editModal .modal-body::-webkit-scrollbar-thumb,
#copyModal .modal-body::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, #cbd5e1 0%, #94a3b8 100%);
    border-radius: 3px;
}

#editModal .modal-body::-webkit-scrollbar-thumb:hover,
#copyModal .modal-body::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(135deg, #94a3b8 0%, #4a5568 100%);
}

/* Animation for modal appearance */
#editModal .modal-content,
#copyModal .modal-content {
    animation: modalFadeIn 0.3s ease-out;
}

@keyframes modalFadeIn {
    from {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

/* Focus ring enhancement */
#editModal .form-control:focus,
#copyModal .form-control:focus,
#editModal .form-select:focus,
#copyModal .form-select:focus,
#editModal .form-check-input:focus,
#copyModal .form-check-input:focus {
    outline: 2px solid transparent;
    outline-offset: 2px;
}

/* Hover effects for interactive elements */
#editModal .form-check:hover .form-check-label,
#copyModal .form-check:hover .form-check-label {
    color: #1f2937;
}

#editModal .task-checkboxes .form-check:hover,
#copyModal .task-checkboxes .form-check:hover {
    background: rgba(59, 130, 246, 0.05);
    border-radius: 4px;
}

#editModal .order-checkboxes .form-check:hover,
#copyModal .order-checkboxes .form-check:hover {
    background: rgba(245, 158, 11, 0.1);
    border-radius: 4px;
}

#editModal .order-checkboxes .form-check:hover,
#copyModal .order-checkboxes .form-check:hover {
    background: rgba(245, 158, 11, 0.1);
    border-radius: 4px;
}

/* Parallel Test checkbox styling */
#editModal #edit_並行テスト,
#copyModal #copy_並行テスト {
    accent-color: #6c757d;
    width: 18px;
    height: 18px;
    margin-top: 0;
    cursor: pointer;
}

#editModal .form-check-label[for="edit_並行テスト"],
#copyModal .form-check-label[for="copy_並行テスト"] {
    color: #6c757d;
    font-weight: 600;
    cursor: pointer;
    margin-bottom: 0;
    font-size: 0.9rem;
}

#editModal .form-check:has(#edit_並行テスト),
#copyModal .form-check:has(#copy_並行テスト) {
    background: linear-gradient(135deg, #f8f9fa 0%, #f8f9fa 100%);;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    padding: 0.75rem 1rem;
    transition: all 0.3s ease;
}

#editModal .form-check:has(#edit_並行テスト):hover,
#copyModal .form-check:has(#copy_並行テスト):hover {
    background: linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%);
    border-color: #94a3b8;
}

#editModal #edit_並行テスト:checked + .form-check-label,
#copyModal #copy_並行テスト:checked + .form-check-label {
    color: #7c3aed;
    font-weight: 700;
}

/* MAIL TEMPLATE MODAL SPECIFIC STYLES */
/* Mail Modal styling */
.mail-modal .modal-dialog {
    max-width: 1200px;
    width: 95vw;
}

.mail-modal .modal-content {
    border: none;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
    border-radius: 8px;
    height: 80vh;
    display: flex;
    flex-direction: column;
}

.mail-modal .modal-header {
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    border-bottom: 2px solid #e2e8f0;
    border-radius: 8px 8px 0 0;
    padding: 1rem 1.5rem;
    flex-shrink: 0;
}

.mail-modal .modal-title {
    color: #475569;
    font-weight: 600;
    font-size: 1.2rem;
}

.mail-modal .modal-body {
    flex: 1;
    padding: 0;
    display: flex;
    min-height: 0;
    background: linear-gradient(135deg, #f8f9fa 0%, #f8f9fa 100%);;
}

/* Mail buttons container - left side */
.mail-buttons-container {
    width: 300px;
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    border-right: 2px solid #e2e8f0;
    padding: 1.5rem 1rem;
    overflow-y: auto;
    flex-shrink: 0;
}

.mail-buttons {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.mail-buttons .btn {
    padding: 0.75rem 1rem;
    border-radius: 6px;
    font-size: 0.9rem;
    font-weight: 500;
    text-align: left;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    transition: all 0.3s ease;
    border: 1px solid #cbd5e1;
    background: linear-gradient(135deg, #f8f9fa 0%, #f8f9fa 100%);;
    color: #475569;
    position: relative;
}

.mail-buttons .btn:hover {
    background: linear-gradient(135deg, #f8f9fa 0%, #f8f9fa 100%);;
    border-color: #94a3b8;
    color: #4a5568;
    transform: translateX(3px);
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
}

.mail-buttons .btn.active {
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
    border-color: #94a3b8;
    color: white;
    font-weight: 600;
    transform: translateX(3px);
    box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
}

.mail-buttons .btn.copied {
    background: linear-gradient(135deg, #94a3b8 0%, #676767 100%);
    border-color: #94a3b8;
    color: white;
}

.mail-buttons .btn.copied:hover {
    background: linear-gradient(135deg, #059669 0%, #047857 100%);
}

/* Mail content container - right side */
.mail-content-container {
    flex: 1;
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
    min-height: 0;
}

.mail-content-container textarea {
    flex: 1;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    padding: 1rem;
    font-size: 0.9rem;
    line-height: 1.6;
    font-family: 'Consolas', 'Monaco', monospace;
    background: linear-gradient(135deg, #f8f9fa 0%, #f8f9fa 100%);;
    resize: none;
    min-height: 400px;
}

.mail-content-container textarea:focus {
    border-color: #94a3b8;
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
    outline: none;
}

.mail-content-container textarea::placeholder {
    color: #9ca3af;
    font-style: italic;
}

/* Copy checkbox styling */
.mail-modal .form-check {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.mail-modal .form-check-input {
    width: 18px;
    height: 18px;
    margin-top: 0;
    accent-color: #94a3b8;
    cursor: pointer;
}

.mail-modal .form-check-label {
    color: #374151;
    font-weight: 500;
    cursor: pointer;
    margin-bottom: 0;
    font-size: 0.9rem;
}

.mail-modal .form-check-input:checked + .form-check-label {
    color: #94a3b8;
    font-weight: 600;
}

/* Scrollbar styling for mail buttons */
.mail-buttons-container::-webkit-scrollbar {
    width: 6px;
}

.mail-buttons-container::-webkit-scrollbar-track {
    background: #f8fafc;
    border-radius: 3px;
}

.mail-buttons-container::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, #cbd5e1 0%, #94a3b8 100%);
    border-radius: 3px;
}

.mail-buttons-container::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(135deg, #94a3b8 0%, #4a5568 100%);
}

/* Responsive design for mail modal */
@media (max-width: 768px) {
    .mail-modal .modal-dialog {
        width: 98vw;
        margin: 1vh auto;
    }
    
    .mail-modal .modal-content {
        height: 95vh;
    }
    
    .mail-modal .modal-body {
        flex-direction: column;
    }
    
    .mail-buttons-container {
        width: 100%;
        max-height: 200px;
        border-right: none;
        border-bottom: 2px solid #e2e8f0;
    }
    
    .mail-buttons {
        flex-direction: row;
        flex-wrap: wrap;
        gap: 0.5rem;
    }
    
    .mail-buttons .btn {
        flex: 0 0 auto;
        min-width: 120px;
        padding: 0.5rem 0.75rem;
        font-size: 0.8rem;
    }
    
    .mail-content-container {
        padding: 1rem;
    }
    
    .mail-content-container textarea {
        min-height: 300px;
    }
}

@media (max-width: 576px) {
    .mail-modal .modal-header {
        padding: 0.75rem 1rem;
        flex-wrap: wrap;
        gap: 0.5rem;
    }
    
    .mail-modal .modal-title {
        font-size: 1.1rem;
    }
    
    .mail-buttons .btn {
        min-width: 100px;
        font-size: 0.75rem;
        padding: 0.4rem 0.6rem;
    }
    
    .mail-content-container {
        padding: 0.75rem;
    }
    
    .mail-content-container textarea {
        font-size: 0.85rem;
        padding: 0.75rem;
        min-height: 250px;
    }
}

/* Animation for mail modal */
.mail-modal .modal-content {
    animation: mailModalFadeIn 0.3s ease-out;
}

@keyframes mailModalFadeIn {
    from {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

/* Hover effects for interactive elements */
.mail-buttons .btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: left 0.5s;
}

.mail-buttons .btn:hover::before {
    left: 100%;
}

/* Focus ring enhancement */
.mail-buttons .btn:focus {
    outline: 2px solid #3b82f6;
    outline-offset: 2px;
}

.mail-content-container textarea:focus {
    outline: none;
}

/* Header controls - very compact */
.container-fluid.mb-3 {
    background-color: #f8f9fa;
    padding: 5px 10px; /* Giảm padding mạnh */
    border-bottom: 1px solid #dee2e6;
    flex: 0 0 auto;
    margin-bottom: 0 !important;
    min-height: 50px; /* Set minimum height */
}

/* Header controls styling */
.header-controls {
    display: flex;
    align-items: center;
    gap: 15px; /* Giảm gap */
    flex-wrap: nowrap;
    margin-bottom: 5px; /* Giảm margin */
}

/* D-flex utilities styling */
.d-flex {
    display: flex !important;
}

.align-items-center {
    align-items: center !important;
}

.gap-3 {
    gap: 1rem !important;
}

.justify-content-between {
    justify-content: space-between !important;
}

.flex-wrap {
    flex-wrap: wrap !important;
}

/* Show unnecessary form styling */
#showUnnecessaryForm {
    margin: 0;
    padding: 0;
}

#showUnnecessaryForm .form-check {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0;
    padding: 0.5rem 0.75rem;
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    transition: all 0.3s ease;
}

#showUnnecessaryForm .form-check:hover {
    background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
    border-color: #94a3b8;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

#showUnnecessaryForm .form-check-label {
    font-size: 0.9rem;
    font-weight: 500;
    color: #475569;
    cursor: pointer;
    margin-bottom: 0;
    user-select: none;
}

#showUnnecessaryForm .form-check-input {
    width: 18px;
    height: 18px;
    margin-top: 0;
    accent-color: #dc2626;
    cursor: pointer;
    transition: all 0.2s ease;
}

#showUnnecessaryForm .form-check-input:checked {
    background-color: #dc2626;
    border-color: #94a3b8;
}

#showUnnecessaryForm .form-check-input:focus {
    box-shadow: 0 0 0 2px rgba(220, 38, 38, 0.15);
    outline: none;
}

/* Search project name styling */
.search-project-name {
    max-width: 220px; /* Giảm width */
    min-width: 160px;
    flex: 0 0 auto;
}

.search-project-name .input-group {
    border-radius: 6px;
    overflow: hidden;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    transition: all 0.3s ease;
}

.search-project-name .input-group:hover {
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
}

.search-project-name .input-group:focus-within {
    box-shadow: 0 0 0 2px linear-gradient(135deg, #94a3b8 0%, #676767 100%);
}

.search-project-name .input-group-text {
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
    color: white;
    border: none;
    font-weight: 500;
    font-size: 0.9rem;
    padding: 0.5rem 0.75rem;
}

.search-project-name .form-control {
    border: none;
    font-size: 0.9rem;
    padding: 0.5rem 0.75rem;
    background: linear-gradient(135deg, #f8f9fa 0%, #f8f9fa 100%);;
}

.search-project-name .form-control:focus {
    box-shadow: none;
    outline: none;
    background: #f8fafc;
}

.search-project-name .form-control::placeholder {
    color: #9ca3af;
    font-style: italic;
}

/* Container header section styling */
.container-fluid.mb-3 .d-flex.justify-content-between {
    min-height: 40px;
    align-items: center;
}

.container-fluid.mb-3 .d-flex.align-items-center.gap-3 {
    flex-wrap: nowrap;
    min-width: 0; /* Allow shrinking */
}

/* Enhanced responsive behavior */
@media (max-width: 768px) {
    .container-fluid.mb-3 {
        padding: 6px 10px; /* Tăng padding */
    }
    
    .container-fluid.mb-3 .d-flex.justify-content-between {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.75rem;
    }
    
    .container-fluid.mb-3 .d-flex.align-items-center.gap-3 {
        width: 100%;
        flex-wrap: wrap;
        gap: 0.75rem !important;
    }
    
    .search-project-name {
        width: 100%;
        max-width: none;
        min-width: 0;
    }
    
    .search-project-name .input-group {
        width: 100%;
    }
    
    #showUnnecessaryForm .form-check {
        padding: 0.4rem 0.6rem;
        font-size: 0.85rem;
    }
    
    #showUnnecessaryForm .form-check-label {
        font-size: 0.85rem;
    }
    
    #showUnnecessaryForm .form-check-input {
        width: 16px;
        height: 16px;
    }
}

@media (max-width: 576px) {
    .container-fluid.mb-3 .d-flex.align-items-center.gap-3 {
        gap: 0.5rem !important;
    }
    
    .search-project-name .input-group-text {
        font-size: 0.8rem;
        padding: 0.4rem 0.6rem;
    }
    
    .search-project-name .form-control {
        font-size: 0.8rem;
        padding: 0.4rem 0.6rem;
    }
    
    #showUnnecessaryForm .form-check {
        padding: 0.3rem 0.5rem;
    }
    
    #showUnnecessaryForm .form-check-label {
        font-size: 0.8rem;
    }
    
    #showUnnecessaryForm .form-check-input {
        width: 14px;
        height: 14px;
    }
}
.form-check .form-check-input{
    margin-left: 0.5rem;
}
/* === DAILY REPORT MODAL SPECIFIC STYLES === */
/* Daily Report Modal styling */
#dailyReportModal .modal-dialog {
    max-width: 1400px;
    width: 95vw;
}

#dailyReportModal .modal-content {
    border: none;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
    border-radius: 12px;
    height: 85vh;
    display: flex;
    flex-direction: column;
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
}

#dailyReportModal .modal-header {
    background: linear-gradient(135deg, #f8f9fa 0%, #f8f9fa 100%);
    color: #6c757d;
    border-bottom: none;
    border-radius: 12px 12px 0 0;
    flex-shrink: 0;
    position: relative;
    overflow: hidden;
}

#dailyReportModal .modal-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="2" fill="rgba(255,255,255,0.1)"/><circle cx="80" cy="40" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="40" cy="80" r="1.5" fill="rgba(255,255,255,0.1)"/></svg>');
    pointer-events: none;
}

#dailyReportModal .modal-title {
    color: #6c757d;
    font-weight: 700;
    font-size: 1.4rem;
    margin: 0;
    position: relative;
    z-index: 1;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

#dailyReportModal .modal-title::before {
    content: '📊';
    font-size: 1.2rem;
}

#dailyReportModal .modal-header .d-flex {
    position: relative;
    z-index: 1;
}

#dailyReportModal .modal-header .btn {
    padding: 0.6rem 1.5rem;
    font-size: 0.9rem;
    font-weight: 600;
    border-radius: 8px;
    transition: all 0.3s ease;
    border: 2px solid transparent;
    position: relative;
    overflow: hidden;
}

#dailyReportModal .modal-header .btn-secondary {
    background: rgba(255, 255, 255, 0.15);
    color: #6c757d;
    border-color: #94a3b8;
    backdrop-filter: blur(10px);
}

#dailyReportModal .modal-header .btn-secondary:hover {
    background: rgba(255, 255, 255, 0.25);
    border-color: #94a3b8;
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
}

#dailyReportModal .modal-header .btn-primary {
    background: linear-gradient(135deg, #94a3b8 0%, #676767 100%);
    color: white;
    border-color: #94a3b8;
}

#dailyReportModal .modal-header .btn-primary:hover {
    background: linear-gradient(135deg, #94a3b8 0%, #676767 100%);
    border-color: #94a3b8;
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
}

#dailyReportModal .modal-body {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-height: 0;
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    position: relative;
}

/* Week navigation buttons styling */
.week-nav-buttons {
    display: flex;
    gap: 1rem;
    justify-content: center;
    margin-bottom: 2rem;
    padding: 0.5rem;
    background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
    border-radius: 12px;
    border: 1px solid #cbd5e1;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    position: relative;
}

.week-nav-buttons::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: repeating-linear-gradient(
        45deg,
        transparent,
        transparent 20px,
        rgba(59, 130, 246, 0.03) 20px,
        rgba(59, 130, 246, 0.03) 40px
    );
    border-radius: 12px;
    pointer-events: none;
}

.week-nav-buttons .btn {
    font-size: 1rem;
    font-weight: 600;
    padding: 0.8rem 2rem;
    border-radius: 10px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border: 2px solid transparent;
    position: relative;
    z-index: 1;
    min-width: 120px;
    backdrop-filter: blur(10px);
}

.week-nav-buttons .btn-outline-primary {
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    border-color: #94a3b8;
    color: #4a5568;
    box-shadow: 0 4px 12px linear-gradient(135deg, #94a3b8 0%, #676767 100%);
}

.week-nav-buttons .btn-outline-primary:hover {
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    border-color: #94a3b8;
    color: #4a5568;
    transform: translateY(-3px) scale(1.05);
    box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
}

.week-nav-buttons .btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
    transition: left 0.6s;
}

.week-nav-buttons .btn:hover::before {
    left: 100%;
}

/* Daily report table container */
.daily-report-table-container {
    flex: 1;
    background: linear-gradient(135deg, #f8f9fa 0%, #f8f9fa 100%);;
    border-radius: 12px;
    border: 2px solid #e2e8f0;
    box-shadow: 
        0 4px 12px rgba(0, 0, 0, 0.05),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
    overflow: auto !important; /* Force scrollbars to show */
    overflow-x: auto !important;
    overflow-y: auto !important;
    position: relative;
}

.daily-report-table-container::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #3b82f6, #94a3b8, #f59e0b, #ef4444);
    z-index: 1;
}

/* Daily report table styling */
.daily-report-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    margin: 0;
    background: linear-gradient(135deg, #f8f9fa 0%, #f8f9fa 100%);;
    font-size: 0.9rem;
}

.daily-report-table thead {
    position: sticky;
    top: 0;
    z-index: 10;
}

.daily-report-table thead th {
    background: linear-gradient(135deg, #f8f9fa 0%, #f8f9fa 100%);
    color: #6c757d;
    font-weight: 700;
    font-size: 0.85rem;
    text-align: center;
    border: none;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    letter-spacing: 0.5px;
    position: relative;
}

.daily-report-table thead th:first-child {
    border-radius: 0;
    position: sticky;
    left: 0;
    z-index: 15;
    min-width: 200px;
    background: ##e3e3f0;
    border-right: 2px solid rgba(255, 255, 255, 0.2);
}

.daily-report-table thead th:not(:first-child) {
    border-left: 1px solid rgba(0, 0, 0);
}

/* Project cell styling */
.daily-report-table .project-cell {
    position: sticky;
    left: 0;
    z-index: 5;
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    border-right: 2px solid #e2e8f0;
    font-weight: 600;
    color: #1e293b;
    padding: 1rem;
    min-width: 200px;
    max-width: 200px;
    word-wrap: break-word;
    font-size: 0.85rem;
    line-height: 1.4;
}

.daily-report-table tbody td {
    padding: 0.75rem;
    border: 1px solid #f1f5f9;
    background: linear-gradient(135deg, #f8f9fa 0%, #f8f9fa 100%);;
    vertical-align: middle;
    text-align: center;
    transition: all 0.2s ease;
}

.daily-report-table tbody tr:nth-child(even) td:not(.project-cell) {
    background: linear-gradient(135deg, #fafbfc 0%, #f8fafc 100%);
}

.daily-report-table tbody tr:hover td {
    background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
    border-color: #94a3b8;
    transform: translateY(-1px);
}

.daily-report-table tbody tr:hover .project-cell {
    background: linear-gradient(135deg, #f8f9fa 0%, #f8f9fa 100%);
    color: #4a5568;
}

/* Input styling in daily report table */
.daily-report-table input[type="number"] {
    width: 80px;
    padding: 0.5rem;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    font-size: 0.9rem;
    text-align: center;
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    transition: all 0.3s ease;
    font-weight: 500;
}

.daily-report-table input[type="number"]:focus {
    border-color: #94a3b8;
    box-shadow: 
        0 0 0 3px rgba(59, 130, 246, 0.1),
        0 4px 12px linear-gradient(135deg, #94a3b8 0%, #676767 100%);
    outline: none;
    background: linear-gradient(135deg, #f8f9fa 0%, #f8f9fa 100%);;
    transform: scale(1.05);
}

.daily-report-table input[type="number"]:not(:placeholder-shown) {
    background: linear-gradient(135deg, #ecfeff 0%, #cffafe 100%);
    border-color: #94a3b8;
    color: #0e7490;
    font-weight: 600;
}

/* Task type column headers with colors */
.daily-report-table thead th:nth-child(2n+2) {
    background: #e3e3f0;
}

.daily-report-table thead th:nth-child(4n+3) {
    background: #e3e3f0;
}

.daily-report-table thead th:nth-child(4n+4) {
    background: #e3e3f0;
}

.daily-report-table thead th:nth-child(4n+5) {
    background: #e3e3f0;
}

/* Scrollbar styling for daily report table */
.daily-report-table-container::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

.daily-report-table-container::-webkit-scrollbar-track {
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    border-radius: 4px;
}

.daily-report-table-container::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, #cbd5e1 0%, #94a3b8 100%);
    border-radius: 4px;
    border: 1px solid #f8fafc;
}

.daily-report-table-container::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(135deg, #94a3b8 0%, #4a5568 100%);
}

.daily-report-table-container::-webkit-scrollbar-corner {
    background: #f8fafc;
}

/* Loading animation for daily report */
.daily-report-loading {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
    z-index: 20;
}

.daily-report-loading .spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #e2e8f0;
    border-top: 4px solid #3b82f6;
    border-radius: 50%;
    animation: dailyReportSpin 1s linear infinite;
}

.daily-report-loading .loading-text {
    color: #4a5568;
    font-size: 0.9rem;
    font-weight: 500;
}

@keyframes dailyReportSpin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Empty state styling */
.daily-report-empty {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 300px;
    color: #4a5568;
    font-size: 1.1rem;
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    border-radius: 12px;
    border: 2px dashed #cbd5e1;
}

.daily-report-empty::before {
    content: '📝';
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}

/* Button animations */
.week-nav-buttons .btn {
    position: relative;
    overflow: hidden;
}

.week-nav-buttons .btn::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    background: rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    transform: translate(-50%, -50%);
    transition: width 0.6s, height 0.6s;
}

.week-nav-buttons .btn:active::after {
    width: 300px;
    height: 300px;
}

/* Responsive design for daily report modal */
@media (max-width: 1200px) {
    #dailyReportModal .modal-dialog {
        max-width: 95vw;
        margin: 1rem;
    }
    
    #dailyReportModal .modal-content {
        height: 90vh;
    }
    
    .daily-report-table {
        font-size: 0.8rem;
    }
    
    .daily-report-table input[type="number"] {
        width: 70px;
        padding: 0.4rem;
        font-size: 0.8rem;
    }
}

@media (max-width: 768px) {
    #dailyReportModal .modal-dialog {
        margin: 0.5rem;
        max-width: 98vw;
    }
    
    #dailyReportModal .modal-content {
        height: 95vh;
        border-radius: 8px;
    }
    
    #dailyReportModal .modal-header {
        padding: 1rem 1.5rem;
        border-radius: 8px 8px 0 0;
    }
    
    #dailyReportModal .modal-title {
        font-size: 1.2rem;
    }
    
    #dailyReportModal .modal-body {
        padding: 1rem;
    }
    
    .week-nav-buttons {
        flex-direction: column;
        gap: 0.75rem;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    
    .week-nav-buttons .btn {
        min-width: 100%;
        padding: 0.75rem 1.5rem;
        font-size: 0.9rem;
    }
    
    .daily-report-table {
        font-size: 0.75rem;
    }
    
    .daily-report-table thead th {
        padding: 0.75rem 0.5rem;
        font-size: 0.75rem;
    }
    
    .daily-report-table .project-cell {
        min-width: 150px;
        max-width: 150px;
        padding: 0.75rem;
        font-size: 0.75rem;
    }
    
    .daily-report-table tbody td {
        padding: 0.5rem;
    }
    
    .daily-report-table input[type="number"] {
        width: 60px;
        padding: 0.3rem;
        font-size: 0.75rem;
    }
}

@media (max-width: 576px) {
    #dailyReportModal .modal-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
    }
    
    #dailyReportModal .modal-header .d-flex {
        width: 100%;
        justify-content: space-between;
    }
    
    .week-nav-buttons .btn {
        padding: 0.6rem 1rem;
        font-size: 0.8rem;
    }
    
    .daily-report-table .project-cell {
        min-width: 120px;
        max-width: 120px;
        font-size: 0.7rem;
    }
    
    .daily-report-table input[type="number"] {
        width: 50px;
        padding: 0.25rem;
        font-size: 0.7rem;
    }
}

/* Enhanced visual effects */
.daily-report-table tbody tr {
    animation: dailyReportRowFadeIn 0.5s ease-out forwards;
    opacity: 0;
}

.daily-report-table tbody tr:nth-child(1) { animation-delay: 0.1s; }
.daily-report-table tbody tr:nth-child(2) { animation-delay: 0.2s; }
.daily-report-table tbody tr:nth-child(3) { animation-delay: 0.3s; }
.daily-report-table tbody tr:nth-child(4) { animation-delay: 0.4s; }
.daily-report-table tbody tr:nth-child(n+5) { animation-delay: 0.5s; }

@keyframes dailyReportRowFadeIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Success state for inputs with values */
.daily-report-table input[type="number"]:valid:not(:placeholder-shown) {
    background: linear-gradient(135deg, #f8f9fa 0%, #f8f9fa 100%);
    border-color: #94a3b8;
    color: #065f46;
}

/* Focus ring enhancement */
.daily-report-table input[type="number"]:focus-visible {
    outline: 2px solid #3b82f6;
    outline-offset: 2px;
}

/* Print styles for daily report */
@media print {
    #dailyReportModal .modal-header,
    .week-nav-buttons {
        display: none !important;
    }
    
    .daily-report-table-container {
        border: 1px solid #000;
        box-shadow: none;
    }
    
    .daily-report-table {
        background: white !important;
    }
    
    .daily-report-table thead th {
        background: #f0f0f0 !important;
        color: #000 !important;
    }
}
/* === MAIL EDIT MODAL SPECIFIC STYLES === */
/* Mail Edit Modal styling */
.mail-edit-modal .modal-dialog {
    max-width: 1600px;
    width: 98vw;
    margin: 1vh auto;
}

.mail-edit-modal .modal-content {
    border: none;
    box-shadow: 
        0 20px 60px rgba(0, 0, 0, 0.2),
        0 8px 25px rgba(0, 0, 0, 0.1);
    border-radius: 16px;
    height: 92vh;
    display: flex;
    flex-direction: column;
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    overflow: hidden;
}

.mail-edit-modal .modal-header {
    background: linear-gradient(135deg, #f8f9fa 0%, #f8f9fa 100%);
    color: white;
    border-bottom: none;
    border-radius: 16px 16px 0 0;
    padding: 1.5rem 2rem;
    flex-shrink: 0;
    position: relative;
    overflow: hidden;
    display: flex;
    align-items: center;
    gap: 1rem;
}

.mail-edit-modal .modal-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="15" cy="25" r="1.5" fill="rgba(255,255,255,0.08)"/><circle cx="85" cy="15" r="1" fill="rgba(255,255,255,0.06)"/><circle cx="70" cy="85" r="2" fill="rgba(255,255,255,0.04)"/><circle cx="25" cy="75" r="1.2" fill="rgba(255,255,255,0.08)"/></svg>');
    pointer-events: none;
}

.mail-edit-modal .modal-title {
    color: #6c757d;
    font-weight: 700;
    font-size: 1.5rem;
    margin: 0;
    position: relative;
    z-index: 1;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex-shrink: 0;
}

.mail-edit-modal .modal-title::before {
    content: '✉️';
    font-size: 1.3rem;
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
}

/* File input container in header */
.mail-edit-modal .modal-header .d-flex {
    position: relative;
    z-index: 1;
    flex: 1;
    max-width: 400px;
    margin: 0 1rem;
}

.mail-edit-modal .modal-header input[type="file"] {
    background: rgba(255, 255, 255, 0.15);
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 8px;
    color: white;
    font-size: 0.9rem;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
}

.mail-edit-modal .modal-header input[type="file"]:focus {
    background: rgba(255, 255, 255, 0.25);
    border-color: rgba(255, 255, 255, 0.5);
    box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.1);
    outline: none;
}

.mail-edit-modal .modal-header input[type="file"]::file-selector-button {
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
    color: white;
    border: none;
    border-radius: 6px;
    padding: 0.4rem 0.8rem;
    margin-right: 0.8rem;
    font-size: 0.85rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
}

.mail-edit-modal .modal-header input[type="file"]::file-selector-button:hover {
    background: linear-gradient(135deg, #1d4ed8 0%, #4a5568 100%);
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
}

/* Header buttons */
.mail-edit-modal .modal-header .btn {
    padding: 0.7rem 1.5rem;
    font-size: 0.9rem;
    font-weight: 600;
    border-radius: 8px;
    transition: all 0.3s ease;
    border: 2px solid transparent;
    position: relative;
    overflow: hidden;
    white-space: nowrap;
    flex-shrink: 0;
}

.mail-edit-modal .modal-header .btn-outline-primary {
    background: linear-gradient(135deg, #94a3b8 0%, #676767 100%);
    color: #dbeafe;
    border-color: rgba(59, 130, 246, 0.4);
    backdrop-filter: blur(10px);
}

.mail-edit-modal .modal-header .btn-outline-primary:hover {
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    border-color: #1d4ed8;
    color: #4a5568;
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
}

.mail-edit-modal .modal-header .btn-secondary {
    background: rgba(255, 255, 255, 0.15);
    color: #4a5568;
    border-color: rgba(255, 255, 255, 0.3);
    backdrop-filter: blur(10px);
}

.mail-edit-modal .modal-header .btn-secondary:hover {
    background: rgba(255, 255, 255, 0.25);
    border-color: rgba(255, 255, 255, 0.5);
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
}

.mail-edit-modal .modal-body {
    flex: 1;
    padding: 0;
    display: flex;
    flex-direction: column;
    min-height: 0;
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    position: relative;
}

/* Uploaded files section */
.uploaded-files-section {
    background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
    border-bottom: 2px solid #cbd5e1;
    padding: 1.5rem 2rem;
    position: relative;
}

.uploaded-files-section::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: repeating-linear-gradient(
        45deg,
        transparent,
        transparent 30px,
        rgba(59, 130, 246, 0.02) 30px,
        rgba(59, 130, 246, 0.02) 60px
    );
    pointer-events: none;
}

.uploaded-files-section h6 {
    color: #1e293b;
    font-weight: 700;
    font-size: 1.1rem;
    margin-bottom: 1rem;
    position: relative;
    z-index: 1;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.uploaded-files-section h6::before {
    content: '📁';
    font-size: 1rem;
}

#uploadedFilesList {
    position: relative;
    z-index: 1;
    border: none;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
}

#uploadedFilesList .list-group-item {
    border: none;
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    padding: 1.25rem 1.5rem;
    border-bottom: 1px solid #e2e8f0;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

#uploadedFilesList .list-group-item:hover {
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    transform: translateX(3px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

#uploadedFilesList .list-group-item:last-child {
    border-bottom: none;
    border-radius: 0 0 12px 12px;
}

#uploadedFilesList .list-group-item:first-child {
    border-radius: 12px 12px 0 0;
}

#uploadedFilesList .list-group-item.single-item {
    border-radius: 12px;
}

/* File input styling in uploaded files */
#uploadedFilesList .form-control {
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    padding: 0.75rem 1rem;
    font-size: 0.95rem;
    color: #1e293b;
    font-weight: 500;
    transition: all 0.3s ease;
}

#uploadedFilesList .form-control:focus {
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    outline: none;
    background: linear-gradient(135deg, #f8f9fa 0%, #f8f9fa 100%);;
}

/* Action buttons in file list */
#uploadedFilesList .btn {
    padding: 0.6rem 1.2rem;
    font-size: 0.85rem;
    font-weight: 600;
    border-radius: 6px;
    transition: all 0.3s ease;
    border: none;
    position: relative;
    overflow: hidden;
    white-space: nowrap;
}

#uploadedFilesList .btn-success {
    background: linear-gradient(135deg, #94a3b8 0%, #676767 100%);
    color: white;
    box-shadow: 0 2px 6px rgba(16, 185, 129, 0.2);
}

#uploadedFilesList .btn-success:hover {
    background: linear-gradient(135deg, #059669 0%, #047857 100%);
    transform: translateY(-2px);
    box-shadow: 0 6px 15px rgba(16, 185, 129, 0.3);
}

#uploadedFilesList .btn-primary {
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
    color: white;
    box-shadow: 0 2px 6px rgba(59, 130, 246, 0.2);
}

#uploadedFilesList .btn-primary:hover {
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    transform: translateY(-2px);
    box-shadow: 0 6px 15px rgba(59, 130, 246, 0.3);
}

#uploadedFilesList .btn-warning {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    color: #4a5568;
    box-shadow: 0 2px 6px rgba(245, 158, 11, 0.2);
}

#uploadedFilesList .btn-warning:hover {
    background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
    transform: translateY(-2px);
    box-shadow: 0 6px 15px rgba(245, 158, 11, 0.3);
}

/* Replace content section */
.replaced-content-section {
    flex: 1;
    padding: 2rem;
    display: flex;
    flex-direction: column;
    min-height: 0;
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    position: relative;
}

.replaced-content-section::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: 
        radial-gradient(circle at 20% 20%, rgba(59, 130, 246, 0.03) 2px, transparent 2px),
        radial-gradient(circle at 80% 80%, rgba(16, 185, 129, 0.03) 1px, transparent 1px);
    background-size: 50px 50px, 30px 30px;
    pointer-events: none;
}

.replaced-content-section h6 {
    color: #1e293b;
    font-weight: 700;
    font-size: 1.1rem;
    margin-bottom: 1rem;
    position: relative;
    z-index: 1;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.replaced-content-section h6::before {
    content: '📝';
    font-size: 1rem;
}

#mailEditContent {
    flex: 1;
    background: linear-gradient(135deg, #ffffff 0%, #fafbfc 100%);
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    padding: 1.5rem;
    font-size: 0.95rem;
    line-height: 1.6;
    font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
    color: #1e293b;
    resize: none;
    transition: all 0.3s ease;
    box-shadow: 
        0 4px 12px rgba(0, 0, 0, 0.05),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
    min-height: 300px;
    position: relative;
    z-index: 1;
}

#mailEditContent:focus {
    border-color: #3b82f6;
    box-shadow: 
        0 0 0 3px rgba(59, 130, 246, 0.1),
        0 8px 25px linear-gradient(135deg, #94a3b8 0%, #676767 100%);
    outline: none;
    background: linear-gradient(135deg, #f8f9fa 0%, #f8f9fa 100%);;
}

#mailEditContent::placeholder {
    color: #94a3b8;
    font-style: italic;
    font-family: system-ui, -apple-system, sans-serif;
}

/* Button hover effects */
.mail-edit-modal .btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: left 0.5s;
}

.mail-edit-modal .btn:hover::before {
    left: 100%;
}

/* Loading states */
.mail-edit-modal .btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none !important;
}

.mail-edit-modal .btn:disabled::before {
    display: none;
}

/* Empty state styling */
.mail-edit-empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 200px;
    color: #4a5568;
    font-size: 1.1rem;
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    border-radius: 12px;
    border: 2px dashed #cbd5e1;
    margin: 1rem;
}

.mail-edit-empty-state::before {
    content: '📤';
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}

/* Scrollbar styling */
#uploadedFilesList::-webkit-scrollbar,
#mailEditContent::-webkit-scrollbar {
    width: 8px;
}

#uploadedFilesList::-webkit-scrollbar-track,
#mailEditContent::-webkit-scrollbar-track {
    background: #f8fafc;
    border-radius: 4px;
}

#uploadedFilesList::-webkit-scrollbar-thumb,
#mailEditContent::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, #cbd5e1 0%, #94a3b8 100%);
    border-radius: 4px;
    border: 1px solid #f8fafc;
}

#uploadedFilesList::-webkit-scrollbar-thumb:hover,
#mailEditContent::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(135deg, #94a3b8 0%, #4a5568 100%);
}

/* Responsive design for mail edit modal */
@media (max-width: 1200px) {
    .mail-edit-modal .modal-dialog {
        max-width: 95vw;
        margin: 1rem;
    }
    
    .mail-edit-modal .modal-content {
        height: 90vh;
    }
    
    .mail-edit-modal .modal-header {
        flex-wrap: wrap;
        gap: 0.75rem;
        padding: 1.25rem 1.5rem;
    }
    
    .mail-edit-modal .modal-header .d-flex {
        max-width: 300px;
        margin: 0;
    }
    
    .replaced-content-section {
        padding: 1.5rem;
    }
    
    #mailEditContent {
        padding: 1.25rem;
        font-size: 0.9rem;
    }
}

@media (max-width: 768px) {
    .mail-edit-modal .modal-dialog {
        width: 98vw;
        margin: 0.5rem;
    }
    
    .mail-edit-modal .modal-content {
        height: 95vh;
        border-radius: 12px;
    }
    
    .mail-edit-modal .modal-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
        padding: 1rem 1.25rem;
        border-radius: 12px 12px 0 0;
    }
    
    .mail-edit-modal .modal-title {
        font-size: 1.3rem;
    }
    
    .mail-edit-modal .modal-header .d-flex {
        width: 100%;
        max-width: none;
        order: 2;
    }
    
    .mail-edit-modal .modal-header input[type="file"] {
        font-size: 0.85rem;
        padding: 0.5rem 0.75rem;
    }
    
    .mail-edit-modal .modal-header .btn {
        padding: 0.6rem 1rem;
        font-size: 0.85rem;
        order: 3;
    }
    
    .uploaded-files-section {
        padding: 1.25rem 1.5rem;
    }
    
    #uploadedFilesList .list-group-item {
        flex-direction: column;
        gap: 1rem;
        padding: 1rem 1.25rem;
    }
    
    #uploadedFilesList .form-control {
        margin-bottom: 0.75rem;
    }
    
    #uploadedFilesList .btn {
        flex: 1;
        margin: 0 0.25rem;
        font-size: 0.8rem;
        padding: 0.5rem 1rem;
    }
    
    .replaced-content-section {
        padding: 1.25rem;
    }
    
    #mailEditContent {
        padding: 1rem;
        font-size: 0.85rem;
        min-height: 250px;
    }
}

@media (max-width: 576px) {
    .mail-edit-modal .modal-header {
        padding: 0.75rem 1rem;
    }
    
    .mail-edit-modal .modal-title {
        font-size: 1.2rem;
    }
    
    .mail-edit-modal .modal-header input[type="file"] {
        font-size: 0.8rem;
        padding: 0.4rem 0.6rem;
    }
    
    .mail-edit-modal .modal-header .btn {
        padding: 0.5rem 0.8rem;
        font-size: 0.8rem;
    }
    
    .uploaded-files-section {
        padding: 1rem;
    }
    
    .uploaded-files-section h6,
    .replaced-content-section h6 {
        font-size: 1rem;
    }
    
    #uploadedFilesList .list-group-item {
        padding: 0.75rem 1rem;
    }
    
    #uploadedFilesList .btn {
        font-size: 0.75rem;
        padding: 0.4rem 0.8rem;
    }
    
    .replaced-content-section {
        padding: 1rem;
    }
    
    #mailEditContent {
        padding: 0.75rem;
        font-size: 0.8rem;
        min-height: 200px;
    }
}

/* Animation for modal appearance */
.mail-edit-modal .modal-content {
    animation: mailEditModalFadeIn 0.4s ease-out;
}

@keyframes mailEditModalFadeIn {
    from {
        opacity: 0;
        transform: translateY(-30px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

/* File upload animation */
#uploadedFilesList .list-group-item {
    animation: fileItemSlideIn 0.4s ease-out forwards;
    opacity: 0;
}

#uploadedFilesList .list-group-item:nth-child(1) { animation-delay: 0.1s; }
#uploadedFilesList .list-group-item:nth-child(2) { animation-delay: 0.2s; }
#uploadedFilesList .list-group-item:nth-child(3) { animation-delay: 0.3s; }
#uploadedFilesList .list-group-item:nth-child(n+4) { animation-delay: 0.4s; }

@keyframes fileItemSlideIn {
    from {
        opacity: 0;
        transform: translateX(-20px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

/* Focus ring enhancement */
.mail-edit-modal input:focus,
.mail-edit-modal textarea:focus,
.mail-edit-modal .btn:focus {
    outline: 2px solid transparent;
    outline-offset: 2px;
}

/* Success state animation */
@keyframes successPulse {
    0%, 100% { 
        box-shadow: 0 2px 6px rgba(16, 185, 129, 0.2);
    }
    50% { 
        box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
    }
}

.mail-edit-modal .btn-success.processing {
    animation: successPulse 2s infinite;
}

/* Print styles for mail edit modal */
@media print {
    .mail-edit-modal .modal-header {
        display: none !important;
    }
    
    .uploaded-files-section {
        display: none !important;
    }
    
    #mailEditContent {
        border: 1px solid #000;
        box-shadow: none;
        background: white !important;
        font-family: 'Times New Roman', serif;
        font-size: 12pt;
        line-height: 1.5;
    }
}

/* Accessibility improvements */
.mail-edit-modal .btn:focus-visible {
    outline: 2px solid #3b82f6;
    outline-offset: 2px;
}

.mail-edit-modal input:focus-visible,
.mail-edit-modal textarea:focus-visible {
    outline: 2px solid #3b82f6;
    outline-offset: 2px;
}

/* High contrast mode support */
@media (prefers-contrast: high) {
    .mail-edit-modal .modal-header {
        background: #000000;
        color: #ffffff;
    }
    
    .mail-edit-modal .modal-body {
        background: linear-gradient(135deg, #f8f9fa 0%, #f8f9fa 100%);;
        color: #000000;
    }
    
    #uploadedFilesList .list-group-item {
        border: 2px solid #000000;
        background: linear-gradient(135deg, #f8f9fa 0%, #f8f9fa 100%);;
    }
    
    #mailEditContent {
        border: 3px solid #000000;
        background: linear-gradient(135deg, #f8f9fa 0%, #f8f9fa 100%);;
        color: #000000;
    }
}

/* Reduced motion support */
@media (prefers-reduced-motion: reduce) {
    .mail-edit-modal .modal-content,
    #uploadedFilesList .list-group-item,
    .mail-edit-modal .btn,
    #mailEditContent {
        animation: none;
        transition: none;
    }
    
    .mail-edit-modal .btn:hover,
    #uploadedFilesList .list-group-item:hover {
        transform: none;
    }
}
/* === TASK CREATION MODAL SPECIFIC STYLES === */
/* Task Creation Modal styling */
#createTaskModal .modal-dialog {
    max-width: 900px;
    width: 90vw;
}

#createTaskModal .modal-content {
    border: none;
    box-shadow: 
        0 15px 50px rgba(0, 0, 0, 0.2),
        0 5px 20px rgba(0, 0, 0, 0.1);
    border-radius: 16px;
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    overflow: hidden;
}

#createTaskModal .modal-header {
    background: linear-gradient(135deg, #f8f9fa 0%, #f8f9fa 100%);
    color: white;
    border-bottom: none;
    border-radius: 16px 16px 0 0;
    padding: 1.5rem 2rem;
    position: relative;
    overflow: hidden;
}

#createTaskModal .modal-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="30" r="1.5" fill="rgba(255,255,255,0.08)"/><circle cx="75" cy="20" r="1" fill="rgba(255,255,255,0.06)"/><circle cx="60" cy="75" r="2" fill="rgba(255,255,255,0.04)"/><circle cx="30" cy="80" r="1.2" fill="rgba(255,255,255,0.08)"/></svg>');
    pointer-events: none;
}

#createTaskModal .modal-title {
    color: #6c757d;
    font-weight: 700;
    font-size: 1.4rem;
    margin: 0;
    position: relative;
    z-index: 1;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

#createTaskModal .modal-title::before {
    content: '📋';
    font-size: 1.2rem;
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
}

#createTaskModal .modal-header .d-flex {
    position: relative;
    z-index: 1;
}

#createTaskModal .modal-header .btn {
    padding: 0.6rem 1.5rem;
    font-size: 0.9rem;
    font-weight: 600;
    border-radius: 8px;
    transition: all 0.3s ease;
    border: 2px solid transparent;
    position: relative;
    overflow: hidden;
}

#createTaskModal .modal-header .btn-secondary {
    background: rgba(255, 255, 255, 0.15);
    color: white;
    border-color: rgba(255, 255, 255, 0.3);
    backdrop-filter: blur(10px);
}

#createTaskModal .modal-header .btn-secondary:hover {
    background: rgba(255, 255, 255, 0.25);
    border-color: rgba(255, 255, 255, 0.5);
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
}

#createTaskModal .modal-header .btn-primary {
    background: linear-gradient(135deg, #94a3b8 0%, #676767 100%);
    color: white;
    border-color: #059669;
}

#createTaskModal .modal-header .btn-primary:hover {
    background: linear-gradient(135deg, #94a3b8 0%, #676767 100%);
    border-color: #047857;
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
}

#createTaskModal .modal-body {
    padding: 2rem;
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    position: relative;
}

#createTaskModal .modal-body::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: 
        radial-gradient(circle at 25% 25%, rgba(16, 185, 129, 0.03) 2px, transparent 2px),
        radial-gradient(circle at 75% 75%, rgba(59, 130, 246, 0.03) 1px, transparent 1px);
    background-size: 40px 40px, 25px 25px;
    pointer-events: none;
}

/* Form styling */
#createTaskForm {
    position: relative;
    z-index: 1;
}

#createTaskForm .form-label {
    color: #374151;
    font-weight: 600;
    font-size: 1rem;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

#createTaskForm .form-label::before {
    content: '';
    width: 4px;
    height: 20px;
    border-radius: 2px;
    background: linear-gradient(135deg, #94a3b8 0%, #676767 100%);
}

/* File input styling */
#taskExcelFile {
    color: #1e293b;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    position: relative;
    overflow: hidden;
}

#taskExcelFile:focus {
    border-color: #94a3b8;
    box-shadow: 
        0 0 0 3px rgba(16, 185, 129, 0.1),
        0 4px 12px rgba(16, 185, 129, 0.15);
    outline: none;
    background: linear-gradient(135deg, #f8f9fa 0%, #f8f9fa 100%);;
}

#taskExcelFile:hover {
    border-color: #cbd5e1;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
}

#taskExcelFile::file-selector-button {
    background: linear-gradient(135deg, #94a3b8 0%, #676767 100%);
    color: white;
    border: none;
    border-radius: 8px;
    padding: 0.75rem 1.5rem;
    margin-right: 1rem;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

#taskExcelFile::file-selector-button:hover {
    background: linear-gradient(135deg, #059669 0%, #047857 100%);
    transform: translateY(-2px);
    box-shadow: 0 6px 15px rgba(16, 185, 129, 0.3);
}

/* Version input styling */
#version {
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    padding: 0.75rem 1rem;
    font-size: 0.95rem;
    color: #1e293b;
    font-weight: 500;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

#version:focus {
    border-color: #94a3b8;
    box-shadow: 
        0 0 0 3px rgba(16, 185, 129, 0.1),
        0 4px 12px rgba(16, 185, 129, 0.15);
    outline: none;
    background: linear-gradient(135deg, #f8f9fa 0%, #f8f9fa 100%);;
    transform: scale(1.02);
}

#version::placeholder {
    color: #9ca3af;
    font-style: italic;
}

/* Result section styling */
#ticketResult {
    position: relative;
    z-index: 1;
    min-height: 60px;
    border-radius: 12px;
    padding: 1rem;
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    border: 2px dashed #cbd5e1;
    transition: all 0.3s ease;
}

#ticketResult:not(:empty) {
    border-style: solid;
    border-color: #e2e8f0;
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
}

/* Alert styling within result */
#ticketResult .alert {
    border: none;
    border-radius: 10px;
    padding: 1rem 1.25rem;
    margin-bottom: 0;
    font-weight: 500;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
}

#ticketResult .alert-info {
    background: linear-gradient(135deg, #f8f9fa 0%, #f8f9fa 100%);
    color: #4a5568;
    border-left: 4px solid #3b82f6;
}

#ticketResult .alert-success {
    background: linear-gradient(135deg, #f8f9fa 0%, #f8f9fa 100%);
    color: #4a5568;
    border-left: 4px solid #94a3b8;
}

#ticketResult .alert-danger {
    background: linear-gradient(135deg, #fef2f2 0%, #fecaca 100%);
    color: #7f1d1d;
    border-left: 4px solid #ef4444;
}

/* Download button styling */
#ticketResult .btn-success {
    background: linear-gradient(135deg, #94a3b8 0%, #676767 100%);
    color: white;
    border: none;
    border-radius: 8px;
    padding: 0.75rem 1.5rem;
    font-size: 0.9rem;
    font-weight: 600;
    transition: all 0.3s ease;
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);
    position: relative;
    overflow: hidden;
}

#ticketResult .btn-success:hover {
    background: linear-gradient(135deg, #059669 0%, #047857 100%);
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
}

#ticketResult .btn-success::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: left 0.5s;
}

#ticketResult .btn-success:hover::before {
    left: 100%;
}

/* Form group spacing */
#createTaskForm .mb-3 {
    margin-bottom: 1.5rem;
}

#createTaskForm .mb-3:last-child {
    margin-bottom: 0;
}

/* Loading animation */
#createTaskModal .processing {
    position: relative;
}

#createTaskModal .processing::after {
    content: '';
    position: absolute;
    top: 50%;
    right: 1rem;
    transform: translateY(-50%);
    width: 20px;
    height: 20px;
    border: 2px solid #e2e8f0;
    border-top: 2px solid #94a3b8;
    border-radius: 50%;
    animation: taskModalSpin 1s linear infinite;
}

@keyframes taskModalSpin {
    0% { transform: translateY(-50%) rotate(0deg); }
    100% { transform: translateY(-50%) rotate(360deg); }
}

/* Button hover effects */
#createTaskModal .btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: left 0.5s;
}

#createTaskModal .btn:hover::before {
    left: 100%;
}

/* Responsive design for task creation modal */
@media (max-width: 768px) {
    #createTaskModal .modal-dialog {
        width: 95vw;
        margin: 1rem;
    }
    
    #createTaskModal .modal-header {
        padding: 1.25rem 1.5rem;
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
    }
    
    #createTaskModal .modal-title {
        font-size: 1.2rem;
    }
    
    #createTaskModal .modal-header .d-flex {
        width: 100%;
        justify-content: space-between;
    }
    
    #createTaskModal .modal-header .btn {
        padding: 0.5rem 1rem;
        font-size: 0.85rem;
    }
    
    #createTaskModal .modal-body {
        padding: 1.5rem;
    }
    
    #createTaskModal .form-label {
        font-size: 0.95rem;
    }
    
    #taskExcelFile,
    #version {
        font-size: 0.9rem;
        padding: 0.65rem 0.85rem;
    }
    
    #taskExcelFile::file-selector-button {
        padding: 0.6rem 1.2rem;
        font-size: 0.85rem;
    }
    
    #ticketResult {
        padding: 0.75rem;
    }
    
    #ticketResult .alert {
        font-size: 0.9rem;
        padding: 0.85rem 1rem;
    }
    
    #ticketResult .btn-success {
        width: 100%;
        padding: 0.65rem 1rem;
        font-size: 0.85rem;
    }
}

@media (max-width: 576px) {
    #createTaskModal .modal-dialog {
        margin: 0.5rem;
    }
    
    #createTaskModal .modal-header {
        padding: 1rem;
    }
    
    #createTaskModal .modal-title {
        font-size: 1.1rem;
    }
    
    #createTaskModal .modal-header .btn {
        padding: 0.45rem 0.8rem;
        font-size: 0.8rem;
    }
    
    #createTaskModal .modal-body {
        padding: 1rem;
    }
    
    #createTaskModal .form-label {
        font-size: 0.9rem;
    }
    
    #taskExcelFile,
    #version {
        font-size: 0.85rem;
        padding: 0.6rem 0.75rem;
    }
    
    #taskExcelFile::file-selector-button {
        padding: 0.5rem 1rem;
        font-size: 0.8rem;
        margin-right: 0.75rem;
    }
    
    #ticketResult .alert {
        font-size: 0.85rem;
        padding: 0.75rem 0.85rem;
    }
}

/* Animation for modal appearance */
#createTaskModal .modal-content {
    animation: taskModalFadeIn 0.4s ease-out;
}

@keyframes taskModalFadeIn {
    from {
        opacity: 0;
        transform: translateY(-30px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}


#createTaskForm .form-control:valid:not(:placeholder-shown) {
    border-color: #94a3b8;
    box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
}

/* Focus ring enhancement */
#createTaskModal input:focus,
#createTaskModal .btn:focus {
    outline: 2px solid transparent;
    outline-offset: 2px;
}

#createTaskModal input:focus-visible,
#createTaskModal .btn:focus-visible {
    outline: 2px solid #94a3b8;
    outline-offset: 2px;
}

/* Empty state styling */
#ticketResult:empty::before {
    content: '📊 処理結果がここに表示されます';
    color: #9ca3af;
    font-style: italic;
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 60px;
    font-size: 0.9rem;
}

/* Success pulse animation */
@keyframes successPulse {
    0%, 100% { 
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);
    }
    50% { 
        box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
    }
}

#ticketResult .btn-success.processing {
    animation: successPulse 2s infinite;
}

/* Print styles for task creation modal */
@media print {
    #createTaskModal .modal-header {
        background: #f8f9fa !important;
        color: #000 !important;
    }
    
    #createTaskModal .modal-body {
        background: white !important;
    }
    
    #ticketResult {
        border: 1px solid #000;
        background: white !important;
    }
}

/* High contrast mode support */
@media (prefers-contrast: high) {
    #createTaskModal .modal-header {
        background: #000000;
        color: #ffffff;
    }
    
    #createTaskModal .modal-body {
        background: linear-gradient(135deg, #f8f9fa 0%, #f8f9fa 100%);;
        color: #000000;
    }
    
    #taskExcelFile,
    #version {
        border: 3px solid #000000;
        background: linear-gradient(135deg, #f8f9fa 0%, #f8f9fa 100%);;
        color: #6c757d;
    }
    
    #ticketResult {
        border: 3px solid #000000;
        background: linear-gradient(135deg, #f8f9fa 0%, #f8f9fa 100%);;
    }
}

/* Reduced motion support */
@media (prefers-reduced-motion: reduce) {
    #createTaskModal .modal-content,
    #createTaskModal .btn,
    #taskExcelFile,
    #version {
        animation: none;
        transition: none;
    }
    
    #createTaskModal .btn:hover,
    #taskExcelFile:focus,
    #version:focus {
        transform: none;
    }
}

/* Accessibility improvements */
#createTaskModal .form-label {
    cursor: pointer;
}

#createTaskModal .form-control:focus {
    outline: none;
}

/* File input enhancement */
#taskExcelFile::-webkit-file-upload-button {
    background: linear-gradient(135deg, #94a3b8 0%, #676767 100%);
    color: white;
    border: none;
    border-radius: 8px;
    padding: 0.75rem 1.5rem;
    margin-right: 1rem;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

#taskExcelFile::-webkit-file-upload-button:hover {
    background: linear-gradient(135deg, #059669 0%, #047857 100%);
    transform: translateY(-2px);
    box-shadow: 0 6px 15px rgba(16, 185, 129, 0.3);
}

/* Dark mode support (if needed in future) */
@media (prefers-color-scheme: dark) {
    /* Dark mode styles can be added here */
}

/*button todo*/
.dashboard-buttons {
    margin-bottom: 1rem;
}

.dashboard-buttons .btn {
    margin-right: 0.5rem;
    margin-bottom: 0.5rem;
}

#showTodoBtn {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    border: none;
    box-shadow: 0 2px 4px rgba(0,123,255,0.3);
    transition: all 0.2s ease;
}

#showTodoBtn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,123,255,0.4);
}
.btn-settings {
    background: linear-gradient(135deg, #edf2f7 0%, #e2e8f0 100%);
    color: #4a5568;
    border-color: #cbd5e0;
}

.btn-settings:hover {
    background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e0 100%);
    color: #2d3748;
}

/* Settings Modal specific styles */
#settingsModal .modal-content {
    border: none;
    box-shadow: 
        0 15px 50px rgba(0, 0, 0, 0.2),
        0 5px 20px rgba(0, 0, 0, 0.1);
    border-radius: 16px;
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
}

#settingsModal .modal-header {
    background: linear-gradient(135deg, #94a3b8 0%, #4a5568 100%);
    color: white;
    border-bottom: none;
    border-radius: 16px 16px 0 0;
    padding: 1.5rem 2rem;
}

#settingsModal .modal-title {
    color: white;
    font-weight: 700;
    font-size: 1.4rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

#settingsModal .modal-title::before {
    content: '⚙️';
    font-size: 1.2rem;
}

#settingsModal .form-label {
    color: #374151;
    font-weight: 600;
    font-size: 1rem;
    margin-bottom: 0.5rem;
}

#settingsModal .form-control {
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    padding: 0.75rem 1rem;
    font-size: 0.95rem;
    transition: all 0.3s ease;
}

#settingsModal .form-control:focus {
    border-color: #6366f1;
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    outline: none;
    background: linear-gradient(135deg, #f8f9fa 0%, #f8f9fa 100%);;
}

#settingsModal .form-control[readonly] {
    background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
    color: #4a5568;
}

{% endblock %}

{% block content %}
<div class="container-fluid mb-3">
    <div class="d-flex justify-content-between align-items-center flex-wrap">
        <div class="d-flex align-items-center gap-3">
            <!-- Search project name -->
            <div class="input-group" style="width: 300px;">
                <span class="input-group-text">案件名</span>
                <input type="text" class="form-control" id="searchProjectName" placeholder="案件名を入力" aria-label="案件名">
            </div>
            
            <!-- Show unnecessary checkbox -->
            <form id="showUnnecessaryForm" method="POST">
                <div class="form-check d-flex align-items-center">
                    <label class="form-check-label me-2" for="showUnnecessary">不要も表示</label>
                    <input type="checkbox" class="form-check-input" id="showUnnecessary" name="show_unnecessary"
                           {% if show_unnecessary %}checked{% endif %}
                           onchange="document.getElementById('showUnnecessaryForm').submit()">
                </div>
            </form>
        </div>
        <div class="btn-group-professional">
            <!-- Main Action Buttons -->
            <button class="btn btn-professional btn-schedule" 
                    data-bs-toggle="modal" 
                    data-bs-target="#scheduleModal" 
                    onclick="openScheduleModal()">
                <i class="fas fa-calendar-alt"></i>
                <span>予定</span>
            </button>
            
            <button class="btn btn-professional btn-report" 
                    data-bs-toggle="modal" 
                    data-bs-target="#dailyReportModal" 
                    onclick="openDailyReportModal()">
                <i class="fas fa-chart-bar"></i>
                <span>日報</span>
            </button>
            
            <button class="btn btn-professional btn-excel" 
                    data-bs-toggle="modal" 
                    data-bs-target="#uploadModal">
                <i class="fas fa-file-excel"></i>
                <span>Excel</span>
            </button>
            
            <button class="btn btn-professional btn-mail-edit" 
                    data-bs-toggle="modal" 
                    data-bs-target="#mailEditModal">
                <i class="fas fa-envelope-open-text"></i>
                <span>メール編集</span>
            </button>
            
            <button class="btn btn-professional btn-task-create" 
                    data-bs-toggle="modal" 
                    data-bs-target="#createTaskModal">
                <i class="fas fa-tasks"></i>
                <span>タスク作成</span>
            </button>
            <button class="btn btn-professional btn-settings" 
                    data-bs-toggle="modal" 
                    data-bs-target="#settingsModal">
                <i class="fas fa-cog"></i>
                <span>設定</span>
            </button>
            
        </div>

    </div>
</div>


        <div class="dashboard-table-container">
            <table id="dashboardTable" class="table table-bordered table-dashboard">
                <thead>
                    <tr>
                        <th>No</th>
                        <th>操作</th>
                        {% for col in display_columns %}
                            <th class="sortable" data-column="{{ col }}">
                                {{ col }}
                                <span class="sort-indicator"></span>
                            </th>
                        {% endfor %}
                        <th class="sortable" data-column="設計実績">設計実績<span class="sort-indicator"></span></th>
                        <th class="sortable" data-column="テスト実績">テスト実績<span class="sort-indicator"></span></th>
                        <th class="sortable" data-column="FB実績">FB実績<span class="sort-indicator"></span></th>
                        <th class="sortable" data-column="BrSE実績">BrSE実績<span class="sort-indicator"></span></th>
                    </tr>
                </thead>
                <tbody id="projectTableBody">
                    {% for project in projects %}
                        <tr>
                            <td>{{ loop.index }}</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn btn-edit" 
                                            data-bs-toggle="modal"
                                            data-bs-target="#editModal"
                                            onclick='fillEditModal({{ project.id }}, {{ project | tojson | safe }})'
                                            title="編集">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-mail"
                                            data-bs-toggle="modal"
                                            data-bs-target="#mailModal"
                                            onclick='openMailModal({{ project.id }})'
                                            title="メール">
                                        <i class="fas fa-envelope"></i>
                                    </button>
                                    <button class="btn btn-copy"
                                            onclick='copyProjectInfo({{ project | tojson | safe }})'
                                            title="コピー">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                            </td>
                            {% for col in display_columns %}
                                {% set classes = [] %}
                                {% if project.highlight_column == col %}
                                    {% set _ = classes.append('highlight-date') %}
                                {% endif %}
                                {% if project[col + '_past'] %}
                                    {% set _ = classes.append('past-date') %}
                                {% endif %}
                                {% if col == 'FB完了予定日' and project.fb_late %}
                                    {% set _ = classes.append('fb-late') %}
                                {% endif %}
                                <td class="{{ ' '.join(classes) }}" data-fb-late="{{ project.fb_late }}">
                                    {{ project[col] }}
                                </td>
                            {% endfor %}
                            <td>{{ project['設計実績'] }}</td>
                            <td>{{ project['テスト実績'] }}</td>
                            <td>{{ project['FB実績'] }}</td>
                            <td>{{ project['BrSE実績'] }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    
        <div class="modal fade" id="settingsModal" tabindex="-1">
            <div class="modal-dialog modal-dialog-scrollable modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">ユーザー設定</h5>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
                            <button type="button" class="btn btn-primary" onclick="saveUserSettings()">保存</button>
                        </div>
                    </div>
                    <div class="modal-body">
                        <form id="settingsForm">
                            <div class="mb-3">
                                <label for="currentUsername" class="form-label">現在のユーザー名</label>
                                <input type="text" class="form-control" id="currentUsername" readonly>
                            </div>
                            <div class="mb-3">
                                <label for="newUsername" class="form-label">新しいユーザー名</label>
                                <input type="text" class="form-control" id="newUsername" placeholder="新しいユーザー名を入力">
                            </div>
                            <div class="mb-3">
                                <label for="currentPassword" class="form-label">現在のパスワード</label>
                                <input type="password" class="form-control" id="currentPassword" placeholder="現在のパスワードを入力" required>
                            </div>
                            <div class="mb-3">
                                <label for="newPassword" class="form-label">新しいパスワード</label>
                                <input type="password" class="form-control" id="newPassword" placeholder="新しいパスワードを入力">
                            </div>
                            <div class="mb-3">
                                <label for="confirmPassword" class="form-label">新しいパスワード（確認）</label>
                                <input type="password" class="form-control" id="confirmPassword" placeholder="新しいパスワードを再入力">
                            </div>
                        </form>
                        <div id="settingsResult"></div>
                    </div>
                </div>
            </div>
        </div>

    <!-- Schedule Modal -->
    <div class="modal fade" id="scheduleModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-scrollable modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">予定</h5>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
                        <button type="button" class="btn btn-info" onclick="copyScheduleTable()">コピー</button>
                    </div>
                </div>
                <div class="modal-body">
                    <div class="week-nav-buttons">
                        <button class="btn btn-outline-primary" onclick="navigateScheduleWeek('prev')">前週</button>
                        <button class="btn btn-outline-primary" onclick="navigateScheduleWeek('current')">今週</button>
                        <button class="btn btn-outline-primary" onclick="navigateScheduleWeek('next')">次週</button>
                    </div>
                    <div class="week-date-range mt-2" id="weekDateRange"></div>
                    <div class="schedule-table-container">
                        <table class="table table-bordered schedule-table">
                            <thead>
                                <tr>
                                    <th>完了済</th>
                                    <th>日付</th>
                                    <th>タスク</th>
                                    <th>案件名</th>
                                    <th>SE</th>
                                    <th>PH</th>
                                    <th>開発工数（h）</th>
                                </tr>
                            </thead>
                            <tbody id="scheduleTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Modal -->
    <div class="modal fade" id="uploadModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Excelファイルアップロード</h5>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
                        <button type="submit" form="uploadForm" class="btn btn-primary">アップロード</button>
                    </div>
                </div>
                <div class="modal-body">
                    <form id="uploadForm" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="excelFile" class="form-label">Excelファイルを選択 (.xlsx, .xls)</label>
                            <input type="file" class="form-control" id="excelFile" name="file" accept=".xlsx,.xls" required>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Mail Template Upload Modal -->
    <div class="modal fade" id="uploadMailTemplateModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">メールアップロード</h5>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
                        <button type="submit" form="uploadMailTemplateForm" class="btn btn-primary">アップロード</button>
                    </div>
                </div>
                <div class="modal-body">
                    <p>Thay các cụm sau vào trong template mail: </p>
                    <p>{案件名}, {se名}, {pj}, {開発完了}, {SE納品}, {PH}</p>
                    <form id="uploadMailTemplateForm" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="mailTemplateFile" class="form-label">テキストファイルを選択 (.txt)</label>
                            <input type="file" class="form-control" id="mailTemplateFile" name="file" accept=".txt" required>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-scrollable modal-xl">
            <div class="modal-content">
                <form method="POST" id="editForm">
                    <div class="modal-header">
                        <h5 class="modal-title">プロジェクト編集</h5>
                        <div class="d-flex gap-2 align-items-center">
                            <div class="form-check">
                                <input type="checkbox" name="不要" id="edit_不要" class="form-check-input">
                                <label class="form-check-label" for="edit_不要">不要</label>
                            </div>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
                            <button type="submit" class="btn btn-primary">保存</button>
                        </div>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" name="index" id="editIndex">
                        <div class="row">
                            <!-- Column 1 -->
                            <div class="col-12 col-md-3">
                                <div class="mb-3">
                                    <label class="form-label">タスク</label>
                                    <div class="task-checkboxes d-flex flex-wrap">
                                        <div class="form-check">
                                            <input type="checkbox" name="タスク" id="task_設計" value="設計" class="form-check-input">
                                            <label class="form-check-label" for="task_設計">設計</label>
                                        </div>
                                        <div class="form-check">
                                            <input type="checkbox" name="タスク" id="task_Brse" value="Brse" class="form-check-input">
                                            <label class="form-check-label" for="task_Brse">Brse</label>
                                        </div>
                                        <div class="form-check">
                                            <input type="checkbox" name="タスク" id="task_テスト" value="テスト" class="form-check-input">
                                            <label class="form-check-label" for="task_テスト">テスト</label>
                                        </div>
                                        <div class="form-check">
                                            <input type="checkbox" name="タスク" id="task_FB" value="FB" class="form-check-input">
                                            <label class="form-check-label" for="task_FB">FB</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">案件名</label>
                                    <input type="text" name="案件名" id="edit_案件名" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">案件番号</label>
                                    <input type="text" name="案件番号" id="edit_案件番号" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">PJNo.</label>
                                    <input type="text" name="PJNo." id="edit_PJNo." class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">PH</label>
                                    <input type="text" name="PH" id="edit_PH" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">SE</label>
                                    <input type="text" name="SE" id="edit_SE" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">SE(sub)</label>
                                    <input type="text" name="SE(sub)" id="edit_SE(sub)" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">BSE</label>
                                    <input type="text" name="BSE" id="edit_BSE" class="form-control">
                                </div>
                            </div>
                            <!-- Column 2 -->
                            <div class="col-12 col-md-3">
                                <label class="form-label">ステータス</label>
                                    <select name="ステータス" id="edit_ステータス" class="form-select">
                                        {% for status in valid_statuses %}
                                            <option value="{{ status }}">{{ status }}</option>
                                        {% endfor %}
                                    </select>
                                <div class="mb-3">
                                    <label class="form-label">開発工数（h）</label>
                                    <input type="number" name="開発工数（h）" id="edit_開発工数（h）" class="form-control" step="0.1" min="0">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">設計工数（h）</label>
                                    <input type="number" name="設計工数（h）" id="edit_設計工数（h）" class="form-control" step="0.1" min="0">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">ページ数</label>
                                    <input type="number" name="ページ数" id="edit_ページ数" class="form-control" min="1">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">注文項目</label>
                                    <div class="order-checkboxes d-flex flex-wrap">
                                        <div class="form-check">
                                            <input type="checkbox" name="注文設計" id="edit_注文設計" class="form-check-input">
                                            <label class="form-check-label" for="edit_注文設計">注文設計</label>
                                        </div>
                                        <div class="form-check">
                                            <input type="checkbox" name="注文テスト" id="edit_注文テスト" class="form-check-input">
                                            <label class="form-check-label" for="edit_注文テスト">注文テスト</label>
                                        </div>
                                        <div class="form-check">
                                            <input type="checkbox" name="注文FB" id="edit_注文FB" class="form-check-input">
                                            <label class="form-check-label" for="edit_注文FB">注文FB</label>
                                        </div>
                                        <div class="form-check">
                                            <input type="checkbox" name="注文BrSE" id="edit_注文BrSE" class="form-check-input">
                                            <label class="form-check-label" for="edit_注文BrSE">注文BrSE</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Column 3 -->
                            <div class="col-12 col-md-3">
                                <div class="mb-3">
                                    <label class="form-label">要件引継</label>
                                    <input type="date" name="要件引継" id="edit_要件引継" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">設計開始</label>
                                    <input type="date" name="設計開始" id="edit_設計開始" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">設計完了</label>
                                    <input type="date" name="設計完了" id="edit_設計完了" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">設計書送付</label>
                                    <input type="date" name="設計書送付" id="edit_設計書送付" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">開発開始</label>
                                    <input type="date" name="開発開始" id="edit_開発開始" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">開発完了</label>
                                    <input type="date" name="開発完了" id="edit_開発完了" class="form-control">
                                </div>
                            </div>
                            <!-- Column 4 -->
                            <div class="col-12 col-md-3">
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input type="checkbox" name="並行テスト" id="edit_並行テスト" class="form-check-input">
                                        <label class="form-check-label" for="edit_並行テスト">並行テスト</label>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">テスト開始日</label>
                                    <input type="date" name="テスト開始日" id="edit_テスト開始日" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">テスト完了日</label>
                                    <input type="date" name="テスト完了日" id="edit_テスト完了日" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">FB完了予定日</label>
                                    <input type="date" name="FB完了予定日" id="edit_FB完了予定日" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">SE納品</label>
                                    <input type="date" name="SE納品" id="edit_SE納品" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">備考</label>
                                    <textarea name="備考" id="edit_備考" class="form-control"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Copy Modal - Thêm sau Edit Modal -->
    <div class="modal fade" id="copyModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-scrollable modal-xl">
            <div class="modal-content">
                <form method="POST" id="copyForm">
                    <div class="modal-header">
                        <h5 class="modal-title">プロジェクト複写</h5>
                        <div class="d-flex gap-2 align-items-center">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
                            <button type="submit" class="btn btn-primary">複写</button>
                        </div>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <!-- Column 1 -->
                            <div class="col-12 col-md-3">
                                <div class="mb-3">
                                    <label class="form-label">プロジェクト名</label>
                                    <input type="text" name="project_name" id="copy_project_name" class="form-control" placeholder="プロジェクト名を入力">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">タスク</label>
                                    <div class="task-checkboxes d-flex flex-wrap">
                                        <div class="form-check">
                                            <input type="checkbox" name="タスク" id="copy_task_設計" value="設計" class="form-check-input">
                                            <label class="form-check-label" for="copy_task_設計">設計</label>
                                        </div>
                                        <div class="form-check">
                                            <input type="checkbox" name="タスク" id="copy_task_Brse" value="Brse" class="form-check-input">
                                            <label class="form-check-label" for="copy_task_Brse">Brse</label>
                                        </div>
                                        <div class="form-check">
                                            <input type="checkbox" name="タスク" id="copy_task_テスト" value="テスト" class="form-check-input">
                                            <label class="form-check-label" for="copy_task_テスト">テスト</label>
                                        </div>
                                        <div class="form-check">
                                            <input type="checkbox" name="タスク" id="copy_task_FB" value="FB" class="form-check-input">
                                            <label class="form-check-label" for="copy_task_FB">FB</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">案件名</label>
                                    <input type="text" name="案件名" id="copy_案件名" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">案件番号</label>
                                    <input type="text" name="案件番号" id="copy_案件番号" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">PJNo.</label>
                                    <input type="text" name="PJNo." id="copy_PJNo." class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">PH</label>
                                    <input type="text" name="PH" id="copy_PH" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">SE</label>
                                    <input type="text" name="SE" id="copy_SE" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">SE(sub)</label>
                                    <input type="text" name="SE(sub)" id="copy_SE(sub)" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">BSE</label>
                                    <input type="text" name="BSE" id="copy_BSE" class="form-control">
                                </div>
                            </div>
                            <!-- Column 2 -->
                            <div class="col-12 col-md-3">
                                <div class="mb-3">
                                    <label class="form-label">ステータス</label>
                                    <select name="ステータス" id="copy_ステータス" class="form-select">
                                        {% for status in valid_statuses %}
                                            <option value="{{ status }}">{{ status }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">開発工数（h）</label>
                                    <input type="number" name="開発工数（h）" id="copy_開発工数（h）" class="form-control" step="0.1" min="0">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">設計工数（h）</label>
                                    <input type="number" name="設計工数（h）" id="copy_設計工数（h）" class="form-control" step="0.1" min="0">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">ページ数</label>
                                    <input type="number" name="ページ数" id="copy_ページ数" class="form-control" min="1">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">注文項目</label>
                                    <div class="order-checkboxes d-flex flex-wrap">
                                        <div class="form-check">
                                            <input type="checkbox" name="注文設計" id="copy_注文設計" class="form-check-input">
                                            <label class="form-check-label" for="copy_注文設計">注文設計</label>
                                        </div>
                                        <div class="form-check">
                                            <input type="checkbox" name="注文テスト" id="copy_注文テスト" class="form-check-input">
                                            <label class="form-check-label" for="copy_注文テスト">注文テスト</label>
                                        </div>
                                        <div class="form-check">
                                            <input type="checkbox" name="注文FB" id="copy_注文FB" class="form-check-input">
                                            <label class="form-check-label" for="copy_注文FB">注文FB</label>
                                        </div>
                                        <div class="form-check">
                                            <input type="checkbox" name="注文BrSE" id="copy_注文BrSE" class="form-check-input">
                                            <label class="form-check-label" for="copy_注文BrSE">注文BrSE</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Column 3 -->
                            <div class="col-12 col-md-3">
                                <div class="mb-3">
                                    <label class="form-label">要件引継</label>
                                    <input type="date" name="要件引継" id="copy_要件引継" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">設計開始</label>
                                    <input type="date" name="設計開始" id="copy_設計開始" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">設計完了</label>
                                    <input type="date" name="設計完了" id="copy_設計完了" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">設計書送付</label>
                                    <input type="date" name="設計書送付" id="copy_設計書送付" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">開発開始</label>
                                    <input type="date" name="開発開始" id="copy_開発開始" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">開発完了</label>
                                    <input type="date" name="開発完了" id="copy_開発完了" class="form-control">
                                </div>
                            </div>
                            <!-- Column 4 -->
                            <div class="col-12 col-md-3">
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input type="checkbox" name="並行テスト" id="copy_並行テスト" class="form-check-input">
                                        <label class="form-check-label" for="copy_並行テスト">並行テスト</label>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">テスト開始日</label>
                                    <input type="date" name="テスト開始日" id="copy_テスト開始日" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">テスト完了日</label>
                                    <input type="date" name="テスト完了日" id="copy_テスト完了日" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">FB完了予定日</label>
                                    <input type="date" name="FB完了予定日" id="copy_FB完了予定日" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">SE納品</label>
                                    <input type="date" name="SE納品" id="copy_SE納品" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">備考</label>
                                    <textarea name="備考" id="copy_備考" class="form-control"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Mail Modal -->
    <div class="modal fade mail-modal" id="mailModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">メールテンプレート</h5>
                    <div class="d-flex gap-2 align-items-center">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="copyMailCheckbox" onchange="handleCopyMailChange(this)">
                            <label class="form-check-label" for="copyMailCheckbox" title="このテンプレートをプロジェクトにマークします">コピー済み</label>
                        </div>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
                    </div>
                </div>
                <div class="modal-body">
                    <div class="mail-buttons-container">
                        <div class="mail-buttons">
                            {% for full_name, display_name in mail_templates %}
                                <button class="btn"
                                        onclick="loadMailContent(currentProjectId, '{{ full_name }}', this)"
                                        data-filename="{{ full_name }}">
                                    {{ display_name }}
                                </button>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="mail-content-container">
                        <textarea id="mailContent" class="form-control" placeholder="テンプレートを選択してください"></textarea>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Daily Report Modal -->
    <div class="modal fade" id="dailyReportModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-scrollable modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">日報</h5>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
                        <button type="button" class="btn btn-primary" onclick="saveDailyReport()">登録</button>
                    </div>
                </div>
                <div class="modal-body">
                    <div class="week-nav-buttons">
                        <button class="btn btn-outline-primary" onclick="navigateWeek('prev')">前週</button>
                        <button class="btn btn-outline-primary" onclick="navigateWeek('current')">今週</button>
                        <button class="btn btn-outline-primary" onclick="navigateWeek('next')">次週</button>
                    </div>
                    <div class="daily-report-table-container">
                        <table class="daily-report-table">
                            <thead id="dailyReportTableHead"></thead>
                            <tbody id="dailyReportTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Task Modal -->
    <div class="modal fade" id="createTaskModal" tabindex="-1" aria-labelledby="createTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createTaskModalLabel">タスク作成</h5>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
                    <button type="button" class="btn btn-primary" onclick="generateTickets()">チケット発生</button>
                </div>
            </div>
            <div class="modal-body">
                <form id="createTaskForm">
                    <div class="mb-3">
                        <label for="taskExcelFile" class="form-label">設計書 (Excelファイルを選択)</label>
                        <input type="file" class="form-control" id="taskExcelFile" accept=".xlsx,.xls" required>
                    </div>
                    <div class="mb-3">
                        <label for="version" class="form-label">対象バージョン</label>
                        <input type="text" class="form-control" id="version" placeholder="対象バージョンを入力" required>
                    </div>
                </form>
                <div id="ticketResult" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>

    <!-- Update Mail Edit Modal Header -->
    <div class="modal fade mail-edit-modal" id="mailEditModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">メールテンプレート編集</h5>
                    <div class="d-flex align-items-center gap-2 flex-grow-1">
                        <input type="file" class="form-control" id="mailEditFiles" name="files" accept=".txt" multiple onchange="uploadMailEditFiles()">
                    </div>
                    <button type="button" class="btn btn-outline-primary me-2" onclick="openEmailAddressModal()">メールアドレス管理</button>
                    <button type="button" class="btn btn-outline-primary me-2" onclick="openTemplateManagementModal()">テンプレート管理</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="clearTempFiles()">閉じる</button>
                </div>
                <div class="modal-body">
                    <div class="mail-content-container">
                        <div class="uploaded-files-section">
                            <h6>アップロードされたファイル</h6>
                            <ul id="uploadedFilesList" class="list-group mb-3"></ul>
                        </div>
                        <div class="replaced-content-section">
                            <h6>リプレース結果</h6>
                            <textarea id="mailEditContent" class="form-control" placeholder="リプレース結果がここに表示されます"></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- New Email Address Modal -->
    <div class="modal fade" id="emailAddressModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">メールアドレス管理</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <h6>SEおよびSE(sub)メールアドレス</h6>
                        <table class="table table-bordered" id="seEmailTable">
                            <thead>
                                <tr>
                                    <th>名前 (SE/SE(sub))</th>
                                    <th>メールアドレス</th>
                                </tr>
                            </thead>
                            <tbody id="seEmailTableBody"></tbody>
                        </table>
                    </div>
                    <div class="mb-3">
                        <h6>管理者情報</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <label for="managerName" class="form-label">管理者名</label>
                                <input type="text" class="form-control" id="managerName" placeholder="管理者名を入力">
                            </div>
                            <div class="col-md-6">
                                <label for="managerEmail" class="form-label">管理者メールアドレス</label>
                                <input type="text" class="form-control" id="managerEmail" placeholder="メールアドレスを入力">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="saveEmailData()">保存</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="templateManagementModal" tabindex="-1" aria-labelledby="templateManagementModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="templateManagementModalLabel">メールテンプレート管理</h5>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
                </div>
                <div class="modal-body">
                    <ul id="templateFilesList" class="list-group"></ul>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="saveTemplateChanges()">OK</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Overwrite -->
    <div class="modal fade" id="overwriteFileModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">既存のテンプレートを選択</h5>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                        <button type="button" class="btn btn-primary" onclick="confirmOverwrite()">OK</button>
                    </div>
                </div>
                <div class="modal-body">
                    <select id="existingTemplateSelect" class="form-select">
                        <option value="">テンプレートを選択してください</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
 {% endblock %}
{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/encoding-japanese@2.0.0/encoding.min.js"></script>
    <script>
        console.log('JavaScript loaded');

        let currentProjectId = null;
        let sortColumn = null;
        let sortDirection = 'asc';
        let currentWeekStart = null;

        // Thêm hàm normalizeDate vào đầu script section
        function normalizeDate(dateStr) {
            if (!dateStr || dateStr.trim() === '') return '';
            
            let normalized = dateStr.trim();
            const currentYear = new Date().getFullYear();
            
            // Remove text in parentheses first
            normalized = normalized.replace(/\([^)]*\)/g, '').trim();
            
            // Remove time part if exists
            normalized = normalized.split(' ')[0];
            
            // Handle various separators
            normalized = normalized
                .replace(/[\/\.\,\|\_]/g, '-')
                .replace(/[年月日]/g, '-')
                .replace(/\s+/g, '-')
                .replace(/-+/g, '-')
                .replace(/^-|-$/g, '');
            
            let m;
            
            // yyyymmdd (8 digits)
            if (/^\d{8}$/.test(normalized)) {
                return `${normalized.substr(0,4)}-${normalized.substr(4,2)}-${normalized.substr(6,2)}`;
            }
            
            // yyyy-mm-dd (already correct)
            m = normalized.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
            if (m) {
                return `${m[1]}-${m[2].padStart(2, '0')}-${m[3].padStart(2, '0')}`;
            }
            
            // Handle m/dd/yyyy and dd/mm/yyyy patterns
            m = normalized.match(/^(\d{1,2})-(\d{1,2})-(\d{4})$/);
            if (m) {
                const day = parseInt(m[1]);
                const month = parseInt(m[2]);
                const year = parseInt(m[3]);
                
                // Smart detection: if first number > 12, it's day-month-year
                if (day > 12) {
                    // Must be dd-mm-yyyy
                    return `${year}-${m[2].padStart(2, '0')}-${m[1].padStart(2, '0')}`;
                } else if (month > 12) {
                    // Must be mm-dd-yyyy  
                    return `${year}-${m[1].padStart(2, '0')}-${m[2].padStart(2, '0')}`;
                } else {
                    // Ambiguous case - default to mm-dd-yyyy (US format)
                    return `${year}-${m[1].padStart(2, '0')}-${m[2].padStart(2, '0')}`;
                }
            }
            
            // dd-mm-yy
            m = normalized.match(/^(\d{1,2})-(\d{1,2})-(\d{2})$/);
            if (m) {
                const year = parseInt(m[3]) < 50 ? `20${m[3]}` : `19${m[3]}`;
                return `${year}-${m[2].padStart(2, '0')}-${m[1].padStart(2, '0')}`;
            }
            
            // dd-mm (no year)
            m = normalized.match(/^(\d{1,2})-(\d{1,2})$/);
            if (m) {
                return `${currentYear}-${m[2].padStart(2, '0')}-${m[1].padStart(2, '0')}`;
            }
            
            return normalized;
        }

        // Thêm sự kiện focusout cho trường tìm kiếm 案件名
        document.getElementById('searchProjectName').addEventListener('focusout', function() {
            const searchValue = this.value.trim();
            fetchSortedData(sortColumn, sortDirection, searchValue);
        });

        // Sorting functionality
        document.querySelectorAll('.sortable').forEach(header => {
            header.addEventListener('click', function() {
                const column = this.getAttribute('data-column');
                if (sortColumn === column) {
                    sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    sortDirection = 'asc';
                }
                sortColumn = column;
                document.querySelectorAll('.sortable').forEach(h => {
                    h.classList.remove('sort-asc', 'sort-desc');
                });
                this.classList.add(`sort-${sortDirection}`);
                const searchValue = document.getElementById('searchProjectName').value.trim();
                fetchSortedData(column, sortDirection, searchValue);
            });
        });

        function copyProjectInfo(project) {
            fillCopyModal(project);
            const modal = new bootstrap.Modal(document.getElementById('copyModal'));
            modal.show();
        }

        // Thêm function mới để fill dữ liệu vào copy modal
        function fillCopyModal(project) {
            const fields = [
                '案件名', '案件番号', 'PJNo.', 'PH', 'SE', 'SE(sub)', 'BSE', '開発工数（h）', '設計工数（h）', 'ページ数',
                '備考'
            ];
            const dateFields = [
                '要件引継', '設計開始', '設計完了', '設計書送付', '開発開始', '開発完了',
                'テスト開始日', 'テスト完了日', 'FB完了予定日', 'SE納品'
            ];

            // Fill project name field (new)
            const projectNameInput = document.getElementById('copy_project_name');
            if (projectNameInput) {
                // Tạo tên project mới dựa trên project gốc
                const originalName = project['案件名'] || '';
                const copyName = originalName ? `${originalName}_コピー` : 'プロジェクト_コピー';
                projectNameInput.value = copyName;
            }

            // Fill text fields
            fields.forEach(field => {
                const element = document.getElementById(`copy_${field}`);
                if (element) {
                    element.value = project[field] || '';
                }
            });

            // Fill date fields
            dateFields.forEach(field => {
                const element = document.getElementById(`copy_${field}`);
                if (element) {
                    const dateValue = parseDateToYMD(project[field]);
                    element.value = dateValue;
                }
            });

            // Fill task checkboxes
            const taskCheckboxes = ['設計', 'Brse', 'テスト', 'FB'];
            taskCheckboxes.forEach(task => {
                const checkbox = document.getElementById(`copy_task_${task}`);
                if (checkbox) {
                    checkbox.checked = project['タスク'] ? project['タスク'].split(',').includes(task) : false;
                }
            });

            // Fill order checkboxes
            const orderCheckboxes = ['注文設計', '注文テスト', '注文FB', '注文BrSE', '並行テスト'];
            orderCheckboxes.forEach(order => {
                const checkbox = document.getElementById(`copy_${order}`);
                if (checkbox) {
                    checkbox.checked = project[order] === 1 || project[order] === '1' || project[order] === '○';
                }
            });

            // Fill status
            const statusSelect = document.getElementById('copy_ステータス');
            if (statusSelect) {
                statusSelect.value = project['ステータス'] || '要件引継待ち';
            }
        }

        // Thêm event handler cho copy form
        document.getElementById('copyForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            
            // Validate project name
            const projectName = document.getElementById('copy_project_name').value.trim();
            if (!projectName) {
                alert('プロジェクト名を入力してください');
                return;
            }
            
            // Set project name in form data
            formData.set('project_name', projectName);
            
            // Handle task checkboxes
            const taskCheckboxes = document.querySelectorAll('input[name="タスク"]:checked');
            const taskValues = Array.from(taskCheckboxes).map(cb => cb.value);
            formData.set('タスク', taskValues.join(','));
            
            // Handle order checkboxes
            const orderFields = ['注文設計', '注文テスト', '注文FB', '注文BrSE', '並行テスト'];
            orderFields.forEach(field => {
                const checkbox = document.getElementById(`copy_${field}`);
                formData.set(field, checkbox && checkbox.checked ? '1' : '0');
            });
            
            // Submit to copy endpoint
            fetch('/copy_project', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('プロジェクトが正常に複写されました');
                    const modal = bootstrap.Modal.getInstance(document.getElementById('copyModal'));
                    modal.hide();
                    window.location.reload();
                } else {
                    alert('エラー: ' + data.error);
                }
            })
            .catch(error => {
                alert('エラー: プロジェクトの複写に失敗しました - ' + error.message);
            });
        });

        document.getElementById('copy_project_name').addEventListener('blur', function() {
            const projectName = this.value.trim();
            if (!projectName) {
                this.style.borderColor = '#dc3545';
                this.setCustomValidity('プロジェクト名は必須です');
            } else {
                this.style.borderColor = '';
                this.setCustomValidity('');
            }
        });

        // Thêm event listener cho real-time validation
        document.getElementById('copy_project_name').addEventListener('input', function() {
            if (this.value.trim()) {
                this.style.borderColor = '';
                this.setCustomValidity('');
            }
        });

        // Thêm event listeners cho copy modal date inputs
        document.querySelectorAll('#copyModal input[type="date"]').forEach(input => {
            // Copy logic từ edit modal cho date handling
            input.addEventListener('paste', function(e) {
                e.preventDefault();
                let paste = (e.clipboardData || window.clipboardData).getData('text');
                paste = paste.trim();
                if (!paste) return;
                let normalized = paste
                    .replace(/[\/\.]/g, '-')
                    .replace(/[年月日]/g, '-')
                    .replace(/-+/g, '-');
                let m = normalized.match(/^(\d{1,2})-(\d{1,2})-(\d{4})$/);
                if (m) {
                    normalized = `${m[3]}-${m[2].padStart(2, '0')}-${m[1].padStart(2, '0')}`;
                }
                m = normalized.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
                if (m) {
                    normalized = `${m[1]}-${m[2].padStart(2, '0')}-${m[3].padStart(2, '0')}`;
                }
                this.value = normalized;
                this.dispatchEvent(new Event('input', { bubbles: true }));
                this.dispatchEvent(new Event('change', { bubbles: true }));
            });

            input.addEventListener('input', function(e) {
                let val = this.value.trim();
                if (!val) return;
                if (/^\d{4}-\d{2}-\d{2}$/.test(val)) return;
                let normalized = val
                    .replace(/[\/\.]/g, '-')
                    .replace(/[年月日]/g, '-')
                    .replace(/-+/g, '-');
                let m = normalized.match(/^(\d{1,2})-(\d{1,2})-(\d{4})$/);
                if (m) {
                    normalized = `${m[3]}-${m[2].padStart(2, '0')}-${m[1].padStart(2, '0')}`;
                }
                m = normalized.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
                if (m) {
                    normalized = `${m[1]}-${m[2].padStart(2, '0')}-${m[3].padStart(2, '0')}`;
                    this.value = normalized;
                }
            });
        });

        // Thêm logic tự động tính toán ngày cho copy modal
        function updateCopyTestDates() {
            const pageCountInput = document.getElementById('copy_ページ数');
            const testStartInput = document.getElementById('copy_テスト開始日');
            const devCompleteInput = document.getElementById('copy_開発完了');
            const testCompletionInput = document.getElementById('copy_テスト完了日');
            const fbCompletionInput = document.getElementById('copy_FB完了予定日');

            const pageCount = parseInt(pageCountInput.value);
            let testStartDate = null;

            if (testStartInput.value) {
                testStartDate = new Date(testStartInput.value);
            } else if (devCompleteInput.value) {
                testStartDate = new Date(devCompleteInput.value);
                testStartDate.setDate(testStartDate.getDate() + 1);
            }

            if (pageCount > 0 && testStartDate && !isNaN(testStartDate)) {
                const testStartDateYMD = testStartDate.toISOString().split('T')[0];
                fetch('/calculate_test_dates', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        page_count: pageCount,
                        test_start_date: testStartDateYMD
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (!data.error) {
                        testCompletionInput.value = data.test_completion_date || '';
                        fbCompletionInput.value = data.fb_completion_date || '';
                    }
                });
            }
        }

        // Add event listeners cho copy modal
        document.getElementById('copy_ページ数').addEventListener('change', updateCopyTestDates);
        document.getElementById('copy_テスト開始日').addEventListener('change', updateCopyTestDates);
        document.getElementById('copy_開発完了').addEventListener('change', updateCopyTestDates);
        document.getElementById('copy_テスト完了日').addEventListener('change', function() {
            const testCompletionDate = this.value;
            if (testCompletionDate) {
                fetch('/calculate_test_dates', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ test_completion_date: testCompletionDate })
                })
                .then(response => response.json())
                .then(data => {
                    if (!data.error) {
                        document.getElementById('copy_FB完了予定日').value = data.fb_completion_date || '';
                    }
                });
            }
        });

        function fetchSortedData(column, direction, searchProjectName = '') {
            const showUnnecessary = document.getElementById('showUnnecessary').checked;
            fetch('/sort_projects', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    column: column || 'id',
                    direction: direction || 'asc',
                    show_unnecessary: showUnnecessary,
                    search_project_name: searchProjectName
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    alert('エラー: ソートに失敗しました - ' + data.error);
                    return;
                }
                updateTable(data.projects);
            })
            .catch(error => {
                alert('エラー: ソートに失敗しました - ' + error.message);
            });
        }

        function updateTable(projects) {
            const tbody = document.getElementById('projectTableBody');
            tbody.innerHTML = '';

            projects.forEach((project, idx) => {
                const row = document.createElement('tr');

                // Thêm cột No
                const noCell = document.createElement('td');
                noCell.textContent = idx + 1;
                row.appendChild(noCell);

                // Cột 操作 với icons (cập nhật copy button)
                const opCell = document.createElement('td');
                opCell.innerHTML = `
                    <div class="action-buttons">
                        <button class="btn btn-edit"
                                data-bs-toggle="modal"
                                data-bs-target="#editModal"
                                onclick='fillEditModal(${project.id}, ${JSON.stringify(project)})'
                                title="編集">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-mail"
                                data-bs-toggle="modal"
                                data-bs-target="#mailModal"
                                onclick='openMailModal(${project.id})'
                                title="メール">
                            <i class="fas fa-envelope"></i>
                        </button>
                        <button class="btn btn-copy"
                                onclick='copyProjectInfo(${JSON.stringify(project)})'
                                title="複写">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                `;
                row.appendChild(opCell);

                // ...rest of the existing code for other columns...
                const displayColumns = {{ display_columns | tojson | safe }};
                displayColumns.forEach(col => {
                    const cell = document.createElement('td');
                    let classes = [];
                    if (project.highlight_column === col) {
                        classes.push('highlight-date');
                    }
                    if (project[col + '_past']) {
                        classes.push('past-date');
                    }
                    if (col === 'FB完了予定日' && project.fb_late) {
                        classes.push('fb-late');
                    }
                    cell.className = classes.join(' ');
                    cell.setAttribute('data-fb-late', project.fb_late);
                    cell.textContent = project[col] || '';
                    row.appendChild(cell);
                });

                ['設計実績', 'テスト実績', 'FB実績', 'BrSE実績'].forEach(col => {
                    const cell = document.createElement('td');
                    cell.textContent = project[col] || '0';
                    row.appendChild(cell);
                });

                tbody.appendChild(row);
            });
        }

        function updateTestDates() {
            const pageCountInput = document.getElementById('edit_ページ数');
            const testStartInput = document.getElementById('edit_テスト開始日');
            const devCompleteInput = document.getElementById('edit_開発完了');
            const testCompletionInput = document.getElementById('edit_テスト完了日');
            const fbCompletionInput = document.getElementById('edit_FB完了予定日');

            const pageCount = parseInt(pageCountInput.value);
            let testStartDate = null;

            if (testStartInput.value) {
                testStartDate = new Date(testStartInput.value);
            } else if (devCompleteInput.value) {
                testStartDate = new Date(devCompleteInput.value);
                testStartDate.setDate(testStartDate.getDate() + 1);
            }

            if (pageCount > 0 && testStartDate && !isNaN(testStartDate)) {
                const testStartDateYMD = testStartDate.toISOString().split('T')[0];
                fetch('/calculate_test_dates', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        page_count: pageCount,
                        test_start_date: testStartDateYMD
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.error) {
                        testCompletionInput.value = '';
                        fbCompletionInput.value = '';
                    } else {
                        testCompletionInput.value = data.test_completion_date || '';
                        fbCompletionInput.value = data.fb_completion_date || '';
                    }
                })
                .catch(error => {
                    testCompletionInput.value = '';
                    fbCompletionInput.value = '';
                });
            } else {
                testCompletionInput.value = '';
                fbCompletionInput.value = '';
            }
        }

        function parseDateToYMD(dateStr) {
            if (!dateStr || dateStr === '') {
                return '';
            }
            try {
                if (dateStr.includes('(')) {
                    const cleanedDate = dateStr.split('(')[0].replace(/\//g, '-');
                    return cleanedDate;
                }
                if (dateStr.match(/^\d{4}-\d{2}-\d{2}$/)) {
                    return dateStr;
                }
                if (dateStr.match(/^\d{4}\/\d{2}\/\d{2}$/)) {
                    return dateStr.replace(/\//g, '-');
                }
                return '';
            } catch (e) {
                return '';
            }
        }

        function fillEditModal(projectId, project) {
            document.getElementById('editIndex').value = projectId;

            const fields = [
                '案件名', '案件番号', 'PJNo.', 'PH', 'SE', 'SE(sub)', 'BSE', '開発工数（h）', '設計工数（h）', 'ページ数',
                '備考'
            ];
            const dateFields = [
                '要件引継', '設計開始', '設計完了', '設計書送付', '開発開始', '開発完了',
                'テスト開始日', 'テスト完了日', 'FB完了予定日', 'SE納品'
            ];

            fields.forEach(field => {
                const element = document.getElementById(`edit_${field}`);
                if (element) {
                    element.value = project[field] || '';
                }
            });

            dateFields.forEach(field => {
                const element = document.getElementById(`edit_${field}`);
                if (element) {
                    const dateValue = parseDateToYMD(project[field]);
                    element.value = dateValue;
                }
            });

            const taskCheckboxes = ['設計', 'Brse', 'テスト', 'FB'];
            taskCheckboxes.forEach(task => {
                const checkbox = document.getElementById(`task_${task}`);
                if (checkbox) {
                    checkbox.checked = project['タスク'] ? project['タスク'].split(',').includes(task) : false;
                }
            });

            const unnecessaryCheckbox = document.getElementById('edit_不要');
            if (unnecessaryCheckbox) {
                unnecessaryCheckbox.checked = project['不要'] === 1 || project['不要'] === '1';
            }

            const orderCheckboxes = ['注文設計', '注文テスト', '注文FB', '注文BrSE', '並行テスト'];
            orderCheckboxes.forEach(order => {
                const checkbox = document.getElementById(`edit_${order}`);
                if (checkbox) {
                    checkbox.checked = project[order] === 1 || project[order] === '1' || project[order] === '○';
                }
            });

            const statusSelect = document.getElementById('edit_ステータス');
            if (statusSelect) {
                statusSelect.value = project['ステータス'] || '要件引継待ち';
            }

        }

        function openMailModal(projectId) {
            currentProjectId = projectId;
            document.getElementById('mailContent').value = '';
            document.getElementById('copyMailCheckbox').checked = false; // Ensure checkbox is OFF
            document.querySelectorAll('.mail-buttons .btn').forEach(btn => {
                btn.classList.remove('active'); // Ensure no template is selected
            });

            fetch(`/get_copied_templates/${projectId}`)
                .then(response => response.json())
                .then(data => {
                    document.querySelectorAll('.mail-buttons .btn').forEach(btn => {
                        const filename = btn.getAttribute('data-filename');
                        if (data.templates.includes(filename)) {
                            btn.classList.add('copied');
                        } else {
                            btn.classList.remove('copied');
                        }
                    });
                })
                .catch(error => console.error('Error fetching copied templates:', error));
        }

        function loadMailContent(projectId, filename, button) {
            document.querySelectorAll('.mail-buttons .btn').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');

            // Fetch mail content
            fetch(`/get_mail_content/${projectId}/${filename}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert('エラー: ' + data.error);
                    } else {
                        document.getElementById('mailContent').value = data.content;
                    }
                })
                .catch(error => {
                    alert('エラー: メールコンテンツの取得に失敗しました');
                });

            // Update checkbox state based on copied status
            fetch(`/get_copied_templates/${projectId}`)
                .then(response => response.json())
                .then(data => {
                    const checkbox = document.getElementById('copyMailCheckbox');
                    if (data.templates.includes(filename)) {
                        checkbox.checked = true;
                        button.classList.add('copied');
                    } else {
                        checkbox.checked = false;
                        button.classList.remove('copied');
                    }
                })
                .catch(error => {
                    console.error('Error fetching copied templates:', error);
                });
        }



        function deleteAllData() {
            const password = document.getElementById('confirmPassword').value;
            if (!password) {
                alert('パスワードを入力してください');
                return;
            }

            fetch('/delete_all_data', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password: password })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('すべてのデータが正常に削除されました');
                    window.location.reload();
                } else {
                    alert('エラー: ' + data.error);
                }
            })
            .catch(error => {
                alert('エラー: データの削除に失敗しました');
            });
        }

        // Daily Report Functions
        function openDailyReportModal() {
            currentWeekStart = getMonday(new Date());
            loadDailyReportData();
        }

        function getMonday(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }

        function formatDateYMD(date) {
            return date.toISOString().split('T')[0];
        }

        function navigateWeek(direction) {
            const d = new Date(currentWeekStart);
            if (direction === 'prev') {
                d.setDate(d.getDate() - 7);
            } else if (direction === 'next') {
                d.setDate(d.getDate() + 7);
            } else {
                d.setTime(new Date().getTime());
            }
            currentWeekStart = getMonday(d);
            loadDailyReportData();
        }

        function loadDailyReportData() {
            const weekStartStr = formatDateYMD(currentWeekStart);
            fetch(`/get_daily_report_data?week_start=${weekStartStr}`, {
                method: 'GET',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('エラー: 日報データの取得に失敗しました - ' + data.error);
                    return;
                }
                renderDailyReportTable(data.projects, data.week_dates, data.hours);
            })
            .catch(error => {
                alert('エラー: 日報データの取得に失敗しました - ' + error.message);
            });
        }

        function renderDailyReportTable(projects, weekDates, hours) {
            const thead = document.getElementById('dailyReportTableHead');
            const tbody = document.getElementById('dailyReportTableBody');
            thead.innerHTML = '';
            tbody.innerHTML = '';

            // Header row
            const headerRow = document.createElement('tr');
            const projectHeader = document.createElement('th');
            projectHeader.className = 'project-header';
            projectHeader.textContent = '案件名';
            headerRow.appendChild(projectHeader);

            const taskTypes = ['設計', 'テスト', 'FB', 'BrSE'];
            weekDates.forEach(date => {
                const dateTh = document.createElement('th');
                dateTh.colSpan = taskTypes.length;
                dateTh.textContent = date.display;
                headerRow.appendChild(dateTh);
            });
            thead.appendChild(headerRow);

            // Sub-header row
            const subHeaderRow = document.createElement('tr');
            subHeaderRow.appendChild(document.createElement('th')); // Empty cell for project column
            weekDates.forEach(() => {
                taskTypes.forEach(task => {
                    const th = document.createElement('th');
                    th.textContent = task;
                    subHeaderRow.appendChild(th);
                });
            });
            thead.appendChild(subHeaderRow);

            // Data rows
            projects.forEach(project => {
                const row = document.createElement('tr');
                const projectCell = document.createElement('td');
                projectCell.className = 'project-cell';

                // Sửa đoạn này: chỉ hiển thị PH nếu khác null/rỗng
                let ct = project['案件名'] + ' ' + (project['PJNo.'] || '');
                if (project['PH'] !== null && String(project['PH']).trim() !== '') {
                    ct += ' PH' + project['PH'];
                }
                projectCell.textContent = ct.trim();
                row.appendChild(projectCell);

                weekDates.forEach(date => {
                    taskTypes.forEach(task => {
                        const td = document.createElement('td');
                        const input = document.createElement('input');
                        input.type = 'number';
                        input.step = '0.1';
                        input.min = '0';
                        input.className = 'form-control';
                        input.dataset.projectId = project.id;
                        input.dataset.date = date.date;
                        input.dataset.task = task;
                        const hourData = hours.find(h =>
                            h.project_id === project.id &&
                            h.date === date.date &&
                            h.task_type === task
                        );
                        input.value = hourData ? hourData.hours : '';
                        td.appendChild(input);
                        row.appendChild(td);
                    });
                });

                tbody.appendChild(row);
            });
        }

        function saveDailyReport() {
            const inputs = document.querySelectorAll('.daily-report-table input');
            const hoursData = [];
            inputs.forEach(input => {
                const hours = parseFloat(input.value);
                if (!isNaN(hours) && hours > 0) {
                    hoursData.push({
                        project_id: parseInt(input.dataset.projectId),
                        date: input.dataset.date,
                        task_type: input.dataset.task,
                        hours: hours
                    });
                }
            });

            fetch('/save_daily_hours', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ hours: hoursData })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('日報が正常に登録されました');
                    document.getElementById('dailyReportModal').querySelector('.btn-secondary').click();
                    window.location.reload(); // Refresh to update dashboard
                } else {
                    alert('エラー: ' + data.error);
                }
            })
            .catch(error => {
                alert('エラー: 日報の登録に失敗しました');
            });
        }

        document.getElementById('uploadForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.ok) {
                    window.location.reload();
                } else {
                    return response.json().then(data => {
                        throw new Error(data.error || 'アップロードに失敗しました');
                    });
                }
            })
            .catch(error => {
                alert('エラー: ' + error.message);
            });
        });

        document.getElementById('uploadMailTemplateForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            fetch('/upload_mail_template', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('エラー: ' + data.error);
                } else {
                    window.location.reload();
                }
            })
            .catch(error => {
                alert('エラー: アップロードに失敗しました');
            });
        });

        const pageCountInput = document.getElementById('edit_ページ数');
        pageCountInput.addEventListener('input', () => {
            updateTestDates();
        });
        pageCountInput.addEventListener('change', () => {
            updateTestDates();
        });
        pageCountInput.addEventListener('blur', () => {
            updateTestDates();
        });

        document.getElementById('edit_ページ数').addEventListener('change', updateTestDates);
        document.getElementById('edit_テスト開始日').addEventListener('change', updateTestDates);
        document.getElementById('edit_開発完了').addEventListener('change', updateTestDates);

        function openMailEditModal() {
            document.getElementById('mailEditFiles').value = '';
            document.getElementById('uploadedFilesList').innerHTML = '';
            document.getElementById('mailEditContent').value = '';
            window.currentReplacedFilename = null;
            window.currentOverwriteContent = '';
            clearTempFiles(); // Clear temp files when opening modal
        }


        function uploadMailEditFiles() {
            const filesInput = document.getElementById('mailEditFiles');
            const files = filesInput.files;
            if (files.length === 0) {
                alert('ファイルを選択してください');
                return;
            }

            const formData = new FormData();
            for (let i = 0; i < files.length; i++) {
                formData.append('files', files[i]);
            }

            fetch('/upload_mail_edit_files', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const uploadedFilesList = document.getElementById('uploadedFilesList');
                    uploadedFilesList.innerHTML = '';
                    data.filenames.forEach((filename, index) => {
                        const li = document.createElement('li');
                        li.className = 'list-group-item d-flex align-items-center';
                        li.innerHTML = `
                            <input type="text" class="form-control me-2" value="${filename}" data-original="${filename}" data-edited="${filename}" style="flex: 1; max-width: 600px;">
                            <button class="btn btn-success btn-sm me-2" onclick="replaceMailContent('${filename}')">リプレース</button>
                            <button class="btn btn-primary btn-sm me-2" onclick="saveNewFile('${filename}')">追加</button>
                            <button class="btn btn-warning btn-sm" onclick="openOverwriteModal('${filename}')">上書き</button>
                        `;
                        uploadedFilesList.appendChild(li);
                    });

                    // Lưu file đầu tiên làm mặc định
                    window.currentReplacedFilename = data.filenames[0];
                    document.getElementById('mailEditContent').value = '';

                    // Cập nhật tên file khi chỉnh sửa input
                    document.querySelectorAll('#uploadedFilesList input[type="text"]').forEach(input => {
                        input.addEventListener('input', function() {
                            this.dataset.edited = this.value; // Lưu tên đã chỉnh sửa
                            const radio = this.parentElement.querySelector('input[type="radio"]');
                            if (radio.checked) {
                                window.currentReplacedFilename = this.value; // Cập nhật nếu file được chọn
                            }
                        });
                    });

                    // Cập nhật window.currentReplacedFilename khi chọn radio
                    document.querySelectorAll('input[name="selectedFile"]').forEach(radio => {
                        radio.addEventListener('change', function() {
                            const li = this.parentElement;
                            const input = li.querySelector('input[type="text"]');
                            window.currentReplacedFilename = input.dataset.edited || input.dataset.original;
                            // Tùy chọn: Tự động làm mới nội dung
                            replaceMailContent(input.dataset.original);
                        });
                    });

                } else {
                    alert('エラー: ファイルのアップロードに失敗しました - ' + data.error);
                }
            })
            .catch(error => {
                alert('エラー: ファイルのアップロードに失敗しました - ' + error.message);
            });
        }

        function replaceMailContent(filename) {
            fetch('/replace_mail_content', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ filename: filename })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const fileContent = data.results[0];
                    if (fileContent) {
                        const cleanedContent = fileContent.replace(`ファイル: ${filename} (出力エンコーディング: shift-jis)\n`, '')
                                                         .replace(`ファイル: ${filename} (出力エンコーディング: utf-8)\n`, '');
                        document.getElementById('mailEditContent').value = cleanedContent;
                        window.currentOverwriteContent = cleanedContent; // Lưu nội dung đã thay thế

                        // Cập nhật window.currentReplacedFilename từ tên đã chỉnh sửa
                        const fileInput = Array.from(document.querySelectorAll('#uploadedFilesList input[type="text"]'))
                            .find(input => input.dataset.original === filename);
                        if (fileInput) {
                            window.currentReplacedFilename = fileInput.dataset.edited || filename;
                        } else {
                            window.currentReplacedFilename = filename; // Fallback
                        }
                    } else {
                        alert('エラー: 指定されたファイルのリプレース結果が見つかりません');
                    }
                } else {
                    alert('エラー: リプレースに失敗しました - ' + data.error);
                }
            })
            .catch(error => {
                alert('エラー: リプレースに失敗しました - ' + error.message);
            });
        }

        function saveNewFile(originalFilename) {
            const uploadedFilesList = document.getElementById('uploadedFilesList');
            const fileItem = Array.from(uploadedFilesList.querySelectorAll('li')).find(li =>
                li.querySelector('input[data-original]').dataset.original === originalFilename
            );
            if (!fileItem) {
                alert('エラー: ファイルが見つかりません');
                return;
            }

            const filenameInput = fileItem.querySelector('input[type="text"]');
            const filename = filenameInput.value;
            const content = document.getElementById('mailEditContent').value;
            const saveButton = fileItem.querySelector('.btn-success');

            if (!content) {
                alert('リプレース結果がありません。先にリプレースしてください');
                return;
            }

            // Disable button and show loading
            saveButton.disabled = true;
            saveButton.textContent = '保存中...';

            fetch('/save_replaced_file', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ filename: filename, content: content, overwrite: true })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    fileItem.remove();
                    if (uploadedFilesList.children.length === 0) {
                        document.getElementById('mailEditContent').value = '';
                        window.currentReplacedFilename = null;
                        window.currentOverwriteContent = '';
                    }
                    updateMailTemplateList();
                } else {
                    alert('エラー: ファイルの保存に失敗しました - ' + data.error);
                }
            })
            .catch(error => {
                alert('エラー: ファイルの保存に失敗しました - ' + error.message);
            })
            .finally(() => {
                // Re-enable button
                saveButton.disabled = false;
                saveButton.textContent = 'リプレース';
            });
        }

        function openOverwriteModal(originalFilename) {
            const uploadedFilesList = document.getElementById('uploadedFilesList');
            const fileItem = Array.from(uploadedFilesList.querySelectorAll('li')).find(li =>
                li.querySelector('input[data-original]').dataset.original === originalFilename
            );
            if (!fileItem) {
                alert('エラー: 選択されたファイルが見つかりません。再度アップロードしてください。');
                return;
            }

            const filenameInput = fileItem.querySelector('input[type="text"]');
            const filename = filenameInput.value;
            const content = document.getElementById('mailEditContent').value;

            if (!filename) {
                alert('エラー: ファイル名が空です。有効な名前を入力してください。');
                return;
            }

            if (!content) {
                alert('エラー: リプレース結果がありません。先に「リプレース」を実行してください。');
                return;
            }

            // Lưu tên file đã chỉnh sửa và nội dung vào biến toàn cục
            window.currentReplacedFilename = filename;
            window.currentOverwriteContent = content;

            // Lấy danh sách template hiện có
            fetch('/get_mail_template_list')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert('エラー: テンプレートリストの取得に失敗しました - ' + data.error);
                        return;
                    }
                    const select = document.getElementById('existingTemplateSelect');
                    select.innerHTML = '<option value="">テンプレートを選択してください</option>';
                    data.templates.forEach(template => {
                        const option = document.createElement('option');
                        option.value = template;
                        option.textContent = template;
                        select.appendChild(option);
                    });
                    const modal = new bootstrap.Modal(document.getElementById('overwriteFileModal'));
                    modal.show();
                })
                .catch(error => {
                    alert('エラー: テンプレートリストの取得に失敗しました - ' + error.message);
                });
        }

        function updateMailTemplateList() {
            fetch('/get_mail_template_list')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Failed to fetch mail template list:', data.error);
                        return;
                    }
                    // Update the mail buttons in the mailModal if it's open
                    const mailButtonsContainer = document.querySelector('#mailModal .mail-buttons');
                    if (mailButtonsContainer) {
                        mailButtonsContainer.innerHTML = '';
                        data.templates.forEach(template => {
                            const button = document.createElement('button');
                            button.className = 'btn btn-outline-primary mb-2';
                            button.setAttribute('data-filename', template);
                            button.textContent = template.replace('.txt', '');
                            button.onclick = () => loadMailContent(currentProjectId, template, button);
                            mailButtonsContainer.appendChild(button);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error fetching mail template list:', error);
                });
        }

        function confirmOverwrite() {
            const selectedTemplate = document.getElementById('existingTemplateSelect').value;
            if (!selectedTemplate) {
                alert('テンプレートを選択してください');
                return;
            }

            if (!window.currentReplacedFilename) {
                alert('エラー: リプレースされたファイルが見つかりません。ファイルを再度選択してください。');
                return;
            }

            fetch('/delete_mail_template', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ filename: selectedTemplate })
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    alert('エラー: テンプレートの削除に失敗しました - ' + data.error);
                    return Promise.reject(data.error);
                }
                return fetch('/save_replaced_file', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        filename: selectedTemplate,
                        content: window.currentOverwriteContent,
                        overwrite: true
                    })
                });
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const overwriteModal = bootstrap.Modal.getInstance(document.getElementById('overwriteFileModal'));
                    overwriteModal.hide();
                    // Remove the file from the uploaded files list
                    const uploadedFilesList = document.getElementById('uploadedFilesList');
                    const fileItem = Array.from(uploadedFilesList.querySelectorAll('li')).find(li =>
                        li.querySelector('input[data-edited]').dataset.edited === window.currentReplacedFilename
                    );
                    if (fileItem) {
                        fileItem.remove();
                    }
                    // Clear the content if no files remain
                    if (uploadedFilesList.children.length === 0) {
                        document.getElementById('mailEditContent').value = '';
                        window.currentReplacedFilename = null;
                        window.currentOverwriteContent = '';
                    }
                    // Optionally, refresh the mail template list in other modals
                    updateMailTemplateList();
                } else {
                    alert('エラー: ファイルの保存に失敗しました - ' + data.error);
                }
            })
            .catch(error => {
                alert('エラー: 処理に失敗しました - ' + error);
            });
        }

        function downloadReplacedFiles() {
            fetch('/download_replaced_files', {
                method: 'GET'
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.error || 'ダウンロードに失敗しました');
                    });
                }
                return response.blob();
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `replaced_mail_templates.zip`;
                document.body.appendChild(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(url);
                // Clear uploaded files list and content after download
                document.getElementById('uploadedFilesList').innerHTML = '';
                document.getElementById('mailEditContent').value = '';
            })
            .catch(error => {
                alert('エラー: ダウンロードに thất bạiしました - ' + error.message);
            });
        }

        function clearTempFiles() {
            fetch('/clear_temp_files', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('Temp files cleared successfully');
                } else {
                    console.error('Error clearing temp files:', data.error);
                }
            })
            .catch(error => {
                console.error('Error clearing temp files:', error);
            });
        }
        // Cập nhật nội dung khi người dùng chỉnh sửa textarea
        document.getElementById('mailEditContent').addEventListener('input', function() {
            window.currentOverwriteContent = this.value;
        });

        // Tùy chọn: Hiển thị danh sách file nếu hỗ trợ nhiều file
        function updateFileList(filenames) {
            const select = document.createElement('select');
            select.id = 'replacedFileSelect';
            filenames.forEach(filename => {
                const option = document.createElement('option');
                option.value = filename;
                option.text = filename;
                select.appendChild(option);
            });
            select.addEventListener('change', function() {
                window.currentReplacedFilename = this.value;
                replaceMailContent(this.value); // Cập nhật lại nội dung
            });
            const container = document.getElementById('fileListContainer') || document.createElement('div');
            container.id = 'fileListContainer';
            container.innerHTML = '';
            container.appendChild(select);
            document.getElementById('mailEditModal').querySelector('.modal-body').appendChild(container);
        }

        function openTemplateManagementModal() {
            const templateFilesList = document.getElementById('templateFilesList');
            templateFilesList.innerHTML = ''; // Clear existing list

            fetch('/get_mail_template_list')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert('エラー: テンプレートリストの取得に失敗しました - ' + data.error);
                        return;
                    }
                    data.templates.forEach(template => {
                        const li = document.createElement('li');
                        li.className = 'list-group-item d-flex align-items-center';
                        li.innerHTML = `
                            <input type="text" class="form-control me-2" value="${template}" data-original="${template}">
                            <button class="btn btn-danger btn-sm" onclick="deleteTemplateFile(this, '${template}')">削除</button>
                        `;
                        templateFilesList.appendChild(li);
                    });
                })
                .catch(error => {
                    alert('エラー: テンプレートリストの取得に失敗しました - ' + error.message);
                });

            const modal = new bootstrap.Modal(document.getElementById('templateManagementModal'));
            modal.show();
        }

        function deleteTemplateFile(button, filename) {
            if (!confirm(`テンプレート ${filename} を削除しますか？`)) return;

            fetch('/delete_mail_template', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ filename: filename })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(`テンプレート ${filename} が削除されました`);
                        button.closest('li').remove();
                    } else {
                        alert('エラー: テンプレートの削除に失敗しました - ' + data.error);
                    }
                })
                .catch(error => {
                    alert('エラー: テンプレートの削除に失敗しました - ' + error.message);
                });
        }

        function saveTemplateChanges() {
            const templateFilesList = document.getElementById('templateFilesList');
            const renamePromises = Array.from(templateFilesList.querySelectorAll('li')).map(li => {
                const input = li.querySelector('input');
                const originalFilename = input.dataset.original;
                const newFilename = input.value;

                if (originalFilename === newFilename) return Promise.resolve({ success: true });

                console.log(`Renaming ${originalFilename} to ${newFilename}`); // Log request details

                return fetch('/rename_mail_template', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ old_filename: originalFilename, new_filename: newFilename })
                })
                .then(response => {
                    console.log('Response status:', response.status); // Log status
                    console.log('Response headers:', response.headers.get('content-type')); // Log content type
                    return response.text().then(text => ({ response, text })); // Get raw text
                })
                .then(({ response, text }) => {
                    console.log('Raw response:', text); // Log raw response
                    if (!response.ok) {
                        throw new Error(`HTTP error ${response.status}: ${text}`);
                    }
                    try {
                        const data = JSON.parse(text);
                        if (!data.success) {
                            return { success: false, error: `テンプレート ${originalFilename} のリネームに失敗しました - ${data.error}` };
                        }
                        return { success: true };
                    } catch (e) {
                        throw new Error(`Invalid JSON: ${text}`);
                    }
                });
            });

            Promise.all(renamePromises)
                .then(results => {
                    const errors = results.filter(r => !r.success).map(r => r.error);
                    if (errors.length > 0) {
                        alert('一部の変更に失敗しました:\n' + errors.join('\n'));
                    } else {
                        alert('すべての変更が保存されました');
                    }
                    const modal = bootstrap.Modal.getInstance(document.getElementById('templateManagementModal'));
                    modal.hide();
                    updateMailTemplateList();
                })
                .catch(error => {
                    console.error('Save changes error:', error);
                    alert('エラー: 変更の保存に失敗しました - ' + error.message);
                });
        }

        function showConfirmDialog(filename, callback) {
            const modalHtml = `
                <div class="modal fade" id="confirmModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">確認</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                テンプレート「${filename}」のコピー状態を解除しますか？
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                                <button type="button" class="btn btn-primary" id="confirmOk">OK</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
            modal.show();
            document.getElementById('confirmOk').onclick = () => {
                callback(true);
                modal.hide();
            };
            document.getElementById('confirmModal').addEventListener('hidden.bs.modal', () => {
                callback(false);
                document.getElementById('confirmModal').remove();
            }, { once: true });
        }

        function handleCopyMailChange(checkbox) {
            const activeButton = document.querySelector('.mail-buttons .btn.active');
            if (!activeButton) {
                checkbox.checked = false;
                return;
            }

            const filename = activeButton.getAttribute('data-filename');
            if (checkbox.checked) {
                fetch('/save_copied_template', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ project_id: currentProjectId, filename: filename })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        activeButton.classList.add('copied');
                    } else {
                        console.error('Failed to save copied template:', data.error);
                        checkbox.checked = false;
                    }
                })
                .catch(error => {
                    console.error('Error saving copied template:', error);
                    checkbox.checked = false;
                });
            } else if (activeButton.classList.contains('copied')) {
                showConfirmDialog(filename, (confirmed) => {
                    if (confirmed) {
                        fetch('/remove_copied_template', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ project_id: currentProjectId, filename: filename })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                activeButton.classList.remove('copied');
                                checkbox.checked = false;
                            } else {
                                console.error('Failed to remove copied template:', data.error);
                                checkbox.checked = true;
                            }
                        })
                        .catch(error => {
                            console.error('Error removing copied template:', error);
                            checkbox.checked = true;
                        });
                    } else {
                        checkbox.checked = true;
                    }
                });
            }
        }

        // Biến toàn cục để lưu ticketList tạm thời
        window.currentTicketList = null;

        function generateTickets() {
            const fileInput = document.getElementById('taskExcelFile');
            const version = document.getElementById('version').value.trim();
            const resultDiv = document.getElementById('ticketResult');

            if (!fileInput.files[0]) {
                resultDiv.innerHTML = '<div class="alert alert-danger">設計書が存在しません。</div>';
                return;
            }
            if (!version) {
                resultDiv.innerHTML = '<div class="alert alert-danger">対象バージョンを指定してください。</div>';
                return;
            }
            if (fileInput.files[0].size > 100 * 1024 * 1024) {
                resultDiv.innerHTML = '<div class="alert alert-danger">ファイルが大きすぎます（>100MB）。小さいファイルを試してください。</div>';
                return;
            }

            resultDiv.innerHTML = '<div class="alert alert-info">処理中です。少々お待ちください...</div>';

            const worker = new Worker('/static/worker.js');
            worker.onmessage = function(e) {
                const result = e.data;
                if (result.success) {
                    window.currentTicketList = result.ticketList;
                    resultDiv.innerHTML = `
                        <div class="alert alert-success">タスクが作成されました</div>
                        <button class="btn btn-success mt-2" onclick="downloadTicketList()">CSVをダウンロード</button>
                    `;
                } else {
                    resultDiv.innerHTML = `<div class="alert alert-danger">エラー: ${result.error}</div>`;
                }
                worker.terminate();
            };

            worker.postMessage({ file: fileInput.files[0], version: version });
        }

        function downloadTicketList() {
            if (!window.currentTicketList) {
                alert('タスクデータが存在しません。もう一度タスクを作成してください。');
                return;
            }

            const headers = ['トラッカー', 'ステータス', '優先度', '開発拠点', '題名', '担当者', '対象バージョン', '説明'];
            const csvContent = [
                headers.join(','),
                ...window.currentTicketList.map(row => row.map(cell => `"${cell}"`).join(','))
            ].join('\n');

            const utf8Array = new TextEncoder().encode(csvContent);
            const shiftJisArray = Encoding.convert(utf8Array, {
                to: 'SJIS',
                from: 'UTF8'
            });

            const blob = new Blob([new Uint8Array(shiftJisArray)], { type: 'text/csv;charset=shift-jis' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'TicketList.csv';
            a.click();
            URL.revokeObjectURL(url);
        }

        function validateEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email) || email === '';
        }

        function openEmailAddressModal() {
            fetch('/get_email_data')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert('エラー: ' + data.error);
                        return;
                    }
                    // Populate SE and SE(sub) email table
                    const tableBody = document.getElementById('seEmailTableBody');
                    tableBody.innerHTML = '';
                    data.se_emails.forEach(se => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${se.SE}</td>
                            <td><input type="text" class="form-control" value="${se.email || ''}" data-se="${se.SE}"></td>
                        `;
                        tableBody.appendChild(row);
                    });
                    // Populate manager fields
                    document.getElementById('managerName').value = data.manager?.name || '';
                    document.getElementById('managerEmail').value = data.manager?.email || '';
                    // Show modal
                    const modal = new bootstrap.Modal(document.getElementById('emailAddressModal'));
                    modal.show();
                })
                .catch(error => {
                    console.error('Error fetching email data:', error);
                    alert('メールデータの取得に失敗しました');
                });
        }

        function saveEmailData() {
            const seEmails = [];
            const rows = document.querySelectorAll('#seEmailTableBody tr');
            for (const row of rows) {
                const se = row.cells[0].textContent;
                const email = row.cells[1].querySelector('input').value;
                if (email && !validateEmail(email)) {
                    alert(`無効なメールアドレスです: ${se} のメールアドレスを確認してください`);
                    return;
                }
                seEmails.push({ SE: se, email: email });
            }
            const managerEmail = document.getElementById('managerEmail').value;
            if (managerEmail && !validateEmail(managerEmail)) {
                alert('無効な管理者メールアドレスです。メールアドレスを確認してください');
                return;
            }
            const manager = {
                name: document.getElementById('managerName').value,
                email: managerEmail
            };
            fetch('/save_email_data', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ se_emails: seEmails, manager: manager })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('メールデータが正常に保存されました');
                    bootstrap.Modal.getInstance(document.getElementById('emailAddressModal')).hide();
                } else {
                    alert('エラー: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error saving email data:', error);
                alert('メールデータの保存に失敗しました');
            });
        }

        let currentScheduleWeekStart = null;
        const japaneseDays = ['日', '月', '火', '水', '木', '金', '土'];

        function openScheduleModal() {
            currentScheduleWeekStart = getMonday(new Date());
            loadScheduleData();
            updateWeekDateRange();
        }

        function navigateScheduleWeek(direction) {
            const d = new Date(currentScheduleWeekStart || new Date());
            if (direction === 'prev') {
                d.setDate(d.getDate() - 7);
            } else if (direction === 'next') {
                d.setDate(d.getDate() + 7);
            } else {
                d.setTime(new Date().getTime());
            }
            currentScheduleWeekStart = getMonday(d);
            loadScheduleData();
            updateWeekDateRange();
        }

        function formatDateYMD(date) {
            if (!(date instanceof Date) || isNaN(date)) {
                console.error('Invalid date in formatDateYMD:', date);
                date = new Date();
            }
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatDateWithDay(date) {
            if (!(date instanceof Date) || isNaN(date)) {
                console.error('Invalid date in formatDateWithDay:', date);
                date = new Date();
            }
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            const dayName = japaneseDays[date.getDay()];
            return `${day}/${month}/${year}(${dayName})`;
        }

        function getMonday(date) {
            if (!(date instanceof Date) || isNaN(date)) {
                console.error('Invalid date in getMonday:', date);
                date = new Date();
            }
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }

        function updateWeekDateRange() {
            const weekStart = new Date(currentScheduleWeekStart || new Date());
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);
            const rangeText = `${formatDateWithDay(weekStart)}~${formatDateWithDay(weekEnd)}`;
            document.getElementById('weekDateRange').textContent = rangeText;
        }

        function loadScheduleData() {
            if (!currentScheduleWeekStart || isNaN(currentScheduleWeekStart)) {
                console.warn('currentScheduleWeekStart is invalid, resetting to current week');
                currentScheduleWeekStart = getMonday(new Date());
            }
            const weekStartStr = formatDateYMD(currentScheduleWeekStart);
            console.log('Fetching schedule data with week_start:', weekStartStr);
            fetch(`/get_schedule_data?week_start=${weekStartStr}`, {
                method: 'GET',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(`HTTP error! Status: ${response.status}, Message: ${err.error || 'Unknown'}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    console.error('Server error:', data.error);
                    alert('エラー: 予定データの取得に失敗しました - ' + data.error);
                    return;
                }
                renderScheduleTable(data.projects || []);
            })
            .catch(error => {
                console.error('Fetch error:', error);
                alert('エラー: 予定データの取得に失敗しました - ' + error.message);
            });
        }

        function renderScheduleTable(projects) {
            const tbody = document.getElementById('scheduleTableBody');
            tbody.innerHTML = '';

            // Sắp xếp theo date_value (tăng dần)
            const sortedProjects = [...projects].sort((a, b) => {
                const valA = a.date_value || '';
                const valB = b.date_value || '';
                if (!valA || !valB) return valA ? 1 : valB ? -1 : 0;
                try {
                    const [dayA, monthA, yearA] = valA.split('/').map(Number);
                    const [dayB, monthB, yearB] = valB.split('/').map(Number);
                    const dateA = new Date(yearA, monthA - 1, dayA);
                    const dateB = new Date(yearB, monthB - 1, dayB);
                    if (isNaN(dateA) || isNaN(dateB)) return 0;
                    return dateA - dateB; // Tăng dần
                } catch (e) {
                    console.error('Error parsing dates for sorting:', valA, valB, e);
                    return 0;
                }
            });

            sortedProjects.forEach(project => {
                const row = document.createElement('tr');
                const dateDisplay = project.date_value && project.day_name ? `${project.date_value}(${project.day_name})` : project.date_value || '';
                row.innerHTML = `
                    <td>
                        <input type="checkbox"
                               data-project-id="${project.id}"
                               data-date-column="${project.date_column}"
                               ${project.schedule_done ? 'checked' : ''}
                               onchange="updateScheduleDone(this)">
                    </td>
                    <td>${dateDisplay}</td>
                    <td>${project.date_column || ''}</td>
                    <td>${project.案件名 || ''}</td>
                    <td>${project.SE || ''}</td>
                    <td>${project.PH || ''}</td>
                    <td>${project['開発工数（h）'] || ''}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateScheduleDone(checkbox) {
            const projectId = checkbox.dataset.projectId;
            const dateColumn = checkbox.dataset.dateColumn;
            const projects = [{
                id: parseInt(projectId),
                date_column: dateColumn,
                schedule_done: checkbox.checked
            }];
            fetch('/save_schedule_done', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ projects })
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    alert('エラー: ' + data.error);
                }
            })
            .catch(error => {
                alert('エラー: 予定データの保存に失敗しました - ' + error.message);
            });
        }

        function copyScheduleTable() {
            const table = document.querySelector('.schedule-table');
            let csv = '';
            const headers = ['完了済', '日付', 'タスク', '案件名', 'SE', 'PH', '開発工数（h）'];
            csv += headers.join('\t') + '\n';

            const rows = table.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const rowData = [
                    cells[0].querySelector('input').checked ? '✓' : '',
                    cells[1].textContent,
                    cells[2].textContent,
                    cells[3].textContent,
                    cells[4].textContent,
                    cells[5].textContent,
                    cells[6].textContent
                ];
                csv += rowData.join('\t') + '\n';
            });

            navigator.clipboard.writeText(csv)
                .then(() => {
                    alert('表の内容がクリップボードにコピーされました');
                })
                .catch(err => {
                    alert('コピーに失敗しました: ' + err);
                });
        }
        function updateFBCompletionDate() {
            const testCompletionInput = document.getElementById('edit_テスト完了日');
            const fbCompletionInput = document.getElementById('edit_FB完了予定日');
            const testCompletionDate = testCompletionInput.value;

            if (testCompletionDate) {
                // Kiểm tra định dạng ngày
                if (!/^\d{4}-\d{2}-\d{2}$/.test(testCompletionDate)) {
                    console.error('Invalid test completion date format');
                    fbCompletionInput.value = '';
                    return;
                }
                console.debug('Sending calculate_test_dates request for FB completion:', { test_completion_date: testCompletionDate });
                fetch('/calculate_test_dates', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        test_completion_date: testCompletionDate
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.error) {
                        console.error('Error from server:', data.error);
                        fbCompletionInput.value = '';
                    } else {
                        fbCompletionInput.value = data.fb_completion_date || '';
                    }
                })
                .catch(error => {
                    console.error('Fetch error:', error);
                    fbCompletionInput.value = '';
                });
            } else {
                fbCompletionInput.value = '';
            }
        }

        // Gắn sự kiện cho テスト完了日
        document.getElementById('edit_テスト完了日').addEventListener('change', updateFBCompletionDate);

        // ...existing code...

        document.addEventListener('DOMContentLoaded', function() {
            const table = document.querySelector('.table.table-bordered');
            if (!table) return;
            
            const ths = table.querySelectorAll('thead th');
            let left = 0;
            
            // Cập nhật width cho 4 cột đầu (bao gồm cột 操作 đã được thay đổi)
            for (let i = 0; i < 4; i++) {
                ths[i].style.position = 'sticky';
                ths[i].style.left = left + 'px';
                ths[i].style.zIndex = '3';
                left += ths[i].offsetWidth;
            }
            
            // Áp dụng cho từng dòng td
            const trs = table.querySelectorAll('tbody tr');
            trs.forEach(tr => {
                let left = 0;
                for (let i = 0; i < 4; i++) {
                    const td = tr.children[i];
                    if (td) {
                        td.style.position = 'sticky';
                        td.style.left = left + 'px';
                        td.style.zIndex = '2';
                        left += ths[i].offsetWidth;
                    }
                }
            });
        });

        document.querySelectorAll('#editModal input[type="date"]').forEach(input => {
            // Xử lý khi paste
            input.addEventListener('paste', function(e) {
                e.preventDefault();
                let paste = (e.clipboardData || window.clipboardData).getData('text');
                paste = paste.trim();
                if (!paste) return;
                
                // Sử dụng hàm normalizeDate mới
                const normalized = normalizeDate(paste);
                
                // Validate result
                if (/^\d{4}-\d{2}-\d{2}$/.test(normalized)) {
                    this.value = normalized;
                    this.dispatchEvent(new Event('input', { bubbles: true }));
                    this.dispatchEvent(new Event('change', { bubbles: true }));
                }
            });

            // Xử lý khi nhập tay (giữ nguyên như cũ)
            input.addEventListener('input', function(e) {
                let val = this.value.trim();
                if (!val) return;
                if (/^\d{4}-\d{2}-\d{2}$/.test(val)) return;
                let normalized = val
                    .replace(/[\/\.]/g, '-')
                    .replace(/[年月日]/g, '-')
                    .replace(/-+/g, '-');
                let m = normalized.match(/^(\d{1,2})-(\d{1,2})-(\d{4})$/);
                if (m) {
                    normalized = `${m[3]}-${m[2].padStart(2, '0')}-${m[1].padStart(2, '0')}`;
                }
                m = normalized.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
                if (m) {
                    normalized = `${m[1]}-${m[2].padStart(2, '0')}-${m[3].padStart(2, '0')}`;
                    this.value = normalized;
                }
            });
        });

function openSettingsModal() {
    // Lấy username hiện tại từ session
    fetch('/get_current_user')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('currentUsername').value = data.username;
                document.getElementById('newUsername').value = data.username;
            }
        })
        .catch(error => {
            console.error('Error fetching current user:', error);
        });
    
    // Clear form
    document.getElementById('newUsername').value = '';
    document.getElementById('currentPassword').value = '';
    document.getElementById('newPassword').value = '';
    document.getElementById('confirmPassword').value = '';
    document.getElementById('settingsResult').innerHTML = '';
}

function saveUserSettings() {
    const currentPassword = document.getElementById('currentPassword').value;
    const newUsername = document.getElementById('newUsername').value.trim();
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    const resultDiv = document.getElementById('settingsResult');
    
    // Validation
    if (!currentPassword) {
        resultDiv.innerHTML = '<div class="alert alert-danger">現在のパスワードを入力してください</div>';
        return;
    }
    
    if (!newUsername) {
        resultDiv.innerHTML = '<div class="alert alert-danger">新しいユーザー名を入力してください</div>';
        return;
    }
    
    if (newPassword && newPassword !== confirmPassword) {
        resultDiv.innerHTML = '<div class="alert alert-danger">新しいパスワードが一致しません</div>';
        return;
    }
    
    if (newPassword && newPassword.length < 4) {
        resultDiv.innerHTML = '<div class="alert alert-danger">パスワードは4文字以上で入力してください</div>';
        return;
    }
    
    // Show loading
    resultDiv.innerHTML = '<div class="alert alert-info">保存中...</div>';
    
    // Send request
    fetch('/update_user_settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            current_password: currentPassword,
            new_username: newUsername,
            new_password: newPassword
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            resultDiv.innerHTML = '<div class="alert alert-success">設定が正常に保存されました</div>';
            // Update current username display
            document.getElementById('currentUsername').value = newUsername;
            // Clear sensitive fields
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            
            // Auto close modal after 2 seconds
            setTimeout(() => {
                const modal = bootstrap.Modal.getInstance(document.getElementById('settingsModal'));
                modal.hide();
                
                // Show logout message if username changed
                if (data.username_changed) {
                    alert('ユーザー名が変更されました。再ログインしてください。');
                    window.location.href = '/logout';
                }
            }, 2000);
        } else {
            resultDiv.innerHTML = `<div class="alert alert-danger">エラー: ${data.error}</div>`;
        }
    })
    .catch(error => {
        resultDiv.innerHTML = '<div class="alert alert-danger">設定の保存に失敗しました</div>';
        console.error('Error saving settings:', error);
    });
}

// Add event listener to open settings modal
document.addEventListener('DOMContentLoaded', function() {
    const settingsBtn = document.querySelector('.btn-settings');
    if (settingsBtn) {
        settingsBtn.addEventListener('click', openSettingsModal);
    }
});
    </script>
{% endblock %}