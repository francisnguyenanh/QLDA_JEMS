<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>プロジェクト管理</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .past-date { background-color: #f0f0f0 !important; }
        .highlight-date { background-color: yellow !important; color: red !important; }
        .fb-late { background-color: red !important; color: white !important; }
        th, td { white-space: nowrap; }
        th:nth-child(1), td:nth-child(1) { width: 100px; }
        th:nth-child(2), td:nth-child(2) { width: 150px; }
        th:nth-child(3), td:nth-child(3) { width: 300px; }
        th:nth-child(17), td:nth-child(17) { width: 100px; }
        th:nth-child(19), td:nth-child(19) { width: 150px; }
        th:nth-child(5), td:nth-child(5) { width: 120px; }
        th:nth-child(6), td:nth-child(6) { width: 120px; }
        th:nth-child(21), td:nth-child(21) { width: 100px; }
        th:nth-child(22), td:nth-child(22) { width: 200px; }
        .modal-body .row { margin-left: -10px; margin-right: -10px; }
        .modal-body .col-md-3 { padding-left: 10px; padding-right: 10px; }
        .task-checkboxes .form-check { margin-right: 10px; }
        .form-label { font-size: 0.9rem; }
        .form-control, .form-check-input { font-size: 0.9rem; }
        textarea.form-control { resize: vertical; min-height: 60px; }

        @media (min-width: 768px) { /* md以上の画面サイズに適用 */
            .modal-body .col-md-3:nth-child(1) {
                flex: 0 0 auto;
                width: 30%; /* 幅を30%に広げる例 */
            }
            .modal-body .col-md-3:nth-child(2) {
                flex: 0 0 auto;
                width: 23.333333%; /* 他の列とのバランスを見て調整 */
            }
            .modal-body .col-md-3:nth-child(3) {
                flex: 0 0 auto;
                width: 23.333333%; /* 他の列とのバランスを見て調整 */
            }
            .modal-body .col-md-3:nth-child(4) {
                flex: 0 0 auto;
                width: 23.333333%; /* 他の列とのバランスを見て調整 */
            }
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="d-flex justify-content-between mb-3">
            <h2>プロジェクト管理</h2>
            <a href="{{ url_for('logout') }}" class="btn btn-danger">ログアウト</a>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>操作</th>
                    {% for col in display_columns %}
                        <th>{{ col }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for project in projects %}
                    <tr>
                        <td>
                            <button class="btn btn-primary btn-sm"
                                    data-bs-toggle="modal"
                                    data-bs-target="#editModal"
                                    onclick='fillEditModal({{ project.id }}, {{ project | tojson | safe }})'>
                                編集
                            </button>
                        </td>
                        {% for col in display_columns %}
                            {% set classes = [] %}
                            {% if project.highlight_column == col %}
                                {% set _ = classes.append('highlight-date') %}
                            {% endif %}
                            {% if project[col + '_past'] %}
                                {% set _ = classes.append('past-date') %}
                            {% endif %}
                            {% if col == 'FB完了予定日' and project.fb_late is sameas true %}
                                {% set _ = classes.append('fb-late') %}
                            {% endif %}
                            <td class="{{ ' '.join(classes) }}" data-fb-late="{{ project.fb_late }}">
                                {{ project[col] }}
                            </td>
                        {% endfor %}
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Edit Modal -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <form method="POST">
                    <div class="modal-header">
                        <h5 class="modal-title">プロジェクト編集</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" name="index" id="editIndex">
                        <div class="row">
                            <!-- Column 1 -->
                            <div class="col-md-3">
                                <!-- タスク -->
                                <div class="mb-3">
                                    <label class="form-label">タスク</label>
                                    <div class="task-checkboxes d-flex">
                                        <div class="form-check">
                                            <input type="checkbox" name="タスク"
                                                   id="task_設計" value="設計"
                                                   class="form-check-input" checked>
                                            <label class="form-check-label" for="task_設計">設計</label>
                                        </div>
                                        <div class="form-check">
                                            <input type="checkbox" name="タスク"
                                                   id="task_Brse" value="Brse"
                                                   class="form-check-input">
                                            <label class="form-check-label" for="task_Brse">Brse</label>
                                        </div>
                                        <div class="form-check">
                                            <input type="checkbox" name="タスク"
                                                   id="task_テスト" value="テスト"
                                                   class="form-check-input">
                                            <label class="form-check-label" for="task_テスト">テスト</label>
                                        </div>
                                        <div class="form-check">
                                            <input type="checkbox" name="タスク"
                                                   id="task_FB" value="FB"
                                                   class="form-check-input">
                                            <label class="form-check-label" for="task_FB">FB</label>
                                        </div>
                                    </div>
                                </div>
                                <!-- 案件名 -->
                                <div class="mb-3">
                                    <label class="form-label">案件名</label>
                                    <input type="text" name="案件名"
                                           id="edit_案件名" class="form-control">
                                </div>
                                <!-- 案件番号 -->
                                <div class="mb-3">
                                    <label class="form-label">案件番号</label>
                                    <input type="text" name="案件番号"
                                           id="edit_案件番号" class="form-control">
                                </div>
                                <!-- PJNo. -->
                                <div class="mb-3">
                                    <label class="form-label">PJNo.</label>
                                    <input type="text" name="PJNo."
                                           id="edit_PJNo." class="form-control">
                                </div>
                                <!-- PH -->
                                <div class="mb-3">
                                    <label class="form-label">PH</label>
                                    <input type="text" name="PH"
                                           id="edit_PH" class="form-control">
                                </div>
                                <!-- SE -->
                                <div class="mb-3">
                                    <label class="form-label">SE</label>
                                    <input type="text" name="SE"
                                           id="edit_SE" class="form-control">
                                </div>
                                <!-- BSE -->
                                <div class="mb-3">
                                    <label class="form-label">BSE</label>
                                    <input type="text" name="BSE"
                                           id="edit_BSE" class="form-control">
                                </div>
                            </div>
                            <!-- Column 2 -->
                            <div class="col-md-3">
                                <!-- 開発工数（h） -->
                                <div class="mb-3">
                                    <label class="form-label">開発工数（h）</label>
                                    <input type="text" name="開発工数（h）"
                                           id="edit_開発工数（h）" class="form-control">
                                </div>
                                <!-- 設計工数（h） -->
                                <div class="mb-3">
                                    <label class="form-label">設計工数（h）</label>
                                    <input type="text" name="設計工数（h）"
                                           id="edit_設計工数（h）" class="form-control">
                                </div>
                                <!-- ページ数 -->
                                <div class="mb-3">
                                    <label class="form-label">ページ数</label>
                                    <input type="number" name="ページ数"
                                           id="edit_ページ数" class="form-control" min="1">
                                </div>
                            </div>
                            <!-- Column 3 -->
                            <div class="col-md-3">
                                <!-- 要件引継 -->
                                <div class="mb-3">
                                    <label class="form-label">要件引継</label>
                                    <input type="date" name="要件引継"
                                           id="edit_要件引継" class="form-control">
                                </div>
                                <!-- 設計開始 -->
                                <div class="mb-3">
                                    <label class="form-label">設計開始</label>
                                    <input type="date" name="設計開始"
                                           id="edit_設計開始" class="form-control">
                                </div>
                                <!-- 設計完了 -->
                                <div class="mb-3">
                                    <label class="form-label">設計完了</label>
                                    <input type="date" name="設計完了"
                                           id="edit_設計完了" class="form-control">
                                </div>
                                <!-- 設計書送付 -->
                                <div class="mb-3">
                                    <label class="form-label">設計書送付</label>
                                    <input type="date" name="設計書送付"
                                           id="edit_設計書送付" class="form-control">
                                </div>
                                <!-- 開発開始 -->
                                <div class="mb-3">
                                    <label class="form-label">開発開始</label>
                                    <input type="date" name="開発開始"
                                           id="edit_開発開始" class="form-control">
                                </div>
                                <!-- 開発完了 -->
                                <div class="mb-3">
                                    <label class="form-label">開発完了</label>
                                    <input type="date" name="開発完了"
                                           id="edit_開発完了" class="form-control">
                                </div>
                            </div>
                            <!-- Column 4 -->
                            <div class="col-md-3">
                                <!-- テスト開始日 -->
                                <div class="mb-3">
                                    <label class="form-label">テスト開始日</label>
                                    <input type="date" name="テスト開始日"
                                           id="edit_テスト開始日" class="form-control">
                                </div>
                                <!-- テスト完了日 -->
                                <div class="mb-3">
                                    <label class="form-label">テスト完了日</label>
                                    <input type="date" name="テスト完了日"
                                           id="edit_テスト完了日" class="form-control" readonly>
                                </div>
                                <!-- FB完了予定日 -->
                                <div class="mb-3">
                                    <label class="form-label">FB完了予定日</label>
                                    <input type="date" name="FB完了予定日"
                                           id="edit_FB完了予定日" class="form-control" readonly>
                                </div>
                                <!-- SE納品 -->
                                <div class="mb-3">
                                    <label class="form-label">SE納品</label>
                                    <input type="date" name="SE納品"
                                           id="edit_SE納品" class="form-control">
                                </div>
                                <!-- 備考 -->
                                <div class="mb-3">
                                    <label class="form-label">備考</label>
                                    <textarea name="備考" id="edit_備考"
                                              class="form-control"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
                        <button type="submit" class="btn btn-primary">保存</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Dynamically inject ranges from server
        const ranges = [
            {% for from_page, to_page, days in ranges %}
                { from: {{ from_page }}, to: {{ to_page }}, days: {{ days }} }{% if not loop.last %},{% endif %}
            {% endfor %}
        ];

        function fillEditModal(index, project) {
            console.log('Project ID:', index, 'fb_late:', project.fb_late, 'type:', typeof project.fb_late);
            document.getElementById('editIndex').value = index;

            {% for col in display_columns %}
                {% if col in date_columns %}
                    let dateValue_{{ col|replace(' ', '_') }} = project['{{ col }}'];
                    if (dateValue_{{ col|replace(' ', '_') }} && dateValue_{{ col|replace(' ', '_') }} !== '') {
                        dateValue_{{ col|replace(' ', '_') }} = dateValue_{{ col|replace(' ', '_') }}.split('(')[0].replace(/\//g, '-');
                    } else {
                        dateValue_{{ col|replace(' ', '_') }} = '';
                    }
                    document.getElementById('edit_{{ col|replace(' ', '_') }}').value = dateValue_{{ col|replace(' ', '_') }};
                {% elif col == 'タスク' %}
                    let tasks = project['{{ col }}'] ? project['{{ col }}'].split(',') : [];
                    document.getElementById('task_設計').checked = tasks.includes('設計') || !project['{{ col }}'];
                    document.getElementById('task_Brse').checked = tasks.includes('Brse');
                    document.getElementById('task_テスト').checked = tasks.includes('テスト');
                    document.getElementById('task_FB').checked = tasks.includes('FB');
                {% else %}
                    document.getElementById('edit_{{ col|replace(' ', '_') }}').value = project['{{ col }}'] != null ? project['{{ col }}'] : '';
                {% endif %}
            {% endfor %}

            updateTestStartDate();
            updateTestCompletionDate();
            updateFBCompletionDate();
        }

        function updateTestStartDate() {
            const devCompleteInput = document.getElementById('edit_開発完了');
            const testStartInput = document.getElementById('edit_テスト開始日');
            const devCompleteValue = devCompleteInput.value;

            if (devCompleteValue) {
                try {
                    const devCompleteDate = new Date(devCompleteValue);
                    if (!isNaN(devCompleteDate)) {
                        devCompleteDate.setDate(devCompleteDate.getDate() + 1);
                        const year = devCompleteDate.getFullYear();
                        const month = String(devCompleteDate.getMonth() + 1).padStart(2, '0');
                        const day = String(devCompleteDate.getDate()).padStart(2, '0');
                        testStartInput.value = `${year}-${month}-${day}`;
                    } else {
                        testStartInput.value = '';
                    }
                } catch (e) {
                    testStartInput.value = '';
                }
            } else {
                testStartInput.value = '';
            }
            updateTestCompletionDate();
        }

        function updateTestCompletionDate() {
            const pageCountInput = document.getElementById('edit_ページ数');
            const testStartInput = document.getElementById('edit_テスト開始日');
            const testCompleteInput = document.getElementById('edit_テスト完了日');
            const pageCount = parseInt(pageCountInput.value);
            const testStartDate = testStartInput.value;

            if (!pageCount || !testStartDate) {
                testCompleteInput.value = '';
                updateFBCompletionDate();
                return;
            }

            let workingDays = 0;
            for (let range of ranges) {
                if (pageCount >= range.from && pageCount <= range.to) {
                    workingDays = range.days;
                    break;
                }
            }

            if (workingDays === 0) {
                testCompleteInput.value = '';
                updateFBCompletionDate();
                return;
            }

            try {
                let currentDate = new Date(testStartDate);
                let daysAdded = 0;
                while (daysAdded < workingDays) {
                    currentDate.setDate(currentDate.getDate() + 1);
                    if (currentDate.getDay() !== 0 && currentDate.getDay() !== 6) {
                        daysAdded++;
                    }
                }
                const year = currentDate.getFullYear();
                const month = String(currentDate.getMonth() + 1).padStart(2, '0');
                const day = String(currentDate.getDate()).padStart(2, '0');
                testCompleteInput.value = `${year}-${month}-${day}`;
            } catch (e) {
                testCompleteInput.value = '';
            }
            updateFBCompletionDate();
        }

        function updateFBCompletionDate() {
            const testCompleteInput = document.getElementById('edit_テスト完了日');
            const fbCompleteInput = document.getElementById('edit_FB完了予定日');
            const testCompleteDate = testCompleteInput.value;

            if (!testCompleteDate) {
                fbCompleteInput.value = '';
                return;
            }

            try {
                let currentDate = new Date(testCompleteDate);
                let daysAdded = 0;
                const workingDays = 9; // Fixed 9 working days for FB
                while (daysAdded < workingDays) {
                    currentDate.setDate(currentDate.getDate() + 1);
                    if (currentDate.getDay() !== 0 && currentDate.getDay() !== 6) {
                        daysAdded++;
                    }
                }
                const year = currentDate.getFullYear();
                const month = String(currentDate.getMonth() + 1).padStart(2, '0');
                const day = String(currentDate.getDate()).padStart(2, '0');
                fbCompleteInput.value = `${year}-${month}-${day}`;
            } catch (e) {
                fbCompleteInput.value = '';
            }
        }

        document.getElementById('edit_開発完了').addEventListener('change', updateTestStartDate);
        document.getElementById('edit_テスト開始日').addEventListener('change', updateTestCompletionDate);
        document.getElementById('edit_ページ数').addEventListener('change', updateTestCompletionDate);
        document.getElementById('edit_テスト完了日').addEventListener('change', updateFBCompletionDate);
    </script>
</body>
</html>