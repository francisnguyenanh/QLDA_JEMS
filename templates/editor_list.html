{% extends "layout.html" %}
{% block navbar_content %}
<ul class="navbar-nav me-auto">
    <li class="nav-item">
        <a class="nav-link" href="/dashboard">Dashboard</a>
    </li>
    <li class="nav-item">
        <a class="nav-link active" href="/editor_list">Documents list</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" href="/editor">Editor</a>
    </li>
</ul>
<div class="d-flex">
    <a href="{{ url_for('logout') }}" class="btn btn-danger btn-sm">Logout</a>
</div>
{% endblock %}
{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Documents</h2>
        <a href="{{ url_for('editor') }}" class="btn btn-primary">New Document</a>
    </div>
    
    <div id="documentsContainer">
    
    {% if documents %}
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Title</th>
                        <th>Created</th>
                        <th>Updated</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for doc in documents %}
                    <tr>
                        <td>{{ doc.title }}</td>
                        <td>{{ doc.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                        <td>{{ doc.updated_at.strftime('%Y-%m-%d %H:%M') }}</td>
                        <td>
                            <a href="{{ url_for('edit_editor_document', id=doc.id) }}" class="btn btn-sm btn-outline-primary">Edit</a>
                            <a href="{{ url_for('delete_editor_document', id=doc.id) }}" 
                               class="btn btn-sm btn-outline-danger"
                               onclick="return confirm('Are you sure you want to delete this document?')">Delete</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div class="alert alert-info">
            No documents found. <a href="{{ url_for('editor') }}">Create your first document</a>.
        </div>
    {% endif %}
</div>
</div>
    
    <div id="loadingSpinner" class="text-center">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    loadDocuments();
});

function loadDocuments() {
    const container = document.getElementById('documentsContainer');
    const spinner = document.getElementById('loadingSpinner');
    
    spinner.style.display = 'block';
    container.innerHTML = '';
    
    fetch('/api/editor_documents')
    .then(response => response.json())
    .then(data => {
        spinner.style.display = 'none';
        
        if (data.error) {
            container.innerHTML = `
                <div class="alert alert-danger">
                    Error: ${data.error}
                </div>
            `;
            return;
        }
        
        if (data.documents && data.documents.length > 0) {
            const tableHtml = `
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Created</th>
                                <th>Updated</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.documents.map(doc => `
                                <tr>
                                    <td>${escapeHtml(doc.title)}</td>
                                    <td>${formatDateTime(doc.created_at)}</td>
                                    <td>${formatDateTime(doc.updated_at)}</td>
                                    <td>
                                        <a href="/editor?id=${doc.id}" class="btn btn-sm btn-outline-primary">Edit</a>
                                        <button onclick="deleteDocument(${doc.id}, '${escapeHtml(doc.title)}')" 
                                                class="btn btn-sm btn-outline-danger">Delete</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            container.innerHTML = tableHtml;
        } else {
            container.innerHTML = `
                <div class="alert alert-info">
                    No documents found. <a href="/editor">Create your first document</a>.
                </div>
            `;
        }
    })
    .catch(error => {
        spinner.style.display = 'none';
        console.error('Error:', error);
        container.innerHTML = `
            <div class="alert alert-danger">
                Error loading documents. Please try again.
            </div>
        `;
    });
}

function deleteDocument(documentId, title) {
    if (!confirm(`Are you sure you want to delete "${title}"?`)) {
        return;
    }
    
    fetch(`/api/editor_documents/${documentId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Document deleted successfully!');
            loadDocuments(); // Reload the list
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error deleting document');
    });
}

function formatDateTime(dateTimeStr) {
    if (!dateTimeStr) return '';
    try {
        const date = new Date(dateTimeStr);
        return date.toLocaleString('ja-JP', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
    } catch (e) {
        return dateTimeStr;
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{% endblock %}
